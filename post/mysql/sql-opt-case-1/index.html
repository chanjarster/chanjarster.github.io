<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheatsheet</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/troubleshooting/">排障实战记录</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">SQL优化案例(1)</h1>
    
    <time>September 24, 2021</time>
    
    <div>
        <p>
        <p>有一条SQL语句执行比较慢，在并发情况下存在瓶颈：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ID                  <span style="color:#66d9ef">as</span> id,
       account.GENDER_ID           <span style="color:#66d9ef">as</span> genderId,
       userGender.CODE             <span style="color:#66d9ef">as</span> genderCode,
       userGender.NAME             <span style="color:#66d9ef">as</span> genderName,
       account.NATION_ID           <span style="color:#66d9ef">as</span> nationId,
       userNation.CODE             <span style="color:#66d9ef">as</span> nationCode,
       userNation.NAME             <span style="color:#66d9ef">as</span> nationName,
       account.COUNTRY_ID          <span style="color:#66d9ef">as</span> countryId,
       userCountry.CODE            <span style="color:#66d9ef">as</span> countryCode,
       userCountry.NAME            <span style="color:#66d9ef">as</span> countryName,
       account.ADDRESS_ID          <span style="color:#66d9ef">as</span> addressId,
       userAddress.CODE            <span style="color:#66d9ef">as</span> addressCode,
       userAddress.NAME            <span style="color:#66d9ef">as</span> addressName,
       account.USER_ID             <span style="color:#66d9ef">as</span> userId,
       account.USER_NAME           <span style="color:#66d9ef">as</span> userName,
       account.USER_UID            <span style="color:#66d9ef">as</span> userUid,
       account.ACCOUNT_NAME        <span style="color:#66d9ef">as</span> accountName,
       account.IDENTITY_TYPE_ID    <span style="color:#66d9ef">as</span> identityTypeId,
       accountIdentity.CODE        <span style="color:#66d9ef">as</span> identityTypeCode,
       accountIdentity.NAME        <span style="color:#66d9ef">as</span> identityTypeName,
       account.ORGANIZATION_ID     <span style="color:#66d9ef">as</span> organizationId,
       accountOrganization.CODE    <span style="color:#66d9ef">as</span> organizationCode,
       accountOrganization.NAME    <span style="color:#66d9ef">as</span> organizationName,
       account.IS_DATA_CENTER      <span style="color:#66d9ef">as</span> isDataCenter,
       account.ACTIVATION          <span style="color:#66d9ef">as</span> activation,
       account.<span style="color:#66d9ef">STATE</span>               <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">state</span>,
       account.ACCOUNT_EXPIRY_DATE <span style="color:#66d9ef">as</span> accountExpiryDate,
       account.ACCOUNT_LOCKED      <span style="color:#66d9ef">as</span> accountLocked,
       account.PHONE_NUMBER        <span style="color:#66d9ef">as</span> phoneNumber,
       account.EMAIL               <span style="color:#66d9ef">as</span> email,
       <span style="color:#66d9ef">user</span>.IMAGE_URL              <span style="color:#66d9ef">as</span> imageUrl
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
         <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> TB_B_ORGANIZATION accountOrganization
                    <span style="color:#66d9ef">on</span> account.ORGANIZATION_ID <span style="color:#f92672">=</span> accountOrganization.ID <span style="color:#66d9ef">AND</span> accountOrganization.DELETED <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
         <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> TB_B_IDENTITY_TYPE accountIdentity <span style="color:#66d9ef">on</span> account.IDENTITY_TYPE_ID <span style="color:#f92672">=</span> accountIdentity.ID
         <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> TB_B_DICTIONARY userCertificateType <span style="color:#66d9ef">on</span> account.certificate_type_id <span style="color:#f92672">=</span> userCertificateType.ID
         <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> TB_B_DICTIONARY userGender <span style="color:#66d9ef">on</span> account.GENDER_ID <span style="color:#f92672">=</span> userGender.ID
         <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> TB_B_DICTIONARY userNation <span style="color:#66d9ef">on</span> account.NATION_ID <span style="color:#f92672">=</span> userNation.ID
         <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> TB_B_DICTIONARY userCountry <span style="color:#66d9ef">on</span> account.COUNTRY_ID <span style="color:#f92672">=</span> userCountry.ID
         <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> TB_B_DICTIONARY userAddress <span style="color:#66d9ef">on</span> account.ADDRESS_ID <span style="color:#f92672">=</span> userAddress.ID
         <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> TB_B_USER <span style="color:#66d9ef">user</span> <span style="color:#66d9ef">on</span> account.USER_ID <span style="color:#f92672">=</span> <span style="color:#66d9ef">user</span>.ID
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> (
        account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%user%&#39;</span>
        <span style="color:#66d9ef">OR</span> accountIdentity.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%user%&#39;</span>
        <span style="color:#66d9ef">OR</span> accountOrganization.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%user%&#39;</span>
    )
  <span style="color:#66d9ef">and</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%user%&#39;</span>
  <span style="color:#66d9ef">and</span> account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%user%&#39;</span>
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#66d9ef">length</span>(account.ACCOUNT_NAME), account.ACCOUNT_NAME
<span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">20</span>;
</code></pre></div><h2 id="1排除order-by和limit">1）排除ORDER BY和LIMIT</h2>
<h4 id="检查字段索引">检查字段索引</h4>
<p>检查查询条件中的相关字段，把相关字段的索引加上。</p>
<p>EXPLAIN结果：</p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">select_type</th>
<th style="text-align:left">table</th>
<th style="text-align:left">partitions</th>
<th style="text-align:left">type</th>
<th style="text-align:left">possible_keys</th>
<th style="text-align:left">key</th>
<th style="text-align:left">key_len</th>
<th style="text-align:left">ref</th>
<th style="text-align:left">rows</th>
<th style="text-align:left">filtered</th>
<th style="text-align:left">Extra</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">SIMPLE</td>
<td style="text-align:left">accountOrganization</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">ALL</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">84</td>
<td style="text-align:left">10</td>
<td style="text-align:left">Using where</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">SIMPLE</td>
<td style="text-align:left">account</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">ref</td>
<td style="text-align:left">ORGANIZATION_ID,IDENTITY_TYPE_ID,TB_B_ACCOUNT_fk3</td>
<td style="text-align:left">ORGANIZATION_ID</td>
<td style="text-align:left">194</td>
<td style="text-align:left">user_new.accountOrganization.ID</td>
<td style="text-align:left">3637</td>
<td style="text-align:left">1.23</td>
<td style="text-align:left">Using where</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">SIMPLE</td>
<td style="text-align:left">accountIdentity</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">eq_ref</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">194</td>
<td style="text-align:left">user_new.account.IDENTITY_TYPE_ID</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">Using where</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">SIMPLE</td>
<td style="text-align:left">userCertificateType</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">eq_ref</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">194</td>
<td style="text-align:left">user_new.account.CERTIFICATE_TYPE_ID</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">Using index</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">SIMPLE</td>
<td style="text-align:left">userGender</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">eq_ref</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">194</td>
<td style="text-align:left">user_new.account.GENDER_ID</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">NULL</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">SIMPLE</td>
<td style="text-align:left">userNation</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">eq_ref</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">194</td>
<td style="text-align:left">user_new.account.NATION_ID</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">NULL</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">SIMPLE</td>
<td style="text-align:left">userCountry</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">eq_ref</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">194</td>
<td style="text-align:left">user_new.account.COUNTRY_ID</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">NULL</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">SIMPLE</td>
<td style="text-align:left">userAddress</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">eq_ref</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">194</td>
<td style="text-align:left">user_new.account.ADDRESS_ID</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">NULL</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">SIMPLE</td>
<td style="text-align:left">user</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">eq_ref</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">194</td>
<td style="text-align:left">user_new.account.USER_ID</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">NULL</td>
</tr>
</tbody>
</table>
<h3 id="去掉join">去掉JOIN</h3>
<p>根据业务逻辑，把查询分成两部分，第一步先查ACCOUNT_NAME，第二步查其他字段，第一步SQL：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> (
        account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.IDENTITY_TYPE_ID <span style="color:#66d9ef">in</span> (<span style="color:#66d9ef">select</span> accountIdentity.ID <span style="color:#66d9ef">from</span> TB_B_IDENTITY_TYPE accountIdentity <span style="color:#66d9ef">where</span> accountIdentity.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%user%&#39;</span>)
        <span style="color:#66d9ef">OR</span> account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>  (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> accountOrganization.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%user%&#39;</span>)
    )
  <span style="color:#66d9ef">and</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%user%&#39;</span>
  <span style="color:#66d9ef">and</span> account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;%user%&#39;</span>
  <span style="color:#66d9ef">and</span> account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>
      (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> DELETED <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>);
</code></pre></div><p>EXPLAIN如下：</p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">select_type</th>
<th style="text-align:left">table</th>
<th style="text-align:left">partitions</th>
<th style="text-align:left">type</th>
<th style="text-align:left">possible_keys</th>
<th style="text-align:left">key</th>
<th style="text-align:left">key_len</th>
<th style="text-align:left">ref</th>
<th style="text-align:left">rows</th>
<th style="text-align:left">filtered</th>
<th style="text-align:left">Extra</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">accountOrganization</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">ALL</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">84</td>
<td style="text-align:left">10</td>
<td style="text-align:left">Using where</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">account</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">ref</td>
<td style="text-align:left">ORGANIZATION_ID</td>
<td style="text-align:left">ORGANIZATION_ID</td>
<td style="text-align:left">194</td>
<td style="text-align:left">user_new.accountOrganization.ID</td>
<td style="text-align:left">3637</td>
<td style="text-align:left">1.23</td>
<td style="text-align:left">Using where</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">SUBQUERY</td>
<td style="text-align:left">accountOrganization</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">index</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">IDX_ORG_NAME</td>
<td style="text-align:left">602</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">84</td>
<td style="text-align:left">11.11</td>
<td style="text-align:left">Using where; Using index</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">SUBQUERY</td>
<td style="text-align:left">accountIdentity</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">index</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">IDX_ID_TYPE_NAME</td>
<td style="text-align:left">602</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">49</td>
<td style="text-align:left">11.11</td>
<td style="text-align:left">Using where; Using index</td>
</tr>
</tbody>
</table>
<h3 id="优化like">优化LIKE</h3>
<p>看到LIKE用的是中间匹配<code>%...%</code>，这种是无法利用索引的，遂改成前缀匹配，所以做出以下优化：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> (
        account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.IDENTITY_TYPE_ID <span style="color:#66d9ef">in</span> (<span style="color:#66d9ef">select</span> accountIdentity.ID <span style="color:#66d9ef">from</span> TB_B_IDENTITY_TYPE accountIdentity <span style="color:#66d9ef">where</span> accountIdentity.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>)
        <span style="color:#66d9ef">OR</span> account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>  (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> accountOrganization.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>)
    )
  <span style="color:#66d9ef">and</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
  <span style="color:#66d9ef">and</span> account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
  <span style="color:#66d9ef">and</span> account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>
      (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> DELETED <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>);
</code></pre></div><p>EXPLAIN结果：</p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">select_type</th>
<th style="text-align:left">table</th>
<th style="text-align:left">partitions</th>
<th style="text-align:left">type</th>
<th style="text-align:left">possible_keys</th>
<th style="text-align:left">key</th>
<th style="text-align:left">key_len</th>
<th style="text-align:left">ref</th>
<th style="text-align:left">rows</th>
<th style="text-align:left">filtered</th>
<th style="text-align:left">Extra</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">accountOrganization</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">ALL</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">84</td>
<td style="text-align:left">10</td>
<td style="text-align:left">Using where</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">account</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">ref</td>
<td style="text-align:left">UQ_ACCOUNT_NAME,ORGANIZATION_ID,UQ_ACCOUNT_USRNAME,IDX_ACCOUNT_USERNAME</td>
<td style="text-align:left">ORGANIZATION_ID</td>
<td style="text-align:left">194</td>
<td style="text-align:left">user_new.accountOrganization.ID</td>
<td style="text-align:left">3637</td>
<td style="text-align:left">25</td>
<td style="text-align:left">Using where</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">SUBQUERY</td>
<td style="text-align:left">accountOrganization</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">range</td>
<td style="text-align:left">PRIMARY,IDX_ORG_NAME</td>
<td style="text-align:left">IDX_ORG_NAME</td>
<td style="text-align:left">602</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">Using where; Using index</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">SUBQUERY</td>
<td style="text-align:left">accountIdentity</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">range</td>
<td style="text-align:left">PRIMARY,IDX_ID_TYPE_NAME</td>
<td style="text-align:left">IDX_ID_TYPE_NAME</td>
<td style="text-align:left">602</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">Using where; Using index</td>
</tr>
</tbody>
</table>
<h2 id="2考虑order-by优化">2）考虑ORDER BY优化</h2>
<p>加上原先的ORDER BY之后，SQL如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> (
        account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.IDENTITY_TYPE_ID <span style="color:#66d9ef">in</span> (<span style="color:#66d9ef">select</span> accountIdentity.ID <span style="color:#66d9ef">from</span> TB_B_IDENTITY_TYPE accountIdentity <span style="color:#66d9ef">where</span> accountIdentity.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>)
        <span style="color:#66d9ef">OR</span> account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>  (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> accountOrganization.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>)
    )
  <span style="color:#66d9ef">and</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
  <span style="color:#66d9ef">and</span> account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
  <span style="color:#66d9ef">and</span> account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>
      (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> DELETED <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>)
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#66d9ef">length</span>(account.ACCOUNT_NAME), account.ACCOUNT_NAME;
</code></pre></div><p>EXPLAIN结果：</p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">select_type</th>
<th style="text-align:left">table</th>
<th style="text-align:left">partitions</th>
<th style="text-align:left">type</th>
<th style="text-align:left">possible_keys</th>
<th style="text-align:left">key</th>
<th style="text-align:left">key_len</th>
<th style="text-align:left">ref</th>
<th style="text-align:left">rows</th>
<th style="text-align:left">filtered</th>
<th style="text-align:left">Extra</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">accountOrganization</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">ALL</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">84</td>
<td style="text-align:left">10</td>
<td style="text-align:left">Using where; Using temporary; Using filesort</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">account</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">ref</td>
<td style="text-align:left">UQ_ACCOUNT_NAME,ORGANIZATION_ID,UQ_ACCOUNT_USRNAME,IDX_ACCOUNT_USERNAME</td>
<td style="text-align:left">ORGANIZATION_ID</td>
<td style="text-align:left">194</td>
<td style="text-align:left">user_new.accountOrganization.ID</td>
<td style="text-align:left">3637</td>
<td style="text-align:left">25</td>
<td style="text-align:left">Using where</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">SUBQUERY</td>
<td style="text-align:left">accountOrganization</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">range</td>
<td style="text-align:left">PRIMARY,IDX_ORG_NAME</td>
<td style="text-align:left">IDX_ORG_NAME</td>
<td style="text-align:left">602</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">Using where; Using index</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">SUBQUERY</td>
<td style="text-align:left">accountIdentity</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">range</td>
<td style="text-align:left">PRIMARY,IDX_ID_TYPE_NAME</td>
<td style="text-align:left">IDX_ID_TYPE_NAME</td>
<td style="text-align:left">602</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">Using where; Using index</td>
</tr>
</tbody>
</table>
<p>第一行可以看到 <code>Using temporary; Using filesort</code>。</p>
<ul>
<li>Using temporary意思是为了排序，使用了临时表hold住结果。</li>
<li>Using filesort意思是无法使用索引直接得到排好序的数据，需要利用内存或者磁盘文件排序。</li>
</ul>
<p>对于这个SQL有三种做法的：</p>
<ol>
<li>当前方案，<code>accountOrganization</code>做驱动表（500行），<code>account</code>是被驱动表（14w行），对结果做普通排序。</li>
<li>优化方案一，<code>accountOrganization</code>做驱动表（500行），<code>account</code>是被驱动表（14w行），配合LIMIT，利用堆取结果的前20个（LIMIT 20），见<a href="http://mysql.taobao.org/monthly/2014/11/10/">filesort with small LIMIT optimization</a>，前提是数据能够在<code>sort_buffer_size</code>里放得下。</li>
<li>优化方案二，<code>account</code>是驱动表（14w行），<code>accountOrganization</code>是被驱动表（500行），在<code>account</code>表新建字段<code>ACCOUNT_NAME_LEN</code>，并建立索引<code>ACCOUNT_NAME_LEN,ACCOUNT_NAME</code>，驱动表查询走<code>ACCOUNT_LEN_NAME</code>索引从而达避免排序。</li>
</ol>
<p>这三个方法的算法复杂度可以预估的：</p>
<ul>
<li>方法一：500 + 500 * 2 * log2(14w) + 14w * log2(14w) = 2,523,590</li>
<li>方法二：500 + 500 * 2 * log2(14w) + 14w * log2(20) = 622,390</li>
<li>方法三：14w + 14w * log2(500) = 1,394,400</li>
</ul>
<p>方法一的公式解释：</p>
<ul>
<li>500，<code>accountOrganization</code>表行数。</li>
<li>500 * 2 * log2(14w) ，拿着前一步的每一行，利用索引<code>ORGANIZATION_ID</code>到<code>account</code>表查一次数据的复杂度，一共查了500次，乘以2是因为多了一次回表到主键索引中找<code>ACCOUNT_NAME</code>字段。</li>
<li>14w * log2(14w)，排序复杂度 nlog(n)，这里还涉及到磁盘IO。</li>
</ul>
<p>方法二的公式解释：</p>
<ul>
<li>和前面一样。</li>
<li>14w * log2(20)，一个大小为20的堆（LIMIT 20），插入数据的复杂度是 log2(20)，14w条件数据全部都过一把。</li>
</ul>
<p>方法三的公式解释：</p>
<ul>
<li>14w，14w行<code>account</code>数据。</li>
<li>14w * log2(500)，拿着前一步的每一行，利用<code>accountOrganization</code>表的<code>PRIMARY</code>索引查找一次数据的复杂度，一样查了14w次。</li>
</ul>
<p>可以看到，方案二是最佳方案。</p>
<h3 id="分析当前方法">分析当前方法</h3>
<p>filesort是可以在内存中发生了，我们需要跟踪优化器来查看SQL执行情况：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-SQL" data-lang="SQL"><span style="color:#66d9ef">SET</span> optimizer_trace<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;enabled=on&#34;</span>;
<span style="color:#66d9ef">SET</span> OPTIMIZER_TRACE_MAX_MEM_SIZE<span style="color:#f92672">=</span><span style="color:#ae81ff">10485760</span>; 
<span style="color:#66d9ef">SELECT</span> ...; <span style="color:#f92672">#</span> your query here
<span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> INFORMATION_SCHEMA.OPTIMIZER_TRACE;
<span style="color:#f92672">#</span> possibly <span style="color:#66d9ef">more</span> queries...
<span style="color:#f92672">#</span> <span style="color:#66d9ef">When</span> done <span style="color:#66d9ef">with</span> tracing, disable it:
<span style="color:#66d9ef">SET</span> optimizer_trace<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;enabled=off&#34;</span>;
</code></pre></div><p>得到结果：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#e6db74">&#34;filesort_priority_queue_optimization&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
  <span style="color:#f92672">&#34;limit&#34;</span>: <span style="color:#ae81ff">1000</span>,
  <span style="color:#f92672">&#34;chosen&#34;</span>: <span style="color:#66d9ef">false</span>,
  <span style="color:#f92672">&#34;cause&#34;</span>: <span style="color:#e6db74">&#34;sort_is_cheaper&#34;</span>
}<span style="color:#960050;background-color:#1e0010">,</span>
<span style="color:#e6db74">&#34;filesort_summary&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
  <span style="color:#f92672">&#34;memory_available&#34;</span>: <span style="color:#ae81ff">262144</span>,
  <span style="color:#f92672">&#34;key_size&#34;</span>: <span style="color:#ae81ff">248</span>,
  <span style="color:#f92672">&#34;row_size&#34;</span>: <span style="color:#ae81ff">622</span>,
  <span style="color:#f92672">&#34;max_rows_per_buffer&#34;</span>: <span style="color:#ae81ff">421</span>,
  <span style="color:#f92672">&#34;num_rows_estimate&#34;</span>: <span style="color:#ae81ff">15</span>,
  <span style="color:#f92672">&#34;num_rows_found&#34;</span>: <span style="color:#ae81ff">131072</span>,
  <span style="color:#f92672">&#34;num_initial_chunks_spilled_to_disk&#34;</span>: <span style="color:#ae81ff">141</span>,
  <span style="color:#f92672">&#34;peak_memory_used&#34;</span>: <span style="color:#ae81ff">262144</span>,
  <span style="color:#f92672">&#34;sort_algorithm&#34;</span>: <span style="color:#e6db74">&#34;std::stable_sort&#34;</span>,
  <span style="color:#f92672">&#34;sort_mode&#34;</span>: <span style="color:#e6db74">&#34;&lt;fixed_sort_key, packed_additional_fields&gt;&#34;</span>
}
</code></pre></div><p>可以看到<code>num_initial_chunks_spilled_to_disk:141</code>，写了141个临时文件。</p>
<h3 id="分析方案二">分析方案二</h3>
<p>优化的重点在于避免filesort时写磁盘，让其在内存中完成。</p>
<p>MySQL相关的系统参数有：</p>
<ul>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_sort_buffer_size">sort_buffer_size</a>，规定了用于排序的缓存大小（字节），默认262144=256K。如果排序的数据在此buffer中能hold住，那么就会避免写磁盘。</li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_max_sort_length"><code>max_sort_length</code></a>，规定了排序时，每行最多取前多少个字节，如果行的尺寸超出该值，MySQL也就只会使用前多少个字节进行比较，该参数默认1024=1K。</li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/server-status-variables.html#statvar_Sort_merge_passes">Sort_merge_passes</a>，是一个状态变量，表示了排序合并的次数。</li>
</ul>
<p>我们先设置<code>sort_buffer_size</code>到1M（默认256K）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">set</span> sort_buffer_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1048576</span>;         <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">只针对当前</span>session有效
<span style="color:#66d9ef">set</span> persist sort_buffer_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1048576</span>; <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">全局有效</span>
</code></pre></div><p>执行SQL，注意添加了LIMIT：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> (
        account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.IDENTITY_TYPE_ID <span style="color:#66d9ef">in</span> (<span style="color:#66d9ef">select</span> accountIdentity.ID <span style="color:#66d9ef">from</span> TB_B_IDENTITY_TYPE accountIdentity <span style="color:#66d9ef">where</span> accountIdentity.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>)
        <span style="color:#66d9ef">OR</span> account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>  (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> accountOrganization.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>)
    )
  <span style="color:#66d9ef">and</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
  <span style="color:#66d9ef">and</span> account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
  <span style="color:#66d9ef">and</span> account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>
      (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> DELETED <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>)
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#66d9ef">length</span>(account.ACCOUNT_NAME), account.ACCOUNT_NAME
<span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">20</span>;
</code></pre></div><p>然后跟踪优化器：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#e6db74">&#34;filesort_priority_queue_optimization&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
  <span style="color:#f92672">&#34;limit&#34;</span>: <span style="color:#ae81ff">1000</span>,
  <span style="color:#f92672">&#34;chosen&#34;</span>: <span style="color:#66d9ef">true</span>
}<span style="color:#960050;background-color:#1e0010">,</span>
<span style="color:#e6db74">&#34;filesort_summary&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
  <span style="color:#f92672">&#34;memory_available&#34;</span>: <span style="color:#ae81ff">1048576</span>,
  <span style="color:#f92672">&#34;key_size&#34;</span>: <span style="color:#ae81ff">248</span>,
  <span style="color:#f92672">&#34;row_size&#34;</span>: <span style="color:#ae81ff">618</span>,
  <span style="color:#f92672">&#34;max_rows_per_buffer&#34;</span>: <span style="color:#ae81ff">1001</span>,
  <span style="color:#f92672">&#34;num_rows_estimate&#34;</span>: <span style="color:#ae81ff">7623</span>,
  <span style="color:#f92672">&#34;num_rows_found&#34;</span>: <span style="color:#ae81ff">131072</span>,
  <span style="color:#f92672">&#34;num_initial_chunks_spilled_to_disk&#34;</span>: <span style="color:#ae81ff">0</span>,
  <span style="color:#f92672">&#34;peak_memory_used&#34;</span>: <span style="color:#ae81ff">626626</span>,
  <span style="color:#f92672">&#34;sort_algorithm&#34;</span>: <span style="color:#e6db74">&#34;std::stable_sort&#34;</span>,
  <span style="color:#f92672">&#34;unpacked_addon_fields&#34;</span>: <span style="color:#e6db74">&#34;using_priority_queue&#34;</span>,
  <span style="color:#f92672">&#34;sort_mode&#34;</span>: <span style="color:#e6db74">&#34;&lt;fixed_sort_key, additional_fields&gt;&#34;</span>
}
</code></pre></div><p>可以看到<code>filesort_priority_queue_optimization</code>启用了，同时<code>num_initial_chunks_spilled_to_disk</code>变成了0。</p>
<p><code>filesort_priority_queue_optimization</code>启用意味着MySQL采用了优先级队列（堆）来从结果集中取最小的N个元素。</p>
<h2 id="考虑limit">考虑limit</h2>
<p>在业务场景下，大部分分页每页20条，极少超过10页，因此这里不考虑深分页问题，所以加上<code>LIMIT 200, 220</code>看看：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> (
        account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.IDENTITY_TYPE_ID <span style="color:#66d9ef">in</span> (<span style="color:#66d9ef">select</span> accountIdentity.ID <span style="color:#66d9ef">from</span> TB_B_IDENTITY_TYPE accountIdentity <span style="color:#66d9ef">where</span> accountIdentity.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>)
        <span style="color:#66d9ef">OR</span> account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>  (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> accountOrganization.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>)
    )
  <span style="color:#66d9ef">and</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
  <span style="color:#66d9ef">and</span> account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
  <span style="color:#66d9ef">and</span> account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>
      (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> DELETED <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>)
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#66d9ef">length</span>(account.ACCOUNT_NAME), account.ACCOUNT_NAME
<span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">220</span>;
</code></pre></div><p>跟踪优化器结果：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#e6db74">&#34;filesort_priority_queue_optimization&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
  <span style="color:#f92672">&#34;limit&#34;</span>: <span style="color:#ae81ff">420</span>,
  <span style="color:#f92672">&#34;chosen&#34;</span>: <span style="color:#66d9ef">true</span>
}<span style="color:#960050;background-color:#1e0010">,</span>
<span style="color:#e6db74">&#34;filesort_summary&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
  <span style="color:#f92672">&#34;memory_available&#34;</span>: <span style="color:#ae81ff">1048576</span>,
  <span style="color:#f92672">&#34;key_size&#34;</span>: <span style="color:#ae81ff">248</span>,
  <span style="color:#f92672">&#34;row_size&#34;</span>: <span style="color:#ae81ff">618</span>,
  <span style="color:#f92672">&#34;max_rows_per_buffer&#34;</span>: <span style="color:#ae81ff">421</span>,
  <span style="color:#f92672">&#34;num_rows_estimate&#34;</span>: <span style="color:#ae81ff">7623</span>,
  <span style="color:#f92672">&#34;num_rows_found&#34;</span>: <span style="color:#ae81ff">131072</span>,
  <span style="color:#f92672">&#34;num_initial_chunks_spilled_to_disk&#34;</span>: <span style="color:#ae81ff">0</span>,
  <span style="color:#f92672">&#34;peak_memory_used&#34;</span>: <span style="color:#ae81ff">263546</span>,
  <span style="color:#f92672">&#34;sort_algorithm&#34;</span>: <span style="color:#e6db74">&#34;std::stable_sort&#34;</span>,
  <span style="color:#f92672">&#34;unpacked_addon_fields&#34;</span>: <span style="color:#e6db74">&#34;using_priority_queue&#34;</span>,
  <span style="color:#f92672">&#34;sort_mode&#34;</span>: <span style="color:#e6db74">&#34;&lt;fixed_sort_key, additional_fields&gt;&#34;</span>
}
</code></pre></div><p>可以看到<code>filesort_priority_queue_optimization</code>依然启用，而且<code>num_initial_chunks_spilled_to_disk</code>依然是0。</p>
<h2 id="结论">结论</h2>
<p>做了以下优化：</p>
<ul>
<li><code>WHERE</code>用到的字段都加上索引。</li>
<li><code>LIKE</code>改写成前缀匹配，这样可以利用索引。</li>
<li>避免<code>JOIN</code>，分两次查询，第一次先查<code>ACCOUNT_NAME</code>，第二次根据<code>ACCOUNT_NAME</code>查询想要的数据。</li>
<li>增加<code>sort_buffer_size</code>，避免<code>filesort</code>排序时写磁盘，并且利用堆+LIMIT来优化排序。</li>
</ul>
<p>参考资料：</p>
<ul>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/explain-output.html">MySQL EXPLAIN解读</a></li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/limit-optimization.html">MySQL LIMIT 优化</a></li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/order-by-optimization.html">MySQL ORDER BY 优化</a></li>
<li><a href="http://mysql.taobao.org/monthly/2014/11/10/">MySQL filesort with small LIMIT optimization</a></li>
<li><a href="https://dev.mysql.com/doc/internals/en/optimizer-tracing.html">MySQL 优化器跟踪</a></li>
</ul>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/mysql">#mysql</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98">#性能调优</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>