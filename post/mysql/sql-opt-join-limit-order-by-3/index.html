<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheatsheet</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/troubleshooting/">排障实战记录</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">SQL优化:一个含有JOIN&#43;LIMIT&#43;ORDER BY的SQL(下)</h1>
    
    <time>September 28, 2021</time>
    
    <div>
        <p>
        <p>在<a href="../sql-opt-join-limit-order-by-2">上一篇文章</a> 里我们对一条SQL语句做了新的优化，在项目上做了性能测试对比新优化的效果。</p>
<h2 id="压测">压测</h2>
<p>压测试方案：</p>
<ul>
<li>测试三个版本：未优化版本，优化版本v1，优化版本v2</li>
<li>测试三种情况：无where clause，where clause 1，where clause 2</li>
</ul>
<p>未优化SQL：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ID                  <span style="color:#66d9ef">as</span> id,
       account.GENDER_ID           <span style="color:#66d9ef">as</span> genderId,
       userGender.CODE             <span style="color:#66d9ef">as</span> genderCode,
       userGender.NAME             <span style="color:#66d9ef">as</span> genderName,
       account.NATION_ID           <span style="color:#66d9ef">as</span> nationId,
       userNation.CODE             <span style="color:#66d9ef">as</span> nationCode,
       userNation.NAME             <span style="color:#66d9ef">as</span> nationName,
       account.COUNTRY_ID          <span style="color:#66d9ef">as</span> countryId,
       userCountry.CODE            <span style="color:#66d9ef">as</span> countryCode,
       userCountry.NAME            <span style="color:#66d9ef">as</span> countryName,
       account.ADDRESS_ID          <span style="color:#66d9ef">as</span> addressId,
       userAddress.CODE            <span style="color:#66d9ef">as</span> addressCode,
       userAddress.NAME            <span style="color:#66d9ef">as</span> addressName,
       account.USER_ID             <span style="color:#66d9ef">as</span> userId,
       account.USER_NAME           <span style="color:#66d9ef">as</span> userName,
       account.USER_UID            <span style="color:#66d9ef">as</span> userUid,
       account.ACCOUNT_NAME        <span style="color:#66d9ef">as</span> accountName,
       account.IDENTITY_TYPE_ID    <span style="color:#66d9ef">as</span> identityTypeId,
       accountIdentity.CODE        <span style="color:#66d9ef">as</span> identityTypeCode,
       accountIdentity.NAME        <span style="color:#66d9ef">as</span> identityTypeName,
       account.ORGANIZATION_ID     <span style="color:#66d9ef">as</span> organizationId,
       accountOrganization.CODE    <span style="color:#66d9ef">as</span> organizationCode,
       accountOrganization.NAME    <span style="color:#66d9ef">as</span> organizationName,
       account.IS_DATA_CENTER      <span style="color:#66d9ef">as</span> isDataCenter,
       account.ACTIVATION          <span style="color:#66d9ef">as</span> activation,
       account.<span style="color:#66d9ef">STATE</span>               <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">state</span>,
       account.ACCOUNT_EXPIRY_DATE <span style="color:#66d9ef">as</span> accountExpiryDate,
       account.ACCOUNT_LOCKED      <span style="color:#66d9ef">as</span> accountLocked,
       account.PHONE_NUMBER        <span style="color:#66d9ef">as</span> phoneNumber,
       account.EMAIL               <span style="color:#66d9ef">as</span> email,
       <span style="color:#66d9ef">user</span>.IMAGE_URL              <span style="color:#66d9ef">as</span> imageUrl
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
         <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> TB_B_ORGANIZATION accountOrganization
                    <span style="color:#66d9ef">on</span> account.ORGANIZATION_ID <span style="color:#f92672">=</span> accountOrganization.ID <span style="color:#66d9ef">AND</span> accountOrganization.DELETED <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
         <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> TB_B_IDENTITY_TYPE accountIdentity <span style="color:#66d9ef">on</span> account.IDENTITY_TYPE_ID <span style="color:#f92672">=</span> accountIdentity.ID
         <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> TB_B_DICTIONARY userCertificateType <span style="color:#66d9ef">on</span> account.certificate_type_id <span style="color:#f92672">=</span> userCertificateType.ID
         <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> TB_B_DICTIONARY userGender <span style="color:#66d9ef">on</span> account.GENDER_ID <span style="color:#f92672">=</span> userGender.ID
         <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> TB_B_DICTIONARY userNation <span style="color:#66d9ef">on</span> account.NATION_ID <span style="color:#f92672">=</span> userNation.ID
         <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> TB_B_DICTIONARY userCountry <span style="color:#66d9ef">on</span> account.COUNTRY_ID <span style="color:#f92672">=</span> userCountry.ID
         <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> TB_B_DICTIONARY userAddress <span style="color:#66d9ef">on</span> account.ADDRESS_ID <span style="color:#f92672">=</span> userAddress.ID
         <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> TB_B_USER <span style="color:#66d9ef">user</span> <span style="color:#66d9ef">on</span> account.USER_ID <span style="color:#f92672">=</span> <span style="color:#66d9ef">user</span>.ID
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> <span style="color:#f92672">&lt;</span>condition<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#66d9ef">length</span>(account.ACCOUNT_NAME), account.ACCOUNT_NAME
<span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">20</span>;
</code></pre></div><p>优化版本v1 SQL，先查出ACCOUNT_NAME，然后再查出详细信息，可能会根据条件选择合适索引：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> <span style="color:#f92672">&lt;</span>condition<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#66d9ef">length</span>(account.ACCOUNT_NAME), account.ACCOUNT_NAME
<span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">20</span>;
</code></pre></div><p>优化版本v2 SQL，先查出ACCOUNT_NAME，然后再查出详细信息，会使用<code>ACCOUNT_NAME_PAD</code>索引：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> <span style="color:#f92672">&lt;</span>condition<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> account.ACCOUNT_NAME_PAD
<span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">20</span>;
</code></pre></div><p>压测命令：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wrk2 -c <span style="color:#ae81ff">100</span> -d <span style="color:#ae81ff">60</span> -R <span style="color:#ae81ff">2000</span> -B &lt;url&gt;
</code></pre></div><h3 id="无where-clause">无where clause</h3>
<table>
<thead>
<tr>
<th>未优化</th>
<th>v1</th>
<th>v2</th>
</tr>
</thead>
<tbody>
<tr>
<td>0.83 QPS</td>
<td>145.18 QPS</td>
<td>1547.37 QPS</td>
</tr>
</tbody>
</table>
<p>这个结果符合预期，v2版本的因为扫描时直接走了索引省去了排序动作，同时又没有JOIN，所以吞吐量特别高。</p>
<p>这个可以从两者的执行计划看出来，v1执行计划：</p>
<table>
<thead>
<tr>
<th style="text-align:center">id</th>
<th style="text-align:center">select_type</th>
<th style="text-align:center">table</th>
<th style="text-align:center">partitions</th>
<th style="text-align:center">type</th>
<th style="text-align:center">possible_keys</th>
<th style="text-align:center">key</th>
<th style="text-align:center">key_len</th>
<th style="text-align:center">ref</th>
<th style="text-align:center">rows</th>
<th style="text-align:center">filtered</th>
<th style="text-align:center">Extra</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">SIMPLE</td>
<td style="text-align:center">account</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">index</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">UQ_ACCOUNT_NAME</td>
<td style="text-align:center">362</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">163505</td>
<td style="text-align:center">100.00</td>
<td style="text-align:center">Using index; Using filesort</td>
</tr>
</tbody>
</table>
<p>v2执行计划：</p>
<table>
<thead>
<tr>
<th style="text-align:center">id</th>
<th style="text-align:center">select_type</th>
<th style="text-align:center">table</th>
<th style="text-align:center">partitions</th>
<th style="text-align:center">type</th>
<th style="text-align:center">possible_keys</th>
<th style="text-align:center">key</th>
<th style="text-align:center">key_len</th>
<th style="text-align:center">ref</th>
<th style="text-align:center">rows</th>
<th style="text-align:center">filtered</th>
<th style="text-align:center">Extra</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">SIMPLE</td>
<td style="text-align:center">account</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">index</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">ACCOUNT_NAME_PAD</td>
<td style="text-align:center">767</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">20</td>
<td style="text-align:center">100.00</td>
<td style="text-align:center"><em>NULL</em></td>
</tr>
</tbody>
</table>
<h3 id="where-clause-1压测结果">where clause 1压测结果</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">(
   account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#f92672">?</span>
   <span style="color:#66d9ef">OR</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#f92672">?</span>
   <span style="color:#66d9ef">OR</span> account.IDENTITY_TYPE_ID <span style="color:#66d9ef">in</span> (<span style="color:#66d9ef">select</span> accountIdentity.ID <span style="color:#66d9ef">from</span> TB_B_IDENTITY_TYPE accountIdentity <span style="color:#66d9ef">where</span> accountIdentity.NAME <span style="color:#66d9ef">like</span> <span style="color:#f92672">?</span>)
   <span style="color:#66d9ef">OR</span> account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>  (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> accountOrganization.NAME <span style="color:#66d9ef">like</span> <span style="color:#f92672">?</span>)
)
</code></pre></div><p>压测结果：</p>
<table>
<thead>
<tr>
<th>查询参数/吞吐量</th>
<th>未优化</th>
<th>v1</th>
<th>v2</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>LIKE 20%</code> ，预估140,000行</td>
<td>0.83 QPS</td>
<td>60.59 QPS</td>
<td>64.76 QPS</td>
</tr>
<tr>
<td><code>LIKE 202%</code> ，预估26,000行</td>
<td>2.39 QPS</td>
<td>58.36 QPS</td>
<td>7.11 QPS</td>
</tr>
<tr>
<td><code>LIKE 2021%</code> ，预估12,000 行</td>
<td>3.18 QPS</td>
<td>55.59 QPS</td>
<td>6.37 QPS</td>
</tr>
<tr>
<td><code>LIKE 20211%</code>，预估1,200行</td>
<td>2.31 QPS</td>
<td>57.38 QPS</td>
<td>8.03 QPS</td>
</tr>
</tbody>
</table>
<h4 id="为何v2性能的急剧下降">为何v2性能的急剧下降？</h4>
<p>看到了异常现象，v2版本在 <code>LIKE 20%</code>时吞吐量64.76 QPS，<code>LIKE 202%</code>时吞吐量在7.11 QPS，下降了很多，两者的执行计划都是一样的，都是走了<code>ACCOUNT_NAME_PAD</code>索引：</p>
<table>
<thead>
<tr>
<th style="text-align:center">id</th>
<th style="text-align:center">select_type</th>
<th style="text-align:center">table</th>
<th style="text-align:center">partitions</th>
<th style="text-align:center">type</th>
<th style="text-align:center">possible_keys</th>
<th style="text-align:center">key</th>
<th style="text-align:center">key_len</th>
<th style="text-align:center">ref</th>
<th style="text-align:center">rows</th>
<th style="text-align:center">filtered</th>
<th style="text-align:center">Extra</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">PRIMARY</td>
<td style="text-align:center">account</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">index</td>
<td style="text-align:center">UQ_ACCOUNT_NAME,<br/>IDX_ACCOUNT_USERNAME</td>
<td style="text-align:center">ACCOUNT_NAME_PAD</td>
<td style="text-align:center">767</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">20</td>
<td style="text-align:center">100.00</td>
<td style="text-align:center">Using where</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">SUBQUERY</td>
<td style="text-align:center">accountOrganization</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">range</td>
<td style="text-align:center">PRIMARY,IDX_ORG_NAME</td>
<td style="text-align:center">IDX_ORG_NAME</td>
<td style="text-align:center">602</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">1</td>
<td style="text-align:center">100.00</td>
<td style="text-align:center">Using where;<br/> Using index</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">SUBQUERY</td>
<td style="text-align:center">accountIdentity</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">range</td>
<td style="text-align:center">PRIMARY,IDX_ID_TYPE_NAME</td>
<td style="text-align:center">IDX_ID_TYPE_NAME</td>
<td style="text-align:center">602</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">1</td>
<td style="text-align:center">100.00</td>
<td style="text-align:center">Using where;<br/> Using index</td>
</tr>
</tbody>
</table>
<p>虽然扫描<code>ACCOUNT_NAME_PAD</code>索引避免了排序，但是对于where clause来说，还是一行行过滤的，<code>LIKE 20%</code>的扫描行数少，因为目标数据比较靠前，<code>LIKE 202%</code>的扫描行数多，因为目标数据比较靠后。</p>
<p>通过<code>EXPLAIN ANALYZE</code>来分析<code>LIKE 20%</code>时的SQL执行情况，可以看到实际扫描26,566行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">-&gt;</span> Limit<span style="color:#f92672">:</span> 20 <span style="color:#a6e22e">row</span><span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>2<span style="color:#f92672">.</span><span style="color:#a6e22e">201</span><span style="color:#f92672">..</span><span style="color:#a6e22e">479</span><span style="color:#f92672">.</span><span style="color:#a6e22e">425</span> rows<span style="color:#f92672">=</span>20 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
    <span style="color:#f92672">-&gt;</span> Filter<span style="color:#f92672">:</span> <span style="color:#f92672">((</span><span style="color:#960050;background-color:#1e0010">`</span>account<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ACCOUNT_NAME</span> like <span style="color:#960050;background-color:#1e0010">&#39;</span>20<span style="color:#f92672">%</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">)</span> or <span style="color:#f92672">...)</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">33</span> rows<span style="color:#f92672">=</span>20<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>2<span style="color:#f92672">.</span><span style="color:#a6e22e">199</span><span style="color:#f92672">..</span><span style="color:#a6e22e">479</span><span style="color:#f92672">.</span><span style="color:#a6e22e">417</span> rows<span style="color:#f92672">=</span>20 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
        <span style="color:#f92672">-&gt;</span> Index scan on account using <span style="color:#a6e22e">ACCOUNT_NAME_PAD</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">33</span> rows<span style="color:#f92672">=</span>20<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">368</span><span style="color:#f92672">..</span><span style="color:#a6e22e">462</span><span style="color:#f92672">.</span><span style="color:#a6e22e">221</span> rows<span style="color:#f92672">=</span>26566 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
        <span style="color:#f92672">-&gt;</span> Select <span style="color:#960050;background-color:#1e0010">#</span>2 <span style="color:#f92672">(</span>subquery in condition<span style="color:#f92672">;</span> run only once<span style="color:#f92672">)</span>
            <span style="color:#f92672">-&gt;</span> Filter<span style="color:#f92672">:</span> <span style="color:#f92672">(</span>accountIdentity<span style="color:#f92672">.</span><span style="color:#960050;background-color:#1e0010">`</span>NAME<span style="color:#960050;background-color:#1e0010">`</span> like <span style="color:#960050;background-color:#1e0010">&#39;</span>20<span style="color:#f92672">%</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">21</span> rows<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">026</span><span style="color:#f92672">..</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">026</span> rows<span style="color:#f92672">=</span>0 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
                <span style="color:#f92672">-&gt;</span> Index range scan on accountIdentity using <span style="color:#a6e22e">IDX_ID_TYPE_NAME</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">21</span> rows<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">026</span><span style="color:#f92672">..</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">026</span> rows<span style="color:#f92672">=</span>0 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
        <span style="color:#f92672">-&gt;</span> Select <span style="color:#960050;background-color:#1e0010">#</span>3 <span style="color:#f92672">(</span>subquery in condition<span style="color:#f92672">;</span> run only once<span style="color:#f92672">)</span>
            <span style="color:#f92672">-&gt;</span> Filter<span style="color:#f92672">:</span> <span style="color:#f92672">(</span>accountOrganization<span style="color:#f92672">.</span><span style="color:#960050;background-color:#1e0010">`</span>NAME<span style="color:#960050;background-color:#1e0010">`</span> like <span style="color:#960050;background-color:#1e0010">&#39;</span>20<span style="color:#f92672">%</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">21</span> rows<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">033</span><span style="color:#f92672">..</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">033</span> rows<span style="color:#f92672">=</span>0 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
                <span style="color:#f92672">-&gt;</span> Index range scan on accountOrganization using <span style="color:#a6e22e">IDX_ORG_NAME</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">21</span> rows<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">032</span><span style="color:#f92672">..</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">032</span> rows<span style="color:#f92672">=</span>0 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
</code></pre></div><p>但是在<code>LIKE 202%</code>时，实际扫描14,1377行，已经接近于全表行数了（16.8w行）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">-&gt;</span> Limit<span style="color:#f92672">:</span> 20 <span style="color:#a6e22e">row</span><span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>99<span style="color:#f92672">.</span><span style="color:#a6e22e">352</span><span style="color:#f92672">..</span><span style="color:#a6e22e">1137</span><span style="color:#f92672">.</span><span style="color:#a6e22e">270</span> rows<span style="color:#f92672">=</span>20 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
    <span style="color:#f92672">-&gt;</span> Filter<span style="color:#f92672">:</span> <span style="color:#f92672">((</span><span style="color:#960050;background-color:#1e0010">`</span>account<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ACCOUNT_NAME</span> like <span style="color:#960050;background-color:#1e0010">&#39;</span>202<span style="color:#f92672">%</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">)</span> or <span style="color:#f92672">...)</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">33</span> rows<span style="color:#f92672">=</span>20<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>99<span style="color:#f92672">.</span><span style="color:#a6e22e">351</span><span style="color:#f92672">..</span><span style="color:#a6e22e">1137</span><span style="color:#f92672">.</span><span style="color:#a6e22e">265</span> rows<span style="color:#f92672">=</span>20 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
        <span style="color:#f92672">-&gt;</span> Index scan on account using <span style="color:#a6e22e">ACCOUNT_NAME_PAD</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">33</span> rows<span style="color:#f92672">=</span>20<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">779</span><span style="color:#f92672">..</span><span style="color:#a6e22e">1057</span><span style="color:#f92672">.</span><span style="color:#a6e22e">634</span> rows<span style="color:#f92672">=</span>141377 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
        <span style="color:#f92672">-&gt;</span> Select <span style="color:#960050;background-color:#1e0010">#</span>2 <span style="color:#f92672">(</span>subquery in condition<span style="color:#f92672">;</span> run only once<span style="color:#f92672">)</span>
            <span style="color:#f92672">-&gt;</span> Filter<span style="color:#f92672">:</span> <span style="color:#f92672">(</span>accountIdentity<span style="color:#f92672">.</span><span style="color:#960050;background-color:#1e0010">`</span>NAME<span style="color:#960050;background-color:#1e0010">`</span> like <span style="color:#960050;background-color:#1e0010">&#39;</span>202<span style="color:#f92672">%</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">21</span> rows<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">016</span><span style="color:#f92672">..</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">016</span> rows<span style="color:#f92672">=</span>0 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
                <span style="color:#f92672">-&gt;</span> Index range scan on accountIdentity using <span style="color:#a6e22e">IDX_ID_TYPE_NAME</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">21</span> rows<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">016</span><span style="color:#f92672">..</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">016</span> rows<span style="color:#f92672">=</span>0 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
        <span style="color:#f92672">-&gt;</span> Select <span style="color:#960050;background-color:#1e0010">#</span>3 <span style="color:#f92672">(</span>subquery in condition<span style="color:#f92672">;</span> run only once<span style="color:#f92672">)</span>
            <span style="color:#f92672">-&gt;</span> Filter<span style="color:#f92672">:</span> <span style="color:#f92672">(</span>accountOrganization<span style="color:#f92672">.</span><span style="color:#960050;background-color:#1e0010">`</span>NAME<span style="color:#960050;background-color:#1e0010">`</span> like <span style="color:#960050;background-color:#1e0010">&#39;</span>202<span style="color:#f92672">%</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">21</span> rows<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">012</span><span style="color:#f92672">..</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">012</span> rows<span style="color:#f92672">=</span>0 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
                <span style="color:#f92672">-&gt;</span> Index range scan on accountOrganization using <span style="color:#a6e22e">IDX_ORG_NAME</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">21</span> rows<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">012</span><span style="color:#f92672">..</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">012</span> rows<span style="color:#f92672">=</span>0 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
</code></pre></div><p>后面的情况其实也一样。</p>
<h4 id="为何v1比较稳定而且还比v2快">为何v1比较稳定，而且还比v2快？</h4>
<p>从v1的执行计划上看，v1实际上对<code>account</code>的扫描行数和全表总行数相当，同时还有排序动作：</p>
<table>
<thead>
<tr>
<th style="text-align:center">id</th>
<th style="text-align:center">select_type</th>
<th style="text-align:center">table</th>
<th style="text-align:center">partitions</th>
<th style="text-align:center">type</th>
<th style="text-align:center">possible_keys</th>
<th style="text-align:center">key</th>
<th style="text-align:center">key_len</th>
<th style="text-align:center">ref</th>
<th style="text-align:center">rows</th>
<th style="text-align:center">filtered</th>
<th style="text-align:center">Extra</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">PRIMARY</td>
<td style="text-align:center">account</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">ALL</td>
<td style="text-align:center">UQ_ACCOUNT_NAME,IDX_ACCOUNT_USERNAME</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">163505</td>
<td style="text-align:center">100.00</td>
<td style="text-align:center">Using where; Using filesort</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">SUBQUERY</td>
<td style="text-align:center">accountOrganization</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">range</td>
<td style="text-align:center">PRIMARY,IDX_ORG_NAME</td>
<td style="text-align:center">IDX_ORG_NAME</td>
<td style="text-align:center">602</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">1</td>
<td style="text-align:center">100.00</td>
<td style="text-align:center">Using where; Using index</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">SUBQUERY</td>
<td style="text-align:center">accountIdentity</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">range</td>
<td style="text-align:center">PRIMARY,IDX_ID_TYPE_NAME</td>
<td style="text-align:center">IDX_ID_TYPE_NAME</td>
<td style="text-align:center">602</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">1</td>
<td style="text-align:center">100.00</td>
<td style="text-align:center">Using where; Using index</td>
</tr>
</tbody>
</table>
<p>看<code>EXPLAIN ANALYZE</code>结果：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">-&gt;</span> Limit<span style="color:#f92672">:</span> 20 <span style="color:#a6e22e">row</span><span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>1542<span style="color:#f92672">.</span><span style="color:#a6e22e">761</span><span style="color:#f92672">..</span><span style="color:#a6e22e">1542</span><span style="color:#f92672">.</span><span style="color:#a6e22e">765</span> rows<span style="color:#f92672">=</span>20 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
    <span style="color:#f92672">-&gt;</span> Sort<span style="color:#f92672">:</span> <span style="color:#f92672">&lt;</span>temporary<span style="color:#f92672">&gt;.</span><span style="color:#a6e22e">tmp_field_0</span><span style="color:#f92672">,</span> <span style="color:#f92672">&lt;</span>temporary<span style="color:#f92672">&gt;.</span><span style="color:#a6e22e">ACCOUNT_NAME</span><span style="color:#f92672">,</span> limit input to 20 <span style="color:#a6e22e">row</span><span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> per <span style="color:#a6e22e">chunk</span>  <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>1542<span style="color:#f92672">.</span><span style="color:#a6e22e">759</span><span style="color:#f92672">..</span><span style="color:#a6e22e">1542</span><span style="color:#f92672">.</span><span style="color:#a6e22e">763</span> rows<span style="color:#f92672">=</span>20 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
        <span style="color:#f92672">-&gt;</span> Stream <span style="color:#a6e22e">results</span>  <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>2<span style="color:#f92672">.</span><span style="color:#a6e22e">586</span><span style="color:#f92672">..</span><span style="color:#a6e22e">1533</span><span style="color:#f92672">.</span><span style="color:#a6e22e">389</span> rows<span style="color:#f92672">=</span>26224 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
            <span style="color:#f92672">-&gt;</span> Nested loop inner <span style="color:#a6e22e">join</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>55023<span style="color:#f92672">.</span><span style="color:#a6e22e">35</span> rows<span style="color:#f92672">=</span>49960<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>2<span style="color:#f92672">.</span><span style="color:#a6e22e">583</span><span style="color:#f92672">..</span><span style="color:#a6e22e">1528</span><span style="color:#f92672">.</span><span style="color:#a6e22e">278</span> rows<span style="color:#f92672">=</span>26224 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
                <span style="color:#f92672">-&gt;</span> Filter<span style="color:#f92672">:</span> <span style="color:#f92672">(</span>accountOrganization<span style="color:#f92672">.</span><span style="color:#a6e22e">DELETED</span> <span style="color:#f92672">=</span> 0<span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>67<span style="color:#f92672">.</span><span style="color:#a6e22e">50</span> rows<span style="color:#f92672">=</span>61<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">161</span><span style="color:#f92672">..</span><span style="color:#a6e22e">1</span><span style="color:#f92672">.</span><span style="color:#a6e22e">679</span> rows<span style="color:#f92672">=</span>599 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
                    <span style="color:#f92672">-&gt;</span> Table scan on <span style="color:#a6e22e">accountOrganization</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>67<span style="color:#f92672">.</span><span style="color:#a6e22e">50</span> rows<span style="color:#f92672">=</span>605<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">160</span><span style="color:#f92672">..</span><span style="color:#a6e22e">1</span><span style="color:#f92672">.</span><span style="color:#a6e22e">441</span> rows<span style="color:#f92672">=</span>605 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
                <span style="color:#f92672">-&gt;</span> Filter<span style="color:#f92672">:</span> <span style="color:#f92672">((</span><span style="color:#960050;background-color:#1e0010">`</span>account<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ACCOUNT_NAME</span> like <span style="color:#960050;background-color:#1e0010">&#39;</span>202<span style="color:#f92672">%</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">)</span> or <span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">`</span>account<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#f92672">.</span><span style="color:#a6e22e">USER_NAME</span> like <span style="color:#960050;background-color:#1e0010">&#39;</span>202<span style="color:#f92672">%</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">)</span> or <span style="color:#f92672">&lt;</span>in_optimizer<span style="color:#f92672">&gt;(</span><span style="color:#960050;background-color:#1e0010">`</span>account<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IDENTITY_TYPE_ID</span><span style="color:#f92672">,</span><span style="color:#960050;background-color:#1e0010">`</span>account<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IDENTITY_TYPE_ID</span> in <span style="color:#f92672">(</span>select <span style="color:#960050;background-color:#1e0010">#</span>2<span style="color:#f92672">))</span> or <span style="color:#f92672">&lt;</span>in_optimizer<span style="color:#f92672">&gt;(</span><span style="color:#960050;background-color:#1e0010">`</span>account<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ORGANIZATION_ID</span><span style="color:#f92672">,</span><span style="color:#960050;background-color:#1e0010">`</span>account<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ORGANIZATION_ID</span> in <span style="color:#f92672">(</span>select <span style="color:#960050;background-color:#1e0010">#</span>3<span style="color:#f92672">)))</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>827<span style="color:#f92672">.</span><span style="color:#a6e22e">15</span> rows<span style="color:#f92672">=</span>826<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">319</span><span style="color:#f92672">..</span><span style="color:#a6e22e">2</span><span style="color:#f92672">.</span><span style="color:#a6e22e">545</span> rows<span style="color:#f92672">=</span>44 loops<span style="color:#f92672">=</span>599<span style="color:#f92672">)</span>
                    <span style="color:#f92672">-&gt;</span> Index lookup on account using <span style="color:#a6e22e">ORGANIZATION_ID</span> <span style="color:#f92672">(</span>ORGANIZATION_ID<span style="color:#f92672">=</span>accountOrganization<span style="color:#f92672">.</span><span style="color:#a6e22e">ID</span><span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>827<span style="color:#f92672">.</span><span style="color:#a6e22e">15</span> rows<span style="color:#f92672">=</span>826<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">086</span><span style="color:#f92672">..</span><span style="color:#a6e22e">2</span><span style="color:#f92672">.</span><span style="color:#a6e22e">398</span> rows<span style="color:#f92672">=</span>281 loops<span style="color:#f92672">=</span>599<span style="color:#f92672">)</span>
                    <span style="color:#f92672">-&gt;</span> Select <span style="color:#960050;background-color:#1e0010">#</span>2 <span style="color:#f92672">(</span>subquery in condition<span style="color:#f92672">;</span> run only once<span style="color:#f92672">)</span>
                        <span style="color:#f92672">-&gt;</span> Filter<span style="color:#f92672">:</span> <span style="color:#f92672">(</span>accountIdentity<span style="color:#f92672">.</span><span style="color:#960050;background-color:#1e0010">`</span>NAME<span style="color:#960050;background-color:#1e0010">`</span> like <span style="color:#960050;background-color:#1e0010">&#39;</span>202<span style="color:#f92672">%</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">21</span> rows<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">016</span><span style="color:#f92672">..</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">016</span> rows<span style="color:#f92672">=</span>0 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
                            <span style="color:#f92672">-&gt;</span> Index range scan on accountIdentity using <span style="color:#a6e22e">IDX_ID_TYPE_NAME</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">21</span> rows<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">015</span><span style="color:#f92672">..</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">015</span> rows<span style="color:#f92672">=</span>0 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
                    <span style="color:#f92672">-&gt;</span> Select <span style="color:#960050;background-color:#1e0010">#</span>3 <span style="color:#f92672">(</span>subquery in condition<span style="color:#f92672">;</span> run only once<span style="color:#f92672">)</span>
                        <span style="color:#f92672">-&gt;</span> Filter<span style="color:#f92672">:</span> <span style="color:#f92672">(</span>accountOrganization<span style="color:#f92672">.</span><span style="color:#960050;background-color:#1e0010">`</span>NAME<span style="color:#960050;background-color:#1e0010">`</span> like <span style="color:#960050;background-color:#1e0010">&#39;</span>202<span style="color:#f92672">%</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">21</span> rows<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">012</span><span style="color:#f92672">..</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">012</span> rows<span style="color:#f92672">=</span>0 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
                            <span style="color:#f92672">-&gt;</span> Index range scan on accountOrganization using <span style="color:#a6e22e">IDX_ORG_NAME</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>1<span style="color:#f92672">.</span><span style="color:#a6e22e">21</span> rows<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">012</span><span style="color:#f92672">..</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">012</span> rows<span style="color:#f92672">=</span>0 loops<span style="color:#f92672">=</span>1<span style="color:#f92672">)</span>
</code></pre></div><p>也可以看到，SQL执行过程中，通过<code>acccount.ORGANIZATION_ID</code>索引查找<code>account</code>记录，总共查了599次，每次平均281行，总共16.8w行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Index lookup on account using <span style="color:#a6e22e">ORGANIZATION_ID</span> <span style="color:#f92672">(</span>ORGANIZATION_ID<span style="color:#f92672">=</span>accountOrganization<span style="color:#f92672">.</span><span style="color:#a6e22e">ID</span><span style="color:#f92672">)</span>  <span style="color:#f92672">(</span>cost<span style="color:#f92672">=</span>827<span style="color:#f92672">.</span><span style="color:#a6e22e">15</span> rows<span style="color:#f92672">=</span>826<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>actual time<span style="color:#f92672">=</span>0<span style="color:#f92672">.</span><span style="color:#a6e22e">086</span><span style="color:#f92672">..</span><span style="color:#a6e22e">2</span><span style="color:#f92672">.</span><span style="color:#a6e22e">398</span> rows<span style="color:#f92672">=</span>281 loops<span style="color:#f92672">=</span>599<span style="color:#f92672">)</span>
</code></pre></div><p>那为何v1总是比较稳定，而且还比v2快呢？</p>
<p>因为v1扫描的是主键索引，不需要回表，而v2扫描的是<code>ACCOUNT_NAME_PAD</code>索引，在判断条件的时候需要回表，时间复杂度是 14w * log2(14w)。</p>
<h3 id="where-clause-2压测结果">where clause 2压测结果</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">(
   account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#f92672">?</span>
   <span style="color:#66d9ef">OR</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#f92672">?</span>
)
</code></pre></div><p>压测结果</p>
<table>
<thead>
<tr>
<th>查询参数/吞吐量</th>
<th>v1</th>
<th>v2</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>LIKE 20%</code> ，预估140,000行</td>
<td>84.71 QPS</td>
<td>67.61 QPS</td>
</tr>
<tr>
<td><code>LIKE 202%</code> ，预估26,000行</td>
<td>96.93 QPS</td>
<td>5.76 QPS</td>
</tr>
<tr>
<td><code>LIKE 2021%</code> ，预估12,000 行</td>
<td>96.98 QPS</td>
<td>5.18 QPS</td>
</tr>
<tr>
<td><code>LIKE 20211%</code>，预估1,200行</td>
<td>585.31 QPS</td>
<td>456.99 QPS</td>
</tr>
</tbody>
</table>
<h4 id="为何v2突然又行了">为何v2突然又行了？</h4>
<p>v2的 <code>LIKE 202%</code>和<code>LIKE 2021%</code>比<code>LIKE 20%</code>吞吐量低这个在之前已经分析过了，但是为何v2的<code>LIKE 20211%</code>吞吐量突然提升6倍？</p>
<p>看一下<code>LIKE 20211%</code>的执行计划：</p>
<table>
<thead>
<tr>
<th style="text-align:center">id</th>
<th style="text-align:center">select_type</th>
<th style="text-align:center">table</th>
<th style="text-align:center">partitions</th>
<th style="text-align:center">type</th>
<th style="text-align:center">possible_keys</th>
<th style="text-align:center">key</th>
<th style="text-align:center">key_len</th>
<th style="text-align:center">ref</th>
<th style="text-align:center">rows</th>
<th style="text-align:center">filtered</th>
<th style="text-align:center">Extra</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">SIMPLE</td>
<td style="text-align:center">account</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">index_merge</td>
<td style="text-align:center">UQ_ACCOUNT_NAME,IDX_ACCOUNT_USERNAME</td>
<td style="text-align:center">UQ_ACCOUNT_NAME,IDX_ACCOUNT_USERNAME</td>
<td style="text-align:center">362,767</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">1255</td>
<td style="text-align:center">100.00</td>
<td style="text-align:center">Using sort_union(UQ_ACCOUNT_NAME,IDX_ACCOUNT_USERNAME); Using where; Using filesort</td>
</tr>
</tbody>
</table>
<p>也就是说，当条件的预期结果集很少的时候，就会优先使用索引，而且还使用了<a href="https://dev.mysql.com/doc/refman/8.0/en/index-merge-optimization.html">Index Merge 优化</a>。</p>
<p>那么为何在where clause 1中没有启用Index Merge 优化？这是因为当查询语句复杂的时候，MySQL不会启用该优化。</p>
<p>事实上你在优化版本v1也能看到同样的结果（Index Merge优化）。</p>
<h2 id="优化方向">优化方向</h2>
<p>经过一系列测试，发现OR查询条件是影响索引使用的罪魁祸首，尝试用UNION修改：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> (
   account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;20211%&#39;</span>
 )
<span style="color:#66d9ef">union</span>
<span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> (
   account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;20211%&#39;</span>
 )
<span style="color:#66d9ef">union</span>
<span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> (
   account.IDENTITY_TYPE_ID <span style="color:#66d9ef">in</span> (<span style="color:#66d9ef">select</span> accountIdentity.ID <span style="color:#66d9ef">from</span> TB_B_IDENTITY_TYPE accountIdentity <span style="color:#66d9ef">where</span> accountIdentity.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;202%&#39;</span>)
 )
<span style="color:#66d9ef">union</span>
<span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> (
   account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>  (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> accountOrganization.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;202%&#39;</span>)
 )
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#66d9ef">length</span>(ACCOUNT_NAME), ACCOUNT_NAME 
<span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">20</span>
</code></pre></div><p>执行计划：</p>
<table>
<thead>
<tr>
<th style="text-align:center">id</th>
<th style="text-align:center">select_type</th>
<th style="text-align:center">table</th>
<th style="text-align:center">partitions</th>
<th style="text-align:center">type</th>
<th style="text-align:center">possible_keys</th>
<th style="text-align:center">key</th>
<th style="text-align:center">key_len</th>
<th style="text-align:center">ref</th>
<th style="text-align:center">rows</th>
<th style="text-align:center">filtered</th>
<th style="text-align:center">Extra</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">PRIMARY</td>
<td style="text-align:center">account</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">range</td>
<td style="text-align:center">UQ_ACCOUNT_NAME</td>
<td style="text-align:center">UQ_ACCOUNT_NAME</td>
<td style="text-align:center">362</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">52208</td>
<td style="text-align:center">100.00</td>
<td style="text-align:center">Using where; Using index</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">UNION</td>
<td style="text-align:center">account</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">range</td>
<td style="text-align:center">IDX_ACCOUNT_USERNAME</td>
<td style="text-align:center">IDX_ACCOUNT_USERNAME</td>
<td style="text-align:center">767</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">1</td>
<td style="text-align:center">100.00</td>
<td style="text-align:center">Using index condition</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">UNION</td>
<td style="text-align:center">accountIdentity</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">range</td>
<td style="text-align:center">PRIMARY,IDX_ID_TYPE_NAME</td>
<td style="text-align:center">IDX_ID_TYPE_NAME</td>
<td style="text-align:center">602</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">1</td>
<td style="text-align:center">100.00</td>
<td style="text-align:center">Using where; Using index</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">UNION</td>
<td style="text-align:center">account</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">ref</td>
<td style="text-align:center">IDENTITY_TYPE_ID</td>
<td style="text-align:center">IDENTITY_TYPE_ID</td>
<td style="text-align:center">194</td>
<td style="text-align:center">user_test.accountIdentity.ID</td>
<td style="text-align:center">14864</td>
<td style="text-align:center">100.00</td>
<td style="text-align:center"><em>NULL</em></td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">UNION</td>
<td style="text-align:center">accountOrganization</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">range</td>
<td style="text-align:center">PRIMARY,IDX_ORG_NAME</td>
<td style="text-align:center">IDX_ORG_NAME</td>
<td style="text-align:center">602</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">1</td>
<td style="text-align:center">100.00</td>
<td style="text-align:center">Using where; Using index</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">UNION</td>
<td style="text-align:center">account</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">ref</td>
<td style="text-align:center">ORGANIZATION_ID</td>
<td style="text-align:center">ORGANIZATION_ID</td>
<td style="text-align:center">194</td>
<td style="text-align:center">user_test.accountOrganization.ID</td>
<td style="text-align:center">825</td>
<td style="text-align:center">100.00</td>
<td style="text-align:center"><em>NULL</em></td>
</tr>
<tr>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">UNION RESULT</td>
<td style="text-align:center">&lt;union1,2,3,5&gt;</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">ALL</td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center"><em>NULL</em></td>
<td style="text-align:center">Using temporary; Using filesort</td>
</tr>
</tbody>
</table>
<p>可以看到所有的查询都用到了正确的索引。</p>
<h2 id="优化方案">优化方案</h2>
<p>所以针对不同的情况有三种形式：</p>
<ul>
<li>无条件时，ORDER BY ACCOUNT_NAME_PAD，这样就会利用 ACCOUNT_NAME_PAD 索引：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> LTRIM(account.ACCOUNT_NAME_PAD)
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> account.ACCOUNT_NAME_PAD
<span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">20</span>
</code></pre></div><ul>
<li>有条件时，ORDER BY length(ACCOUNT_NAME), ACCOUNT_NAME：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#f92672">&lt;</span>condition<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#66d9ef">length</span>(ACCOUNT_NAME), ACCOUNT_NAME
<span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">20</span>
</code></pre></div><ul>
<li>有OR条件时，改成UNION形式：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">OR</span> condition<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;</span>
  <span style="color:#66d9ef">and</span> <span style="color:#f92672">&lt;</span>other condition<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">union</span>
<span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">OR</span> condition<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#f92672">&gt;</span>
  <span style="color:#66d9ef">and</span> <span style="color:#f92672">&lt;</span>other condition<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&lt;</span>other <span style="color:#66d9ef">union</span><span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#66d9ef">length</span>(ACCOUNT_NAME), ACCOUNT_NAME
<span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">20</span>
</code></pre></div><h2 id="压测验证">压测验证</h2>
<p>命令：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">wrk2 <span style="color:#f92672">-</span><span style="color:#66d9ef">c</span> <span style="color:#ae81ff">100</span> <span style="color:#f92672">-</span>d <span style="color:#ae81ff">60</span> <span style="color:#f92672">-</span>R <span style="color:#ae81ff">2000</span> <span style="color:#f92672">-</span>B ...
</code></pre></div><h3 id="无条件">无条件</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> account.ACCOUNT_NAME_PAD
<span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">20</span> 
</code></pre></div><p>结果：1636.14 QPS</p>
<h3 id="一个条件">一个条件</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">AND</span> ACCOUNT_NAME <span style="color:#66d9ef">LIKE</span> <span style="color:#f92672">?</span>
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#66d9ef">length</span>(ACCOUNT_NAME), ACCOUNT_NAME
<span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">20</span>
</code></pre></div><p>结果</p>
<table>
<thead>
<tr>
<th>查询参数/吞吐量</th>
<th>吞吐量</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>LIKE 20%</code> ，预估140,000行</td>
<td>100 QPS</td>
</tr>
<tr>
<td><code>LIKE 202%</code> ，预估26,000行</td>
<td>460.81 QPS</td>
</tr>
<tr>
<td><code>LIKE 2021%</code> ，预估12,000 行</td>
<td>776.09 QPS</td>
</tr>
<tr>
<td><code>LIKE 20211%</code>，预估1,200行</td>
<td>1451.60 QPS</td>
</tr>
</tbody>
</table>
<h3 id="两个union">两个UNION</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME <span style="color:#66d9ef">as</span> accountName
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#f92672">?</span>
<span style="color:#66d9ef">union</span>
<span style="color:#66d9ef">select</span> account.ACCOUNT_NAME <span style="color:#66d9ef">as</span> accountName
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#f92672">?</span>
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#66d9ef">length</span>(accountName), accountName
<span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">20</span>
</code></pre></div><p>结果</p>
<table>
<thead>
<tr>
<th>查询参数/吞吐量</th>
<th>吞吐量</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>LIKE 20%</code> ，预估140,000行</td>
<td>20.65 QPS</td>
</tr>
<tr>
<td><code>LIKE 202%</code> ，预估26,000行</td>
<td>97.70 QPS</td>
</tr>
<tr>
<td><code>LIKE 2021%</code> ，预估12,000 行</td>
<td>221.69 QPS</td>
</tr>
<tr>
<td><code>LIKE 20211%</code>，预估1,200行</td>
<td>1651.56 QPS</td>
</tr>
</tbody>
</table>
<h3 id="4个union">4个UNION</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME <span style="color:#66d9ef">as</span> accountName
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#f92672">?</span>
<span style="color:#66d9ef">union</span>
<span style="color:#66d9ef">select</span> account.ACCOUNT_NAME <span style="color:#66d9ef">as</span> accountName
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#f92672">?</span>
<span style="color:#66d9ef">union</span>
<span style="color:#66d9ef">select</span> account.ACCOUNT_NAME <span style="color:#66d9ef">as</span> accountName
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> account.IDENTITY_TYPE_ID <span style="color:#66d9ef">IN</span>
      (<span style="color:#66d9ef">select</span> accountIdentity.ID <span style="color:#66d9ef">from</span> TB_B_IDENTITY_TYPE accountIdentity <span style="color:#66d9ef">where</span> accountIdentity.NAME <span style="color:#66d9ef">like</span> <span style="color:#f92672">?</span>)
<span style="color:#66d9ef">union</span>
<span style="color:#66d9ef">select</span> account.ACCOUNT_NAME <span style="color:#66d9ef">as</span> accountName
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> account.ORGANIZATION_ID <span style="color:#66d9ef">IN</span>
      (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> accountOrganization.NAME <span style="color:#66d9ef">like</span> <span style="color:#f92672">?</span>)
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#66d9ef">length</span>(accountName), accountName
<span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">20</span>
</code></pre></div><p>结果：</p>
<table>
<thead>
<tr>
<th>查询参数/吞吐量</th>
<th>吞吐量</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>LIKE 20%</code> ，预估140,000行</td>
<td>20.48 QPS</td>
</tr>
<tr>
<td><code>LIKE 202%</code> ，预估26,000行</td>
<td>97.43 QPS</td>
</tr>
<tr>
<td><code>LIKE 2021%</code> ，预估12,000 行</td>
<td>238.63 QPS</td>
</tr>
<tr>
<td><code>LIKE 20211%</code>，预估1,200行</td>
<td>1638.49 QPS</td>
</tr>
</tbody>
</table>
<h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/explain-output.html">MySQL EXPLAIN解读</a></li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/limit-optimization.html">MySQL LIMIT 优化</a></li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/order-by-optimization.html">MySQL ORDER BY 优化</a></li>
<li><a href="http://mysql.taobao.org/monthly/2014/11/10/">MySQL filesort with small LIMIT optimization</a></li>
<li><a href="https://dev.mysql.com/doc/internals/en/optimizer-tracing.html">MySQL 优化器跟踪</a></li>
</ul>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/mysql">#mysql</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98">#性能调优</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>