<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheatsheet</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/troubleshooting/">排障实战记录</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">SQL优化:一个含有JOIN&#43;LIMIT&#43;ORDER BY的SQL(中)</h1>
    
    <time>September 28, 2021</time>
    
    <div>
        <p>
        <p>在<a href="../sql-opt-join-limit-order-by">上一篇文章</a>里我们对一条SQL语句做了优化，放到项目上实际压测后，在100个数据库连接，2000并发的情况下，性能得到比较大的提升，从原来的 0.8 QPS升到了 15.94 QPS，吞吐量是原来的19.924倍！但这还是太慢了所以进行了再一次的优化，先看上次优化后的结果。</p>
<h2 id="回顾并分析">回顾并分析</h2>
<p>上次优化后将SQL拆分成了2部分。</p>
<p>1）先查询ACCOUNT_NAME</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-SQL" data-lang="SQL"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> (
        account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.IDENTITY_TYPE_ID <span style="color:#66d9ef">in</span> (<span style="color:#66d9ef">select</span> accountIdentity.ID <span style="color:#66d9ef">from</span> TB_B_IDENTITY_TYPE accountIdentity <span style="color:#66d9ef">where</span> accountIdentity.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>)
        <span style="color:#66d9ef">OR</span> account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>  (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> accountOrganization.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>)
    )
  <span style="color:#66d9ef">and</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
  <span style="color:#66d9ef">and</span> account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
  <span style="color:#66d9ef">and</span> account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>
      (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> DELETED <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>)
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#66d9ef">length</span>(account.ACCOUNT_NAME), account.ACCOUNT_NAME
<span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">20</span>;
</code></pre></div><p>2）再拿ACCOUNT_NAME去查询记录</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ID                  <span style="color:#66d9ef">as</span> id,
       account.GENDER_ID           <span style="color:#66d9ef">as</span> genderId,
       userGender.CODE             <span style="color:#66d9ef">as</span> genderCode,
       userGender.NAME             <span style="color:#66d9ef">as</span> genderName,
       account.NATION_ID           <span style="color:#66d9ef">as</span> nationId,
       userNation.CODE             <span style="color:#66d9ef">as</span> nationCode,
       userNation.NAME             <span style="color:#66d9ef">as</span> nationName,
       account.COUNTRY_ID          <span style="color:#66d9ef">as</span> countryId,
       userCountry.CODE            <span style="color:#66d9ef">as</span> countryCode,
       userCountry.NAME            <span style="color:#66d9ef">as</span> countryName,
       account.ADDRESS_ID          <span style="color:#66d9ef">as</span> addressId,
       userAddress.CODE            <span style="color:#66d9ef">as</span> addressCode,
       userAddress.NAME            <span style="color:#66d9ef">as</span> addressName,
       account.USER_ID             <span style="color:#66d9ef">as</span> userId,
       account.USER_NAME           <span style="color:#66d9ef">as</span> userName,
       account.USER_UID            <span style="color:#66d9ef">as</span> userUid,
       account.ACCOUNT_NAME        <span style="color:#66d9ef">as</span> accountName,
       account.IDENTITY_TYPE_ID    <span style="color:#66d9ef">as</span> identityTypeId,
       accountIdentity.CODE        <span style="color:#66d9ef">as</span> identityTypeCode,
       accountIdentity.NAME        <span style="color:#66d9ef">as</span> identityTypeName,
       account.ORGANIZATION_ID     <span style="color:#66d9ef">as</span> organizationId,
       accountOrganization.CODE    <span style="color:#66d9ef">as</span> organizationCode,
       accountOrganization.NAME    <span style="color:#66d9ef">as</span> organizationName,
       account.IS_DATA_CENTER      <span style="color:#66d9ef">as</span> isDataCenter,
       account.ACTIVATION          <span style="color:#66d9ef">as</span> activation,
       account.<span style="color:#66d9ef">STATE</span>               <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">state</span>,
       account.ACCOUNT_EXPIRY_DATE <span style="color:#66d9ef">as</span> accountExpiryDate,
       account.ACCOUNT_LOCKED      <span style="color:#66d9ef">as</span> accountLocked,
       account.PHONE_NUMBER        <span style="color:#66d9ef">as</span> phoneNumber,
       account.EMAIL               <span style="color:#66d9ef">as</span> email,
       <span style="color:#66d9ef">user</span>.IMAGE_URL              <span style="color:#66d9ef">as</span> imageUrl
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
         <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> TB_B_ORGANIZATION accountOrganization
                    <span style="color:#66d9ef">on</span> account.ORGANIZATION_ID <span style="color:#f92672">=</span> accountOrganization.ID
         <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> TB_B_IDENTITY_TYPE accountIdentity <span style="color:#66d9ef">on</span> account.IDENTITY_TYPE_ID <span style="color:#f92672">=</span> accountIdentity.ID
         <span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> TB_B_DICTIONARY userCertificateType <span style="color:#66d9ef">on</span> account.certificate_type_id <span style="color:#f92672">=</span> userCertificateType.ID
         <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> TB_B_DICTIONARY userGender <span style="color:#66d9ef">on</span> account.GENDER_ID <span style="color:#f92672">=</span> userGender.ID
         <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> TB_B_DICTIONARY userNation <span style="color:#66d9ef">on</span> account.NATION_ID <span style="color:#f92672">=</span> userNation.ID
         <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> TB_B_DICTIONARY userCountry <span style="color:#66d9ef">on</span> account.COUNTRY_ID <span style="color:#f92672">=</span> userCountry.ID
         <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> TB_B_DICTIONARY userAddress <span style="color:#66d9ef">on</span> account.ADDRESS_ID <span style="color:#f92672">=</span> userAddress.ID
         <span style="color:#66d9ef">left</span> <span style="color:#66d9ef">join</span> TB_B_USER <span style="color:#66d9ef">user</span> <span style="color:#66d9ef">on</span> account.USER_ID <span style="color:#f92672">=</span> <span style="color:#66d9ef">user</span>.ID
<span style="color:#66d9ef">where</span> account.ACCOUNT_NAME <span style="color:#66d9ef">in</span> ( ... );
</code></pre></div><p>在压测期间得知，绝大部分时间消耗在第一条SQL上，回顾第一条SQL的EXPLAIN：</p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">select_type</th>
<th style="text-align:left">table</th>
<th style="text-align:left">partitions</th>
<th style="text-align:left">type</th>
<th style="text-align:left">possible_keys</th>
<th style="text-align:left">key</th>
<th style="text-align:left">key_len</th>
<th style="text-align:left">ref</th>
<th style="text-align:left">rows</th>
<th style="text-align:left">filtered</th>
<th style="text-align:left">Extra</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">accountOrganization</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">ALL</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">84</td>
<td style="text-align:left">10</td>
<td style="text-align:left">Using where; Using temporary; Using filesort</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">account</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">ref</td>
<td style="text-align:left">UQ_ACCOUNT_NAME,ORGANIZATION_ID,UQ_ACCOUNT_USRNAME,IDX_ACCOUNT_USERNAME</td>
<td style="text-align:left">ORGANIZATION_ID</td>
<td style="text-align:left">194</td>
<td style="text-align:left">user_new.accountOrganization.ID</td>
<td style="text-align:left">3629</td>
<td style="text-align:left">25</td>
<td style="text-align:left">Using where</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">SUBQUERY</td>
<td style="text-align:left">accountOrganization</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">range</td>
<td style="text-align:left">PRIMARY,IDX_ORG_NAME</td>
<td style="text-align:left">IDX_ORG_NAME</td>
<td style="text-align:left">602</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">Using where; Using index</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">SUBQUERY</td>
<td style="text-align:left">accountIdentity</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">range</td>
<td style="text-align:left">PRIMARY,IDX_ID_TYPE_NAME</td>
<td style="text-align:left">IDX_ID_TYPE_NAME</td>
<td style="text-align:left">602</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">Using where; Using index</td>
</tr>
</tbody>
</table>
<p>可以看到：</p>
<ul>
<li>第一行是 accountOrganization 表，它是JOIN驱动表，但是SQL语句里没有直接的用JOIN，但是MySQL把Where翻译成JOIN了。</li>
<li>第二行是 account 表，是被驱动表，这个表实际上会被全扫描，总数据量为14w左右。</li>
<li>不论是 accountOrganization表还是 account 表，都是全表扫描来过滤记录的，压根没有用到索引。</li>
</ul>
<p>另外补充信息，在项目实际情况中：</p>
<ul>
<li>where里的条件除了 accountOrganization.DELETED=0之外，其他条件可以全部没有。</li>
<li>上一条情况比较普遍，因为业务上用户的第一次查询是程序发起的，几乎都是没有查询条件的。</li>
<li>accountOrganization.DELETED=1的记录很少，500条中只有1条。</li>
<li>accountOrganization，accountIdentity 表的记录比较稳定，几乎不会变。</li>
</ul>
<p>所以我们的目标是：</p>
<ul>
<li>让查询用到account上的索引</li>
</ul>
<h2 id="去掉join">去掉JOIN</h2>
<p>已经可以确定EXPLAIN结果中的JOIN是因为这个WHERE条件造成的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-SQL" data-lang="SQL"><span style="color:#66d9ef">and</span> account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>
      (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> DELETED <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>)
</code></pre></div><p>根据项目现场的数据，accountOrganization.DELETED=1的记录很少，500条中只有1条，且数据基本稳定不怎么变动，所以我们可以做以下改动：</p>
<ul>
<li>先做一个查询，把 accountOrganization.DELETED=1的数据查出来，并缓存结果。</li>
<li>修改 <code>account.ORGANIZATION_ID not in (id, ...)</code></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> (
        account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.IDENTITY_TYPE_ID <span style="color:#66d9ef">in</span> (<span style="color:#66d9ef">select</span> accountIdentity.ID <span style="color:#66d9ef">from</span> TB_B_IDENTITY_TYPE accountIdentity <span style="color:#66d9ef">where</span> accountIdentity.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>)
        <span style="color:#66d9ef">OR</span> account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>  (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> accountOrganization.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>)
    )
  <span style="color:#66d9ef">and</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
  <span style="color:#66d9ef">and</span> account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
  <span style="color:#66d9ef">and</span> account.ORGANIZATION_ID <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">in</span> (<span style="color:#e6db74">&#39;6394cd50297911ebe98bc1e17e87f048&#39;</span>)
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#66d9ef">length</span>(account.ACCOUNT_NAME), account.ACCOUNT_NAME
<span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">20</span>;
</code></pre></div><p>然后我们还可以做进一步优化，从业务上分析，去掉<code>ORGANIZATION.DELETED=0</code>也是可以的。所以进一步变成：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> (
        account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.IDENTITY_TYPE_ID <span style="color:#66d9ef">in</span> (<span style="color:#66d9ef">select</span> accountIdentity.ID <span style="color:#66d9ef">from</span> TB_B_IDENTITY_TYPE accountIdentity <span style="color:#66d9ef">where</span> accountIdentity.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>)
        <span style="color:#66d9ef">OR</span> account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>  (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> accountOrganization.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>)
    )
  <span style="color:#66d9ef">and</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
  <span style="color:#66d9ef">and</span> account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#66d9ef">length</span>(account.ACCOUNT_NAME), account.ACCOUNT_NAME
<span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">20</span>;
</code></pre></div><p>EXPLAIN结果：</p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">select_type</th>
<th style="text-align:left">table</th>
<th style="text-align:left">partitions</th>
<th style="text-align:left">type</th>
<th style="text-align:left">possible_keys</th>
<th style="text-align:left">key</th>
<th style="text-align:left">key_len</th>
<th style="text-align:left">ref</th>
<th style="text-align:left">rows</th>
<th style="text-align:left">filtered</th>
<th style="text-align:left">Extra</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">account</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">ALL</td>
<td style="text-align:left">UQ_ACCOUNT_NAME,UQ_ACCOUNT_USRNAME,IDX_ACCOUNT_USERNAME</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">130679</td>
<td style="text-align:left">25</td>
<td style="text-align:left">Using where; Using filesort</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">SUBQUERY</td>
<td style="text-align:left">accountOrganization</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">range</td>
<td style="text-align:left">PRIMARY,IDX_ORG_NAME</td>
<td style="text-align:left">IDX_ORG_NAME</td>
<td style="text-align:left">602</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">Using where; Using index</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">SUBQUERY</td>
<td style="text-align:left">accountIdentity</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">range</td>
<td style="text-align:left">PRIMARY,IDX_ID_TYPE_NAME</td>
<td style="text-align:left">IDX_ID_TYPE_NAME</td>
<td style="text-align:left">602</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">Using where; Using index</td>
</tr>
</tbody>
</table>
<p>可以看到，JOIN没有了，但是对<code>account</code>表的还是全表扫描（<code>Extra: Using where; Using filesort</code>）。</p>
<p>为什么会发生这个情况呢？因为查询条件<code>LIKE 'user%'</code>的查询结果几乎就是全表了，所以MySQL就说干脆全表不走索引了。如果条件换成<code>LIKE '20%'</code>实际结集是80行，就会走索引了，且使用了filesort：</p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">select_type</th>
<th style="text-align:left">table</th>
<th style="text-align:left">partitions</th>
<th style="text-align:left">type</th>
<th style="text-align:left">possible_keys</th>
<th style="text-align:left">key</th>
<th style="text-align:left">key_len</th>
<th style="text-align:left">ref</th>
<th style="text-align:left">rows</th>
<th style="text-align:left">filtered</th>
<th style="text-align:left">Extra</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">account</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">range</td>
<td style="text-align:left">UQ_ACCOUNT_NAME,UQ_ACCOUNT_USRNAME,IDX_ACCOUNT_USERNAME</td>
<td style="text-align:left">UQ_ACCOUNT_NAME</td>
<td style="text-align:left">362</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">80</td>
<td style="text-align:left">100</td>
<td style="text-align:left">Using index condition; Using where; Using filesort</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">SUBQUERY</td>
<td style="text-align:left">accountOrganization</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">range</td>
<td style="text-align:left">PRIMARY,IDX_ORG_NAME</td>
<td style="text-align:left">IDX_ORG_NAME</td>
<td style="text-align:left">602</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">Using where; Using index</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">SUBQUERY</td>
<td style="text-align:left">accountIdentity</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">range</td>
<td style="text-align:left">PRIMARY,IDX_ID_TYPE_NAME</td>
<td style="text-align:left">IDX_ID_TYPE_NAME</td>
<td style="text-align:left">602</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">Using where; Using index</td>
</tr>
</tbody>
</table>
<h2 id="使用索引走全表扫描">使用索引走全表扫描</h2>
<p>原始ORDER BY条件的意思是先根据长度排序，即短的放前面长的放后面，再根据字典序：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">...
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> <span style="color:#66d9ef">length</span>(account.ACCOUNT_NAME), account.ACCOUNT_NAME
...
</code></pre></div><p>我们可以对<code>ACCOUNT_NAME</code>的值做填充，使其长度一致，排序后又能得到同样的效果，比如：</p>
<table>
<thead>
<tr>
<th>原始</th>
<th>填充</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>3</code></td>
<td><code>__3</code></td>
</tr>
<tr>
<td><code>22</code></td>
<td><code>_22</code></td>
</tr>
</tbody>
</table>
<p>上面的<code>_</code>实际为空格。</p>
<p>于是添加一个字段用来存放<code>ACCOUNT_NAME</code>的填充数据，填充长度为<code>max(length(ACCOUNT_NAME))</code>，并且加上了索引，因为MySQL在走全表扫描的时候，可能会优先使用ORDER BY字段的索引：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> TB_B_ACCOUNT <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">column</span> ACCOUNT_NAME_PAD VARCHAR(<span style="color:#ae81ff">255</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">DEFAULT</span>(LPAD(ACCOUNT_NAME, <span style="color:#ae81ff">20</span>, <span style="color:#e6db74">&#39; &#39;</span>));
<span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> TB_B_ACCOUNT <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">index</span> ACCOUNT_NAME_PAD(ACCOUNT_NAME_PAD);
</code></pre></div><p>然后SQL改成：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> account.ACCOUNT_NAME
<span style="color:#66d9ef">from</span> TB_B_ACCOUNT account
<span style="color:#66d9ef">where</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">and</span> (
        account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
        <span style="color:#66d9ef">OR</span> account.IDENTITY_TYPE_ID <span style="color:#66d9ef">in</span> (<span style="color:#66d9ef">select</span> accountIdentity.ID <span style="color:#66d9ef">from</span> TB_B_IDENTITY_TYPE accountIdentity <span style="color:#66d9ef">where</span> accountIdentity.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>)
        <span style="color:#66d9ef">OR</span> account.ORGANIZATION_ID <span style="color:#66d9ef">in</span>  (<span style="color:#66d9ef">select</span> accountOrganization.ID <span style="color:#66d9ef">FROM</span> TB_B_ORGANIZATION accountOrganization <span style="color:#66d9ef">where</span> accountOrganization.NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>)
    )
  <span style="color:#66d9ef">and</span> account.USER_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
  <span style="color:#66d9ef">and</span> account.ACCOUNT_NAME <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;user%&#39;</span>
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> account.ACCOUNT_NAME_PAD
<span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">20</span>;
</code></pre></div><p>EXPLAIN：</p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">select_type</th>
<th style="text-align:left">table</th>
<th style="text-align:left">partitions</th>
<th style="text-align:left">type</th>
<th style="text-align:left">possible_keys</th>
<th style="text-align:left">key</th>
<th style="text-align:left">key_len</th>
<th style="text-align:left">ref</th>
<th style="text-align:left">rows</th>
<th style="text-align:left">filtered</th>
<th style="text-align:left">Extra</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">PRIMARY</td>
<td style="text-align:left">account</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">index</td>
<td style="text-align:left">UQ_ACCOUNT_NAME,UQ_ACCOUNT_USRNAME,IDX_ACCOUNT_USERNAME</td>
<td style="text-align:left">ACCOUNT_NAME_PAD</td>
<td style="text-align:left">767</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">40</td>
<td style="text-align:left">25</td>
<td style="text-align:left">Using where</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">SUBQUERY</td>
<td style="text-align:left">accountOrganization</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">range</td>
<td style="text-align:left">PRIMARY,IDX_ORG_NAME</td>
<td style="text-align:left">IDX_ORG_NAME</td>
<td style="text-align:left">602</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">Using where; Using index</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">SUBQUERY</td>
<td style="text-align:left">accountIdentity</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">range</td>
<td style="text-align:left">PRIMARY,IDX_ID_TYPE_NAME</td>
<td style="text-align:left">IDX_ID_TYPE_NAME</td>
<td style="text-align:left">602</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">1</td>
<td style="text-align:left">100</td>
<td style="text-align:left">Using where; Using index</td>
</tr>
</tbody>
</table>
<p>可以看到使用了<code>ACCOUNT_NAME_PAD</code>索引，并且取消了filesort。</p>
<h2 id="总结">总结</h2>
<p>总结一下两次优化的结论：</p>
<ul>
<li><code>WHERE</code>用到的字段都加上索引。</li>
<li><code>LIKE</code>改写成前缀匹配，这样可以利用索引。</li>
<li>尽一切可能去掉<code>JOIN</code>，这样可以让MySQL选择被查表上的索引。</li>
<li>预期结果集小的时候，MySQL会选择索引匹配查询条件，然后filesort。这个时候要确保<code>sort_buffer_size</code>足够，避免<code>filesort</code>排序时写磁盘，并且利用堆+LIMIT来优化排序。</li>
<li>预期结果集大的时候，MySQL会选择全表扫描，此时就要在排序字段上添加索引，这样就会用排序字段索引全表扫描，避免了filesort。</li>
<li>虽然取消了filesort，但是却走了全表扫描，这样会更快吗？请看<a href="../sql-opt-join-limit-order-by-3">下一篇文章分析</a>。</li>
</ul>
<h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/explain-output.html">MySQL EXPLAIN解读</a></li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/limit-optimization.html">MySQL LIMIT 优化</a></li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/order-by-optimization.html">MySQL ORDER BY 优化</a></li>
<li><a href="http://mysql.taobao.org/monthly/2014/11/10/">MySQL filesort with small LIMIT optimization</a></li>
<li><a href="https://dev.mysql.com/doc/internals/en/optimizer-tracing.html">MySQL 优化器跟踪</a></li>
</ul>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/mysql">#mysql</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98">#性能调优</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>