<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheat sheet</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">MySQL - 索引</h1>
    
    <time>December 20, 2019</time>
    
    <div>
        <p>
        <p>索引是在存储引擎层实现的，不同引擎实现方式不同，下面讲的是InnoDB。</p>
<h2 id="innodb索引模型">InnoDB索引模型</h2>
<p>表都是根据主键顺序以索引的形式存放的，这种存储方式的表称为索引组织表。这个索引组织表的结构是B+树，是一颗N叉树。</p>
<p>有一张表两个字段ID和k，ID是主键，k则是普通列+索引，这张表的存储形式如下图：</p>
<figure>
    <img src="index-structure.png" width="100%"/> 
</figure>

<ul>
<li>索引中的数据都是有序存储的。根据索引字段的顺序比如<code>(a, b)</code>就等于<code>order by a, b</code></li>
<li>主键索引中存放的是ID的值+行。这种索引称为clustered index。</li>
<li>k索引中存放的则是k的值+ID。这种索引称为secondary index。</li>
</ul>
<h2 id="索引维护">索引维护</h2>
<p>索引以数据页的形式存在磁盘上，可以认为每页存放N个B+树的结点。</p>
<ul>
<li>数据页有很多</li>
<li>数据页的大小是固定的（可参数调整）</li>
<li>数据页中的数据是按照索引字段排序的，前面的图里可以看到</li>
<li>在磁盘上是段连续的空间，因为机械磁盘顺序读写的速度快，随机读写的速度超级慢。</li>
</ul>
<p>页分裂：插入一条数据需要写数据页，如果数据页满了，<strong>且插入位置在中间</strong>，那么存储引擎要申请一个新的数据页，把部分数据移动过去。<strong>数据插在尾部没有这个问题</strong>。</p>
<p>页合并：删除一条数据，当页的利用率很低之后，就会合并页。</p>
<p>页空洞：页分裂过程会产生**“页空洞”**，因为两个页都不满（分裂后只用50%），但是占用磁盘空间，页空洞是占用大量磁盘空间的一个很常见的原因。</p>
<h2 id="用什么作主键">用什么作主键</h2>
<h3 id="自增id做主键">自增ID做主键</h3>
<p>用<code>NOT NULL PRIMARY KEY AUTO_INCREMENT</code>创建一个自增ID主键索引。两个好处：</p>
<ol>
<li>节省空间：自增ID是数字，占用4个字节（int）或8个字节（bigint）。回想前面的图中普通索引存的是索引字段+主键。如果你有多个普通索引，那么这里省下的空间是比较可观的。</li>
<li>没有“页空洞”：因为是自增的，所以每次插入都插在数据页尾部，所以没有“页分裂”，所以就没有“页空洞”</li>
</ol>
<h3 id="业务主键做主键">业务主键做主键</h3>
<p>比如拿身份证号做主键，和自增ID比，存在浪费空间，会产生页空洞的问题。但也有合适的时候：</p>
<ul>
<li>只有一个索引</li>
<li>该索引必须是唯一索引</li>
</ul>
<h2 id="回表问题">回表问题</h2>
<p>什么是“回表”：</p>
<ul>
<li><code>select * from T where id=1</code>，执行器只需到主键索引中查就行了</li>
<li><code>select * from T where k=5</code>，执行器要先到K索引中查到ID，然后再拿ID到主键索引中查。这个就是<strong>回表</strong>。如果查到的ID是N个，那么就要N次回表。</li>
</ul>
<p>所以避免回表是提升执行效率有效手段，方法有：</p>
<ul>
<li>查询只用到主键索引，可以避免回表</li>
<li>查询字段在索引覆盖的范围内，比如<code>select ID,k from T where k=5</code></li>
<li>覆盖索引：联合索引比如<code>(k, t)</code>，那么这种也能避免回表：<code>select id, k, t from T where k=5</code></li>
</ul>
<h3 id="覆盖索引">覆盖索引</h3>
<p>覆盖索引可以避免回表问题，但也会占用空间。使用时需要权衡利弊。</p>
<h3 id="最左前缀原则">最左前缀原则</h3>
<p>你可以建一个联合索引<code>(a, b, c)</code>来覆盖到以下查询：</p>
<ul>
<li><code>where a=1</code></li>
<li><code>where a=1 and b=1</code></li>
<li><code>where a=1 and b=1 and c=1</code></li>
<li><code>order by a</code></li>
<li><code>order by a, b</code></li>
<li><code>order by a, b, c</code></li>
<li><code>where a=1 order by b</code></li>
</ul>
<p>对于字符类型字段，则<code>like 'xyz%'</code>这种形式也符合最左前缀原则。</p>
<p><strong>不只是索引的全部定义，只要满足最左前缀，就可以利用索引来加速检索。这个最左前缀可以是联合索引的最左 N 个字段，也可以是字符串索引的最左 M 个字符。</strong></p>
<p>所以：</p>
<ol>
<li>索引的创建要和业务查询相匹配</li>
<li>如果通过改变顺序能够少维护一个索引，那么就优先考虑这种方案</li>
<li>如果<code>(a, b), (b)</code>和<code>(b, a), (a)</code>都能满足要求，那么看哪种占用空间小就用哪个。其实就是看<code>a</code>和<code>b</code>哪个占用空间小。</li>
</ol>
<h3 id="索引下推">索引下推</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> tuser <span style="color:#66d9ef">where</span> name <span style="color:#66d9ef">like</span> <span style="color:#e6db74">&#39;张%&#39;</span> <span style="color:#66d9ef">and</span> age<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span> <span style="color:#66d9ef">and</span> ismale<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
</code></pre></div><p>如果<code>name</code>和<code>age</code>都有索引，但是<code>ismale</code>没有，在MySQL 5.6之前是先根据<code>name</code>找到记录，然后就开始回表判断了。5.6之后则会先拿索引字段<code>name</code>和<code>age</code>来过滤，然后再回表。</p>
<h2 id="重建索引">重建索引</h2>
<p>为何要重建索引？为了解决数据页空洞，节省磁盘空间。</p>
<p>重建主键索引会将其他索引一并重建。事实上无论是删除还是创建主键都会将整个表的索引都搞一遍。</p>
<p>可以使用<code>alter table T engine=InnoDB</code>来重建。当然下面也是可以的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> T <span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">index</span> k;
<span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> T <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">index</span>(k);

<span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> T <span style="color:#66d9ef">drop</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span>;
<span style="color:#66d9ef">alter</span> <span style="color:#66d9ef">table</span> T <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span>(id);
</code></pre></div>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/mysql">#mysql</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>