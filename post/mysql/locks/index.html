<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">MySQL - 锁</h1>
    
    <time>December 20, 2019</time>
    
    <div>
        <p>
        <p>先导概念：</p>
<ul>
<li>读锁：可以并发读，如果有写操作，则必须等读锁释放</li>
<li>写锁：不能并发读，也不能并发写，都必须等写锁释放才能继续</li>
</ul>
<h2 id="全局锁">全局锁</h2>
<p>使用<a href="https://dev.mysql.com/doc/refman/8.0/en/flush.html#flush-tables-with-read-lock">FLUSH TABLES WITH READ LOCK</a>会让你给整个数据库加一个读锁。这会阻塞所有DML、DDL、更新类事务的commit，直到被释放。</p>
<p><strong>全局锁的典型使用场景是，做全库逻辑备份。</strong></p>
<p>怎么释放？TODO</p>
<h2 id="表级锁">表级锁</h2>
<h3 id="表锁">表锁</h3>
<p>通过下面语句给表加上读锁或写锁，还有释放：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#75715e">-- 加锁
</span><span style="color:#75715e"></span><span style="color:#66d9ef">lock</span> tables ... <span style="color:#66d9ef">read</span><span style="color:#f92672">/</span><span style="color:#66d9ef">write</span>
<span style="color:#75715e">-- 释放
</span><span style="color:#75715e"></span>unlock tables
<span style="color:#75715e">-- 例如
</span><span style="color:#75715e"></span><span style="color:#66d9ef">lock</span> tables t1 <span style="color:#66d9ef">read</span>, t2 <span style="color:#66d9ef">write</span>
</code></pre></div><p>MySQL的锁不是可重入的，即加锁之后，当前连接/session也受制于这个锁。</p>
<p>如果加的是读锁：</p>
<ul>
<li>本session：可以读，不可写（直接报错）</li>
<li>其他session：可以读，阻塞写</li>
</ul>
<p>如果加的是写锁：</p>
<ul>
<li>本session：可以读、可以写</li>
<li>其他session：阻塞读、阻塞写</li>
</ul>
<h3 id="元数据锁metadata-lockmdl">元数据锁（Metadata Lock，MDL）</h3>
<p>访问表的时候会被自动加上（隐式）：</p>
<ul>
<li>在CRUD一个表的时候，加上MDL读锁</li>
<li>对表结构变更的时候，加上MDL写锁</li>
</ul>
<p>**陷阱：MDL锁在语句开始时申请，但是要在事务提交之后才会释放。**所以下面语句会导致很多数据库操作被阻塞：</p>
<p><!-- raw HTML omitted --></p>
<ol>
<li>session A开启事务，查询，得到MDL读锁</li>
<li>session B查询，得到MDL读锁</li>
<li>session C加字段，要得到MDL写锁，阻塞</li>
<li>session D查询，要得到MDL读锁，阻塞</li>
</ol>
<p>因为session A没有提交事务，所以就造成了后续一连串的阻塞。如果某个表上的查询语句频繁，而且客户端有重试机制，也就是说超时后会再起一个新 session 再请求的话，这个库的线程很快就会爆满。</p>
<p><strong>解决办法：</strong></p>
<p>问题的本质在于一个MDL写锁在等待MDL读锁的释放，而读锁却在一个长事务里，导致后续的MDL读锁堆积。</p>
<p>所以可以在执行DDL之前看有没有长事务在跑，如果有，Kill掉这个长事务，或者等待长事务结束在DDL。</p>
<p>还可以给DDL添加超时时间，如果等待超时则放弃，然后人工再重试（MariaDB和AliSQL支持下面语法）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> tbl_name NOWAIT <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">column</span> ...
<span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> tbl_name WAIT N <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">column</span> ... 
</code></pre></div><h2 id="行锁">行锁</h2>
<p>InnoDB支持行锁，MyISAM不支持。所以行锁是做在存储引擎上的。</p>
<p>比如下面：</p>
<table>
<thead>
<tr>
<th align="center">事务A</th>
<th align="center">事务B</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">begin;<!-- raw HTML omitted -->update t set k=k+1 where id=1;<!-- raw HTML omitted -->update t set k=k+2 where id=2;</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">begin;<!-- raw HTML omitted -->update t set k=k+2 where id=1;</td>
</tr>
<tr>
<td align="center">commit;</td>
<td align="center"></td>
</tr>
</tbody>
</table>
<p>很容易就能猜到，事务B会被阻塞，直到事务A提交。所以：</p>
<ul>
<li><strong>行锁在需要的时候才获取（执行具体语句时）</strong></li>
<li><strong>事务持有的行锁在事务提交时才会被释放。（这个和MDL锁一样一样的）</strong></li>
</ul>
<h3 id="死锁">死锁</h3>
<p>因为上面的两个特性，很容易造成死锁：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>事务A</th>
<th>事务B</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>begin;</td>
<td>begin;</td>
</tr>
<tr>
<td>2</td>
<td>update t set k=k+1 where id=1;</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td></td>
<td>update t set k=k+1 where id=2;</td>
</tr>
<tr>
<td>4</td>
<td>update t set k=k+1 where id=2;</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td></td>
<td>update t set k=k+1 where id=1;</td>
</tr>
<tr>
<td>6</td>
<td>commit;</td>
<td>commit;</td>
</tr>
</tbody>
</table>
<p>其实在4和5的时候，事务A和事务B就都不能继续下去了，大家互相等待。</p>
<p>解决办法：</p>
<ul>
<li>系统参数<a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_lock_wait_timeout"><code>innodb_lock_wait_timeout</code></a>，控制事务等待行锁的超时时间（秒）。默认50秒。</li>
<li>系统参数[<code>innodb_deadlock_detect</code>][7]，开启死锁检测。默认on。发现死锁后，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。</li>
</ul>
<p>死锁检测的过程：每当一个事务被锁的时候，就要看看它所依赖的线程有没有被别人锁住，如此循环，最后判断是否出现了循环等待，也就是死锁。</p>
<h3 id="死锁检测高并发情况下拖慢速度">死锁检测高并发情况下拖慢速度</h3>
<p>假设有 1000 个并发线程要同时更新同一行，每个线程都要检测是否和其他线程形成死锁，那么死锁检测操作就是 100 万这个量级的。于是出现**“CPU 利用率很高，但是每秒却执行不了几个事务“**。</p>
<p>解决办法：</p>
<ol>
<li>保证程序不会出现死锁，然后把死锁检测关掉。不靠谱。</li>
<li>控制并发度，最好对同一行的修改串行化。依赖于中间件或者修改MySQL源码。</li>
<li>锁的条带化（Java并发编程里的概念），比如影院账号的例子，把账号分成10个，减少锁的冲突。</li>
</ol>
<h3 id="加锁的顺序">加锁的顺序</h3>
<p>先给哪行加锁，后给哪行加锁，是有讲究的，<strong>如果你的事务中需要锁多个行，要把最可能造成锁冲突、最可能影响并发度的锁尽量往后放。</strong>。什么比如一个购票的业务：</p>
<ol>
<li>从顾客 A 账户余额中扣除电影票价；</li>
<li>给影院 B 的账户余额增加这张电影票价；</li>
<li>记录一条交易日志。</li>
</ol>
<p>显然更新影院B账户余额的并发度比更新顾客A账户余额高很多，应该把它放后面。可以按照3、1、2的顺序执行。</p>
<h2 id="数据库备份">数据库备份</h2>
<p>可以使用<a href="https://dev.mysql.com/doc/refman/8.0/en/flush.html#flush-tables-with-read-lock">FLUSH TABLES WITH READ LOCK</a>把数据库整个锁了来备份，目的是得到一致性视图。MyISAM引擎不支持MVCC，所以可以用这个方法。</p>
<p><code>mysqldump --single-transaction</code>则能利用InnoDB的MVCC机制来得到一个一致性视图。<code>--single-transaction</code>方法只适用于所有的表使用事务引擎的库（InnoDB）。</p>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/mysql">#mysql</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>