<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheat sheet</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">使用Fluentd收集Docker容器日志</h1>
    
    <time>January 24, 2019</time>
    
    <div>
        <p>
        <p>本文介绍使用Fluentd收集standalone容器日志的方法。</p>
<p>Docker提供了很多<a href="https://docs.docker.com/config/containers/logging/configure/">logging driver</a>，默认情况下使用的<a href="https://docs.docker.com/config/containers/logging/json-file/">json-file</a>，它会把容器打到stdout/stderr的日志收集起来存到json文件中，<code>docker logs</code>所看到的日志就是来自于这些json文件。</p>
<p>当有多个docker host的时候你会希望能够把日志汇集起来，集中存放到一处，本文讲的是如何通过<a href="https://docs.docker.com/config/containers/logging/fluentd/">fluentd logging driver</a>配合<a href="https://docs.fluentd.org/v1.0/articles/quickstart">fluentd</a>来达成这一目标。</p>
<p>目标：</p>
<ol>
<li>将standalone容器打到stdout/stderror的日志收集起来</li>
<li>收集的日志根据容器名分开存储</li>
<li>日志文件根据每天滚动</li>
</ol>
<h2 id="第一步配置fluentd实例">第一步：配置Fluentd实例</h2>
<p>首先是配置文件<code>fluent.conf</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">&lt;source&gt;
  @type   forward
&lt;/source&gt;

# 处理docker service容器的日志
# input 
#   tag: busybox.2.sphii6yg9rw045kqi4kh6owxv
# output
#   file: busybox/inst-2.yyyy-MM-dd.log
&lt;match *.*.*&gt;
  @type              file
  path               /fluentd/log/${tag[0]}/inst-${tag[1]}
  append             true
  &lt;format&gt;
    @type            single_value
    message_key      log
  &lt;/format&gt;
  &lt;buffer tag,time&gt;
    @type             file
    timekey           1d
    timekey_wait      10m
    flush_mode        interval
    flush_interval    30s
  &lt;/buffer&gt;
&lt;/match&gt;

# 处理standalone容器的日志
# input 
#   tag: busybox
# output
#   file: busybox/busybox.yyyy-MM-dd.log
&lt;match *&gt;
  @type              file
  path               /fluentd/log/${tag}/${tag}
  append             true
  &lt;format&gt;
    @type            single_value
    message_key      log
  &lt;/format&gt;
  &lt;buffer tag,time&gt;
    @type             file
    timekey           1d
    timekey_wait      10m
    flush_mode        interval
    flush_interval    30s
  &lt;/buffer&gt;
&lt;/match&gt;
</code></pre></div><p>新建一个目录比如<code>/home/ubuntu/container-logs</code>，并赋予权限<code>chmod 777 /home/ubuntu/container-logs</code>。</p>
<p>然后启动Fluentd实例，这里使用的Docker方式：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -it <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -d <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -p 24224:24224 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -v /path/to/conf/fluent.conf:/fluentd/etc/fluent.conf <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -v /home/ubuntu/container-logs:/fluentd/log
  fluent/fluentd:v1.3
</code></pre></div><h2 id="第二步指定容器的logging-driver">第二步：指定容器的logging driver</h2>
<p>在启动容器的时候执行使用fluentd作为logging driver，下面以standalone容器举例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -d <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  ...
  --log-driver<span style="color:#f92672">=</span>fluentd <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --log-opt fluentd-address<span style="color:#f92672">=</span>&lt;fluentdhost&gt;:24224 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --log-opt mode<span style="color:#f92672">=</span>non-blocking <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --log-opt tag<span style="color:#f92672">={{</span>.Name<span style="color:#f92672">}}</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  &lt;image&gt;
</code></pre></div><p>注意上面的<code>--log-opt tag={{.Name}}</code>参数。</p>
<p>如果是docker compose / docker stack deploy部署，则在<code>docker-compose.yaml</code>中这样做 ：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">version</span>: <span style="color:#e6db74">&#34;3.7&#34;</span>
<span style="color:#66d9ef">x-logging</span>:
  <span style="color:#75715e">&amp;default-logging</span>
  <span style="color:#66d9ef">driver</span>: fluentd
  <span style="color:#66d9ef">options</span>:
    <span style="color:#66d9ef">fluentd-address</span>: &lt;fluentdhost&gt;:<span style="color:#ae81ff">24224</span>
    <span style="color:#66d9ef">fluentd-async-connect</span>: <span style="color:#e6db74">&#39;true&#39;</span>
    <span style="color:#66d9ef">mode</span>: non-blocking
    <span style="color:#66d9ef">max-buffer-size</span>: 4m
    <span style="color:#66d9ef">tag</span>: <span style="color:#e6db74">&#34;{{.Name}}&#34;</span>
<span style="color:#66d9ef">services</span>:
  <span style="color:#66d9ef">busybox</span>:
    <span style="color:#66d9ef">image</span>: busybox
    <span style="color:#66d9ef">logging</span>: <span style="color:#75715e">*default-logging</span>
</code></pre></div><h2 id="第三步观察日志">第三步：观察日志</h2>
<p>到<code>/home/ubuntu/container-logs</code>目录下能够看到类似这样的目录结构：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">.
└── &lt;container-name&gt;
    └── &lt;container-name&gt;.20190123.log
</code></pre></div><h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="https://docs.docker.com/config/containers/logging/configure/">Configure logging drivers</a></li>
<li><a href="https://docs.docker.com/config/containers/logging/log_tags/">Customize log driver output</a></li>
<li><a href="https://docs.docker.com/config/containers/logging/fluentd/">Use Fluentd logging driver</a></li>
<li><a href="https://docs.docker.com/engine/reference/commandline/run/">Docker CLI - run</a></li>
<li><a href="https://docs.fluentd.org/v1.0/articles/quickstart">Fluentd</a>
<ul>
<li><a href="https://docs.fluentd.org/v1.0/articles/out_file">Fluentd - out_file</a></li>
<li><a href="https://docs.fluentd.org/v1.0/articles/formatter_single_value">Fluentd - formatter_single_value</a></li>
<li><a href="https://docs.fluentd.org/v1.0/articles/buf_file">Fluentd - buf_file</a></li>
<li><a href="https://docs.fluentd.org/v1.0/articles/buffer-section">Fluentd - buffer</a></li>
</ul>
</li>
</ul>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/docker">#docker</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/%E8%BF%90%E7%BB%B4">#运维</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/fluentd">#fluentd</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/%E6%97%A5%E5%BF%97">#日志</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>