<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheat sheet</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">Prometheus range query中的step参数</h1>
    
    <time>December 28, 2018</time>
    
    <div>
        <p>
        <p>详细解释Prometheus range query中的step参数的作用。</p>
<p>Prometheus有两种query：<a href="https://prometheus.io/docs/prometheus/latest/querying/api/#instant-queries">instant query</a>、<a href="https://prometheus.io/docs/prometheus/latest/querying/api/#range-queries">range query</a>。本文要讲的就是range query中的step参数。</p>
<p>range query是非常常见的一种query，看看它有哪些参数：</p>
<ul>
<li><code>query=&lt;string&gt;</code>: PromQL表达式。</li>
<li><code>start=&lt;rfc3339 | unix_timestamp&gt;</code>: 时间范围的开始。</li>
<li><code>end=&lt;rfc3339 | unix_timestamp&gt;</code>: 时间范围的结束。</li>
<li><code>step=&lt;duration | float&gt;</code>: 查询解析度（query resolution）。</li>
<li><code>timeout=&lt;duration&gt;</code>: 执行超时。这个参数是可选的。</li>
</ul>
<p>在Prometheus expression browser里看到的是这样的：</p>
<p><img src="expression-browser-overview.png" alt="Expression Browser" style="zoom:50%" /></p>
<p>注意到上图中的Res框里没有给值，没有给的话Prometheus会自动给一个值，这个值在图示右上角可以看到。</p>
<h2 id="step对于查询结果的影响">step对于查询结果的影响</h2>
<p>Prometheues在对PromQL表达式求值的逻辑是这样的（详见这个<a href="https://github.com/prometheus/docs/issues/699#issuecomment-449703646">issue</a>里的回答）：</p>
<ol>
<li>对于[start, end]时间区间，从start开始，以step为长度，把时间区间分成若干段</li>
<li>对每个段进行求值</li>
</ol>
<p>举例：<code>start=10,end=20,step=2</code>，那么就会有<code>ts=10,ts=12,ts=14,ts=16,ts=18,ts=20</code>6段，然后为这6个段进行求值。求值方式视乎表达式中Time series selector的类型而定。</p>
<p>PromQL有两种Time series selector：<a href="https://prometheus.io/docs/prometheus/latest/querying/basics/#instant-vector-selectors">instant vector selector</a>和<a href="https://prometheus.io/docs/prometheus/latest/querying/basics/#range-vector-selectors">range vector selector</a>。下面将分别讲解：</p>
<h3 id="instant-vector-selector">Instant vector selector</h3>
<p>形如下面的就是Instant vector selector，<code>x</code>是metric的名字。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">x
</code></pre></div><p>Prometheus在对每段Instant vector selector求值的逻辑是这样的：</p>
<ul>
<li>从该段的timestamp（含）往前找，取第一个找到的data point的值。如果有一个data point的timestamp==该段的timestamp，则直接使用该data point。</li>
<li>如果该段timestamp往前的5分钟范围内没有找到任何data point，则该段无值。</li>
</ul>
<p>下面这张图解释了上面逻辑：</p>
<p><img src="graph/instant-vector-selector-1.png" alt="instant vector 1"></p>
<p>图中的绿点是Prometheus实际存储的数据，按照时间轴从左到右排列。蓝点是根据step参数的求值结果。</p>
<p>当data point间隔比step更大的时候会发生下图这种情况：</p>
<p><img src="graph/instant-vector-selector-2.png" alt="instant vector 2"></p>
<p>可以看到有两个段的求值结果来自于同一个data point。</p>
<h3 id="range-vector-selector">Range vector selector</h3>
<p>形如下面的就是Range vector selector，<code>x</code>是metric的名字，方括号里的是<code>range duration</code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">x<span style="color:#f92672">[</span>5m<span style="color:#f92672">]</span>
</code></pre></div><p>range vector select返回的是当前timestamp之前的<code>range duration</code>内的所有data point。range vector是不能直接用做绘图的，你得用某些function把range vector转换成instant vector才行，比如<a href="https://prometheus.io/docs/prometheus/latest/querying/functions/#rate">rate()</a>。</p>
<p>下图解释了是如何对Range vector selector进行分段求值的：</p>
<p><img src="graph/range-vector-selector.png" alt="range vector"></p>
<h3 id="step和rate-duration">step和rate duration</h3>
<p><code>step</code>和<code>range duration</code>是独立的两个参数，在某些情况下两者的值存在某种限制条件，这里例举<a href="https://prometheus.io/docs/prometheus/latest/querying/functions/#rate">rate()</a>来说明。<code>rate()</code>的作用是获得一个range-vector的每秒平均增长率。</p>
<p>如果<code>step=10m</code>而<code>range duration=5m</code>，那么<code>rate</code>在计算的时候会丢失一半的数据，两个分段之间的data point有一半没有被纳入计算。前面那张图就存在数据丢失的情况，有一个data point被漏掉了。</p>
<p>因此在使用<code>rate()</code>时，<code>range duration</code>得大于等于<code>step</code>。</p>
<p>而如果是<a href="https://prometheus.io/docs/prometheus/latest/querying/functions/#irate">irate()</a>，这个限制则是<code>range duration</code>不得大于<code>step</code>（详见<a href="https://www.youtube.com/watch?v=67Ulrq6DxwA&amp;feature=youtu.be&amp;t=1826">Brian Brazil的Presentation</a>）。</p>
<h3 id="grafana中的step参数">Grafana中的step参数</h3>
<p>在Grafana中并没有直接提供<code>step</code>参数，而是这两个参数：<code>min step</code>和<code>resolution</code>（<a href="http://docs.grafana.org/features/datasources/prometheus/#query-editor">文档在这里</a>)。<code>min step</code>故名思义设定的是<code>step</code>的最小值，那么<code>resolution</code>是什么呢？</p>
<p>大家都知道Grafana都是用来画图的，比如下面这张图Y轴是值，X轴则是时间线，因此在X轴方向的每个像素都代表了一个timestamp。</p>
<p><img src="grafana-graph.png" style="zoom:50%" /></p>
<p><code>resolution</code>就是用来根据像素来计算<code>step</code>的一个参数。下面用6个像素以及它们的timestamp来说明：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">x=1,ts=0; x=2,ts=5; x=3,ts=10; x=4,ts=15; x=5,ts=20; x=6,ts=25
</code></pre></div><ul>
<li><code>resolution=1/1</code>时，那么<code>step</code>就是相邻像素所代表的timestamp的差，即5；</li>
<li><code>resolution=1/2</code>时，那么<code>step</code>就是相隔1个像素的两个像素的timestamp的差，即10；</li>
<li><code>resolution=1/3</code>时，那么<code>step</code>就是相隔2个像素的两个像素的timestamp的差，即15；</li>
<li>以此类推</li>
</ul>
<p>而每个像素所代表的timestamp受两个因素影响：</p>
<ol>
<li>查询所定义的时间范围</li>
<li>Graph的宽度（单位：像素）</li>
</ol>
<p>所以在Grafana发起的查询中<code>step</code>参数是动态的。其实这也是很合理的，因为只有这样才能够在Graph宽度小的时候绘图更粗糙（即<code>step</code>更大），Graph宽度大的时候绘图更精细（即<code>step</code>更小，但是不能小于<code>min step</code>）。实际发起的请求的<code>step</code>参数你可以在Graph的Query Inspector里看到：</p>
<p><img src="grafana-query-inspector.png" style="zoom:50%" /></p>
<p>但是我们之前不说过了<code>rate()</code>的<code>range duration</code>不能小于<code>step</code>吗？那么把<code>range duration</code>给固定值的化就不太好了，怎么办呢？你可以使用Grafana提供的内置变量<code>$__interval</code>，它代表的Grafana就是计算出来的<code>step</code>的值。比如这样就能够将<code>range duration</code>和<code>step</code>保持一致了（更多内置变量可以见<a href="http://docs.grafana.org/features/datasources/prometheus/#using-interval-and-range-variables">这里</a>）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">rate(x[$__interval])
</code></pre></div><h2 id="所以你想自己实验一把">所以，你想自己实验一把</h2>
<p>如果你想自己动手实验，但是又苦于无法制造干净的假数据，那么可以参考<a href="../p8s-mock-data">这篇文章推荐的方法</a>。</p>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/prometheus">#prometheus</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>