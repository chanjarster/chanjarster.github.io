<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">数据库时区那些事儿 - MySQL的时区处理</h1>
    
    <time>September 17, 2018</time>
    
    <div>
        <p>
        <p>当JVM时区和数据库时区不一致的时候，会发生什么？这个问题也许你从来没有注意过，但是当把Java程序容器化的时候，问题就浮现出来了，因为目前几乎所有的Docker Image的时区都是UTC。本文探究了MySQL及其JDBC驱动对于时区的处理方式，并尝试给出最佳实践。</p>
<h2 id="先给总结">先给总结</h2>
<ul>
<li><code>DATE</code>和<code>TIME</code>类型不支持时区转换。</li>
<li>对于<code>TIMESTAMP</code>类型，MySQL会正确的根据connection时区（对于JDBC来说就是JVM时区）/服务端时区做转换。
<ul>
<li>JDBC程序不需要特别注意什么事情。只要保证JVM时区和用户所在时区保持一致即可。</li>
</ul>
</li>
<li>不要在服务器端做日期时间的字符串格式化（<code>DATE_FORMAT()</code>），因为返回的结果是服务端的时区，而不是connection的时区（对于JDBC来说就是JVM时区）。</li>
<li><code>CURRENT_TIMESTAMP()</code>, <code>CURRENT_TIME()</code>, <code>CURRENT_DATE()</code>可以安全的使用，返回的结果会转换成connection时区（对于JDBC来说就是JVM时区）。</li>
<li><code>CURRENT_TIME()</code>有一个不知道是不是BUG的<a href="https://bugs.mysql.com/bug.php?id=92453">Bug #92453</a>。</li>
</ul>
<h2 id="日期时间类型的时区">日期时间类型的时区</h2>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/datetime.html">MySQL - The DATE, DATETIME, and TIMESTAMP Types</a>：</p>
<blockquote>
<p>MySQL converts <code>TIMESTAMP</code> values from the current time zone to UTC for storage, and back from UTC to the
current time zone for retrieval. (This does not occur for other types such as <code>DATETIME</code>.)
By default, the current time zone for each connection is the server&rsquo;s time. The time zone can be set on
a per-connection basis.
As long as the time zone setting remains constant, you get back the same value you store.
If you store a <code>TIMESTAMP</code> value, and then change the time zone and retrieve the value, the retrieved value
is different from the value you stored. This occurs because the same time zone was not used for conversion
in both directions.</p>
</blockquote>
<p>简而言之就是两句话：</p>
<ol>
<li>查询<code>TIMESTAMP</code>类型所返回的值，会根据connection的时区（对于JDBC来说就是JVM时区）做转换</li>
<li>在MySQL中只有<code>TIMESTAMP</code>类型会做时区转换</li>
</ol>
<p>为了验证这个结论，我写了一段程序来实验，这个程序做了三件事情：</p>
<ol>
<li>使用<code>Asia/Shanghai</code>时区构造一个日期<code>java.util.Date</code>：<code>2018-09-14 10:00:00</code>，然后插入到数据库里（表：test，列：timestamp类型）</li>
<li>使用<code>Asia/Shanghai</code>时区把这个值再查出来，看看结果。</li>
<li>使用<code>Asia/Shanghai</code>时区，获得这个字段的格式化字符串（使用<code>DATE_FORMAT()</code>函数）。</li>
<li>使用<code>Europe/Paris</code>时区重复第2-3步的动作</li>
</ol>
<p>在运行程序之前，我们先用Docker启动一个MySQL，它所在的MySQL的时区是UTC（除非特别设定，所有Docker Image时区都默认为UTC）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run --name mysql-timezone-test <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -e MYSQL_RANDOM_ROOT_PASSWORD<span style="color:#f92672">=</span>yes <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -e MYSQL_DATABASE<span style="color:#f92672">=</span>testdb <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -e MYSQL_USER<span style="color:#f92672">=</span>tz <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -e MYSQL_PASSWORD<span style="color:#f92672">=</span>tz <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -p 3306:3306 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -d mysql:8
</code></pre></div><p>下面是结果：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">Insert data, Time Zone        : 中国标准时间
java.util.Date                : 2018-09-14 10:00:00
Insert into timestamp column  : 2018-09-14 10:00:00
--------------------
Retrieve data, Time Zone      : 中国标准时间
Retrieve java.util.Date       : 2018-09-14 10:00:00
Retrieve formatted string     : 2018-09-14 02:00:00
--------------------
Retrieve data, Time Zone      : 中欧时间
Retrieve java.util.Date       : 2018-09-14 04:00:00
Retrieve formatted string     : 2018-09-14 02:00:00
</code></pre></div><p>可以看到<code>Retrieve java.util.Date</code>返回的结果根据JVM时区做了转换的。而<code>Retrieve formatted string</code>返回的结果则是UTC时间。</p>
<h2 id="当前日期时间相关函数">当前日期时间相关函数</h2>
<p>MySQL与&quot;当前日期时间&quot;相关的函数有这么些，<a href="https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html">MySQL - Date and Time Functions</a>：</p>
<blockquote>
<p>The <code>CURRENT_TIMESTAMP()</code>, <code>CURRENT_TIME()</code>, <code>CURRENT_DATE()</code>, and <code>FROM_UNIXTIME()</code> functions return values
in the connection&rsquo;s current time zone, which is available as the value of the time_zone system variable.</p>
</blockquote>
<p>而且根据文档所讲，它们返回的结果匹配当前连接所设定的时区。</p>
<p>为了验证这个结论，同样写了一段程序，分别使用<code>Asia/Shanghai</code>和<code>Europe/Paris</code>来调用<code>CURRENT_TIMESTAMP()</code>、<code>CURRENT_TIME()</code>、<code>CURRENT_DATE()</code>。</p>
<p>下面是运行结果：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">JVM Time Zone              : 中国标准时间
Test CURRENT_DATE()        : 2018-09-18
Test CURRENT_TIME()        : 10:55:41
Test CURRENT_TIMESTAMP()   : 2018-09-18 10:55:41.0
--------------------
JVM Time Zone              : 中欧时间
Test CURRENT_DATE()        : 2018-09-18
Test CURRENT_TIME()        : 03:56:02
Test CURRENT_TIMESTAMP()   : 2018-09-18 04:56:02.0
</code></pre></div><p>可以看到结果是基本符合文档里的说明的，但是要注意，在<code>Europe/Paris</code>时区，<code>CURRENT_TIME()</code>和<code>CURRENT_TIMESTAMP()</code>的时间部分相差一小时。
看上去<code>CURRENT_TIMESTAMP()</code>返回的是UTC DST offset结果，而<code>CURRENT_TIME()</code>返回的是UTC offset结果，关于这个我登记了<a href="https://bugs.mysql.com/bug.php?id=92453">Bug #92453</a>。
关于<code>Europe/Paris</code>的DST信息可以在这里找到<a href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones">Wiki - List of tz database time zones</a>。</p>
<h2 id="在mysql客户端操作时区">在MySQL客户端操作时区</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#75715e">-- 查询系统时区和session时区
</span><span style="color:#75715e"></span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">@@</span><span style="color:#66d9ef">global</span>.time_zone, <span style="color:#f92672">@@</span><span style="color:#66d9ef">session</span>.time_zone;

<span style="color:#75715e">-- 设置session时区
</span><span style="color:#75715e"></span><span style="color:#66d9ef">SET</span> time_zone <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Asia/Shanghai&#39;</span>;
</code></pre></div><p>详见：<a href="https://dev.mysql.com/doc/refman/8.0/en/time-zone-support.html">MySQL Server Time Zone Support</a></p>
<h2 id="docker启动时设定时区">Docker启动时设定时区</h2>
<p><!-- raw HTML omitted -->你可以在docker启动的时候设定MySQL容器的时区，比如这样<code>-e TZ=Asia/Shanghai</code>。<!-- raw HTML omitted --></p>
<p>这个方法有问题，会出现时间错乱，workaround是root用户连接到MySQL，然后执行<code>SET GLOBAL time_zone = 'Asia/Shanghai';</code>。</p>
<p>这样客户端（非JDBC）连接MySQL时，查询的时间的时区都是<code>Asia/Shanghai</code>了。</p>
<h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/datetime.html">MySQL - The DATE, DATETIME, and TIMESTAMP Types</a></li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html">MySQL - Date and Time Functions</a></li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/time-zone-support.html">MySQL Server Time Zone Support</a></li>
<li><a href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones">Wiki - List of tz database time zones</a></li>
<li><a href="https://www.w3.org/TR/timezone/">W3C- Working with timezone</a></li>
</ul>
<h2 id="相关代码">相关代码</h2>
<p><a href="https://github.com/chanjarster/jdbc-timezone">https://github.com/chanjarster/jdbc-timezone</a></p>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/jdbc">#JDBC</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/mysql">#MySQL</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%97%B6%E5%8C%BA%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF">#数据库时区那些事儿</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>