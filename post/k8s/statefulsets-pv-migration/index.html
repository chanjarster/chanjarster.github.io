<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>StatefulSets迁移PV的方法 | 颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.fb0741ac272e7c9bef84b235a2f86925ce49db17e728cfc0e73fa00ec39c73ee.css"/>

    
    
    

    
    
 
    </head>

    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>

  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheatsheet</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/troubleshooting/">排障实战记录</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

    

    

    

</div>




    <p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
    <p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>

</nav>

        <div id="content" class="content-container">
        

<h1 class="post-title">StatefulSets迁移PV的方法</h1>
    
    <time>December 9, 2019</time>
    
    <div>
        <p>
        <p>先说说场景，你有一个StatefulSets，通过<code>volumeClaimTemplate</code>创建了PVC。现在这些PVC所关联的PV对你来说不够用了，你希望能够使用更大的PVC。</p>
<p>大致步骤如下：</p>
<ol>
<li>先把StatefulSets的Yaml备份下来。</li>
<li>利用busybox复制数据。</li>
<li>使用新PVC。</li>
<li>清理PVC。</li>
</ol>
<p>下面是详细步骤：</p>
<h2 id="备份statefulsets">备份StatefulSets</h2>
<p>把StatefulSets的Yaml备份下来，下面是代码片段，注意volumeClaimTemplate和volumeMounts部分：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">zookeeper</span>
  <span style="color:#75715e"># ...</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#75715e"># ...</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#75715e"># ...</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">ranchercharts/confluentinc-cp-zookeeper:5.3.0</span>
        <span style="color:#75715e"># ...</span>
        <span style="color:#f92672">volumeMounts</span>:
        - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/lib/zookeeper/data</span>
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">datadir</span>
  <span style="color:#75715e"># ...</span>
  <span style="color:#f92672">volumeClaimTemplates</span>:
  - <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">datadir</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">accessModes</span>:
      - <span style="color:#ae81ff">ReadWriteOnce</span>
      <span style="color:#f92672">resources</span>:
        <span style="color:#f92672">requests</span>:
          <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">5Gi</span>
      <span style="color:#f92672">volumeMode</span>: <span style="color:#ae81ff">Filesystem</span>
</code></pre></div><p>然后删掉它，删掉StatefulSets不会删除对应的PVC。</p>
<h2 id="复制数据">复制数据</h2>
<p>StatefulSets的volumeClaimTemplate所生成的PVC的名字是这样的格式：<code>{volume-name}-{statefulsets-name}-数字</code>，比如<code>datadir-zookeeper-0</code>。</p>
<p>所以我们可以创建一个busybox StatefulSets，名字也是zookeeper，并且它的volumeClaimTemplate和原来的一样，这样它就可以使用旧PVC了。同时它还得创建一个新的volumeClaimTemplate来创建新的PVC。</p>
<p>注意replicas得和原来的一样。</p>
<p>下面是例子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">zookeeper</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">podManagementPolicy</span>: <span style="color:#ae81ff">OrderedReady</span>
  <span style="color:#75715e"># 得和原来的一样</span>
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">busybox-pvc-migration</span>
  <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">portal-cp-zookeeper</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">busybox-pvc-migration</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox</span>
        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">Always</span>
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">zookeeper</span>
        <span style="color:#f92672">stdin</span>: <span style="color:#66d9ef">true</span>
        <span style="color:#f92672">tty</span>: <span style="color:#66d9ef">true</span>
        <span style="color:#f92672">volumeMounts</span>:
        <span style="color:#75715e"># 旧PVC</span>
        - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/datadir-old</span>
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">datadir</span>
        <span style="color:#75715e"># 新PVC</span>
        - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/datadir-new</span>
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">datadir-new</span>
      <span style="color:#f92672">dnsPolicy</span>: <span style="color:#ae81ff">ClusterFirst</span>
      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Always</span>
  <span style="color:#f92672">updateStrategy</span>:
    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span>
  <span style="color:#f92672">volumeClaimTemplates</span>:
  <span style="color:#75715e"># 旧claim</span>
  - <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">datadir</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">accessModes</span>:
      - <span style="color:#ae81ff">ReadWriteOnce</span>
      <span style="color:#f92672">resources</span>:
        <span style="color:#f92672">requests</span>:
          <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">5Gi</span>
      <span style="color:#f92672">volumeMode</span>: <span style="color:#ae81ff">Filesystem</span>
   <span style="color:#75715e"># 新claim</span>
  - <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">datadir-new</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">accessModes</span>:
      - <span style="color:#ae81ff">ReadWriteOnce</span>
      <span style="color:#f92672">resources</span>:
        <span style="color:#f92672">requests</span>:
          <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">10Gi</span>
      <span style="color:#f92672">volumeMode</span>: <span style="color:#ae81ff">Filesystem</span>
</code></pre></div><p>进入每个busybox的shell，复制旧PVC的内容到新的PVC：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cp -r /datadir-old/* /datadir-new/
</code></pre></div><p>复制完之后注意检查一下文件的权限和所属用户与用户组。</p>
<p>最后删除busybox。同理，它所新建的PVC也不会被删除，这些PVC后面要被使用。</p>
<h2 id="使用新pvc">使用新PVC</h2>
<p>修改之前备份下来的Yaml，让它使用新的PVC，修改volumeClaimTemplate和volumeMounts部分：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StatefulSet</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">zookeeper</span>
  <span style="color:#75715e"># ...</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#75715e"># ...</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#75715e"># ...</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">ranchercharts/confluentinc-cp-zookeeper:5.3.0</span>
        <span style="color:#75715e"># ...</span>
        <span style="color:#f92672">volumeMounts</span>:
        - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/lib/zookeeper/data</span>
          <span style="color:#75715e"># 使用了新的PVC</span>
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">datadir-new</span>
  <span style="color:#75715e"># ...</span>
  <span style="color:#f92672">volumeClaimTemplates</span>:
  - <span style="color:#f92672">metadata</span>:
      <span style="color:#75715e"># 使用了新的PVC</span>
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">datadir-new</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">accessModes</span>:
      - <span style="color:#ae81ff">ReadWriteOnce</span>
      <span style="color:#f92672">resources</span>:
        <span style="color:#f92672">requests</span>:
          <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">10Gi</span>
      <span style="color:#f92672">volumeMode</span>: <span style="color:#ae81ff">Filesystem</span>
</code></pre></div><h2 id="清理pvc">清理PVC</h2>
<p>确认没有问题后，可以清理掉旧的PVC。</p>
        </p>
    </div>
    

    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/k8s">#k8s</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

    

    

    

</div>




	<div class="footer-mobile-links">
        <p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
        <p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>

    </body>
</html>