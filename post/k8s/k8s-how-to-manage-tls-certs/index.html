<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheatsheet</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/troubleshooting/">排障实战记录</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">K8S中的TLS证书管理方案</h1>
    
    <time>September 4, 2019</time>
    
    <div>
        <p>
        <p>本文介绍几种在K8S中管理TLS证书的方案。</p>
<h2 id="证书申请方案">证书申请方案</h2>
<p>先看如何申请证书。</p>
<h3 id="cert-manager">cert-manager</h3>
<p><a href="https://docs.cert-manager.io/en/latest">cert-manager</a>是一个集成在k8s中的工具，它可以做到自动从Let&rsquo;s encrypt申请证书、自动更新证书、与Ingress无缝结合。</p>
<p>大多数情况下建议与Ingress集成的方式使用它，后面会讲。如果你仅需要签发功能，不需要和Ingress集成，则可参考<a href="http://docs.cert-manager.io/en/latest/tasks/issuers/index.html">Setting up Issuers</a>和<a href="http://docs.cert-manager.io/en/latest/tasks/issuing-certificates/index.html">Issuing Certificates</a>。</p>
<p>优点：</p>
<ol>
<li>自动签发</li>
<li>自动续期</li>
<li>与K8S集成良好</li>
<li>免费</li>
</ol>
<p>缺点：</p>
<ol>
<li>只能签发Server Auth证书，不能签发Client Auth证书</li>
<li>证书仅用做认证，没有商业版证书更高级的功能</li>
</ol>
<h3 id="阿里云平台购买">阿里云平台购买</h3>
<p>比如你可以在阿里云上<a href="https://www.aliyun.com/product/cas">购买SSL证书</a>，一个账号的<a href="https://help.aliyun.com/document_detail/90792.html">最多申请100个证书</a></p>
<p>优点：</p>
<ol>
<li>多种类型证书可以供选择，有免费的有收费的</li>
<li>可在平台上管理</li>
<li>申请的证书可用在其他产品上，比如SLB</li>
</ol>
<p>缺点：</p>
<ol>
<li>与K8S集成不好，需要手动导入到Secret中才能使用</li>
<li>只能签发Server Auth证书，不能签发Client Auth证书</li>
</ol>
<h3 id="用cfssl自签发">用CFSSL自签发</h3>
<p>你可以使用CFSSL自签发证书，有一篇<a href="https://github.com/chanjarster/tls-client-auth-samples/blob/master/certs/index.md">参考文档</a>。</p>
<p>优点：</p>
<ol>
<li>可签发Client Auth证书</li>
</ol>
<p>缺点：</p>
<ol>
<li>手动管理证书</li>
<li>与K8S集成不好，需要手动导入到Secret中才能使用</li>
<li>自签发的Server Auth证书在浏览器端会报警告</li>
</ol>
<h3 id="总结">总结</h3>
<p>对于Server Auth证书：</p>
<ul>
<li>如果只是开发或者演示环境，cert-manager方案更适合你</li>
<li>如果是生产环境或者对证书有更高要求的，可以采用从平台购买的方案</li>
</ul>
<p>对于Client Auth证书：</p>
<ul>
<li>你只能选择用CFSSL自签发的方式</li>
</ul>
<h2 id="证书部署方案">证书部署方案</h2>
<p>下面介绍几种部署方案。</p>
<h3 id="部署在阿里云slb上">部署在阿里云SLB上</h3>
<p>虽然本小节讲的是部署在阿里云的SLB的产品上，但是它的思路和优缺点在其他云平台上基本是一致的。</p>
<p>做法是在SLB上<a href="https://help.aliyun.com/document_detail/86438.html">配置HTTPS监听</a>，ACK（阿里云Kubernetes）在创建集群的时候会自动创建几个SLB实例，不要在这几个实例上配置HTTPS监听，因为在ACK中创建Type=LoadBalancer的Service的时候<a href="https://help.aliyun.com/document_detail/86531.html">会把你做的配置刷新掉</a>。</p>
<p>支持：</p>
<ol>
<li>Server Auth</li>
<li>Client Auth</li>
</ol>
<p>优点：</p>
<ol>
<li>可利用阿里云的SSL证书管理功能</li>
<li>可用在阿里云的其他产品上，比如ECS</li>
</ol>
<p>缺点：</p>
<ol>
<li>
<p>不支持SNI，如果你有多个域名，因为一个SLB只会有一个公网IP，此时你就有两种选择：</p>
<ul>
<li>
<p>在一个SLB上配置多个监听端口，这样URL中就会携带端口</p>
</li>
<li>
<p>配置多个SLB，避免前面一个方案的问题</p>
</li>
</ul>
</li>
<li>
<p>要自己手动配置服务器组之类的信息</p>
</li>
<li>
<p>K8S Service类型得是Node Port，意味着在同一VPC子网内部流量不受保护</p>
</li>
<li>
<p>K8S集群内部流量不受保护</p>
</li>
</ol>
<h3 id="loadbalancer-service">LoadBalancer Service</h3>
<p><a href="https://help.aliyun.com/document_detail/86531.html">创建Type=LoadBalancer的Service</a>来暴露服务，然后在Deployment/StatefulSets里部署证书。</p>
<p>支持：</p>
<ol>
<li>Server Auth</li>
<li>Client Auth</li>
</ol>
<p>优点：</p>
<ol>
<li>集群内部流量受保护</li>
<li>VPC子网内部流量受保护</li>
</ol>
<p>缺点：</p>
<ol>
<li>不支持SNI，而且因为你只可能有一个公网IP，因此URL中必定要携带端口</li>
<li>在应用中配置证书，且方式方法与应用所使用<a href="https://github.com/chanjarster/tls-client-auth-samples">架构/类库</a>有关</li>
</ol>
<h3 id="ingress配合cert-manager">Ingress配合cert-manager</h3>
<p>前面说过cert-manager支持与Ingress集成，你很少的工作能够配置Server Auth，和一个稍微复杂一点的步骤配置Client Auth，详情可参考<a href="https://github.com/chanjarster/tls-client-auth-samples/blob/master/server/ingress-nginx/index.md">这篇文章</a>。</p>
<p>支持：</p>
<ol>
<li>TLS Server Auth</li>
<li>TLS Client Auth</li>
<li>SNI，即一个443端口对应多个域名</li>
</ol>
<p>优点：</p>
<ol>
<li>Server Auth证书自动签发、自动续期</li>
<li>Client Auth手动配置</li>
<li>对应用的侵入性为0</li>
</ol>
<p>缺点：</p>
<ol>
<li>集群内部流量不受保护，这个问题可以通过Network Policy做namespace隔离来缓解</li>
</ol>
<h3 id="总结-1">总结</h3>
<p>优先考虑Ingress配合cert-manager的方案。</p>
<p>如果你对安全性有很高的要求，那么考虑LoadBalancer Service。</p>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/k8s">#k8s</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/tls">#tls</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>