<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheatsheet</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">使用code-generator编写CRD</h1>
    
    <time>June 30, 2020</time>
    
    <div>
        <p>
        <p>使用<a href="https://github.com/kubernetes/code-generator">k8s.io/code-generator</a>编写CRD。</p>
<p>本项目代码在 <a href="https://github.com/chanjarster/k8s-code-gen-how-to">https://github.com/chanjarster/k8s-code-gen-how-to</a></p>
<h2 id="概览">概览</h2>
<p><a href="https://github.com/kubernetes/code-generator">k8s.io/code-generator</a>是一个代码生成工具，用于为你的CRD生成<a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md">kubernetes-style API</a>实现，这样你就可以管理K8S上你的自定义CRD资源了。</p>
<h2 id="第一步初始化项目">第一步：初始化项目</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">MODULE<span style="color:#f92672">=</span>example.com/foo-controller
go mod init $MODULE
</code></pre></div><h2 id="第二步定义api">第二步：定义API</h2>
<p>新建目录<code>api/&lt;group&gt;/&lt;version&gt;</code>，这个目录下得有以下几个文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">.
└── api
    └── foo
    └── v1alpha1
        ├── doc.go
        ├── register.go
        └── types.go
</code></pre></div><p>执行命令：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">GROUP<span style="color:#f92672">=</span>foo
VERSION<span style="color:#f92672">=</span>v1alpha1
mkdir -p api/$GROUP/$VERSION
</code></pre></div><p>编写文件<code>api/&lt;group&gt;/&lt;version&gt;/doc.go</code>，注意<code>//+groupName=foo.example.com</code>，你需要视情况修改：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// +k8s:deepcopy-gen=package
</span><span style="color:#75715e">// +groupName=foo.example.com
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Package v1alpha1 is the v1alpha1 version of the API.
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">v1alpha1</span>
</code></pre></div><p>编写文件<code>api/&lt;group&gt;/&lt;version&gt;/types.go</code>，注意视情况修改类名以及相关常量，<code>Status</code>字段并非必须的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">v1alpha1</span>

<span style="color:#f92672">import</span> (
	<span style="color:#a6e22e">metav1</span> <span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
)

<span style="color:#75715e">// These const variables are used in our custom controller.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> (
	<span style="color:#a6e22e">GroupName</span> <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;foo.example.com&#34;</span>
	<span style="color:#a6e22e">Kind</span>      <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;Foo&#34;</span>
	<span style="color:#a6e22e">Version</span>   <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;v1alpha1&#34;</span>
	<span style="color:#a6e22e">Plural</span>    <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;foos&#34;</span>
	<span style="color:#a6e22e">Singluar</span>  <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;foo&#34;</span>
	<span style="color:#a6e22e">ShortName</span> <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;foo&#34;</span>
	<span style="color:#a6e22e">Name</span>      <span style="color:#66d9ef">string</span> = <span style="color:#a6e22e">Plural</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">GroupName</span>
)

<span style="color:#75715e">// +genclient
</span><span style="color:#75715e">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Foo is a specification for a Foo resource
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Foo</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">TypeMeta</span>   <span style="color:#e6db74">`json:&#34;,inline&#34;`</span>
	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span> <span style="color:#e6db74">`json:&#34;metadata,omitempty&#34;`</span>

	<span style="color:#a6e22e">Spec</span>   <span style="color:#a6e22e">FooSpec</span>   <span style="color:#e6db74">`json:&#34;spec&#34;`</span>
	<span style="color:#a6e22e">Status</span> <span style="color:#a6e22e">FooStatus</span> <span style="color:#e6db74">`json:&#34;status&#34;`</span>
}

<span style="color:#75715e">// FooSpec is the spec for a Foo resource
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FooSpec</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">DeploymentName</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;deploymentName&#34;`</span>
	<span style="color:#a6e22e">Replicas</span>       <span style="color:#f92672">*</span><span style="color:#66d9ef">int32</span> <span style="color:#e6db74">`json:&#34;replicas&#34;`</span>
}

<span style="color:#75715e">// FooStatus is the status for a Foo resource
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FooStatus</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">AvailableReplicas</span> <span style="color:#66d9ef">int32</span> <span style="color:#e6db74">`json:&#34;availableReplicas&#34;`</span>
}

<span style="color:#75715e">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// FooList is a list of Foo resources
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FooList</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">TypeMeta</span> <span style="color:#e6db74">`json:&#34;,inline&#34;`</span>
	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListMeta</span> <span style="color:#e6db74">`json:&#34;metadata&#34;`</span>

	<span style="color:#a6e22e">Items</span> []<span style="color:#a6e22e">Foo</span> <span style="color:#e6db74">`json:&#34;items&#34;`</span>
}
</code></pre></div><p>编写文件<code>api/&lt;group&gt;/register.go</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">v1alpha1</span>

<span style="color:#f92672">import</span> (
	<span style="color:#a6e22e">metav1</span> <span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
	<span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
	<span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
)

<span style="color:#66d9ef">var</span> (
	<span style="color:#75715e">// SchemeBuilder initializes a scheme builder
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SchemeBuilder</span> = <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">NewSchemeBuilder</span>(<span style="color:#a6e22e">addKnownTypes</span>)
	<span style="color:#75715e">// AddToScheme is a global function that registers this API group &amp; version to a scheme
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">AddToScheme</span> = <span style="color:#a6e22e">SchemeBuilder</span>.<span style="color:#a6e22e">AddToScheme</span>
)

<span style="color:#75715e">// SchemeGroupVersion is group version used to register these objects.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">SchemeGroupVersion</span> = <span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupVersion</span>{
	<span style="color:#a6e22e">Group</span>:   <span style="color:#a6e22e">GroupName</span>,
	<span style="color:#a6e22e">Version</span>: <span style="color:#a6e22e">Version</span>,
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Resource</span>(<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupResource</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">SchemeGroupVersion</span>.<span style="color:#a6e22e">WithResource</span>(<span style="color:#a6e22e">resource</span>).<span style="color:#a6e22e">GroupResource</span>()
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">addKnownTypes</span>(<span style="color:#a6e22e">scheme</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Scheme</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">scheme</span>.<span style="color:#a6e22e">AddKnownTypes</span>(<span style="color:#a6e22e">SchemeGroupVersion</span>,
		<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Foo</span>{},
		<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">FooList</span>{},
	)
	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">AddToGroupVersion</span>(<span style="color:#a6e22e">scheme</span>, <span style="color:#a6e22e">SchemeGroupVersion</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>然后添加依赖：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">K8S_VERSION<span style="color:#f92672">=</span>v0.18.5
go get k8s.io/apimachinery@$K8S_VERSION
</code></pre></div><h2 id="第三步代码生成">第三步：代码生成</h2>
<h3 id="1准备脚本">1）准备脚本</h3>
<p>新建目录hack，我们需要在hack目录下有以下几个文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">.
└── hack
    ├── boilerplate.go.txt
    ├── tools.go
    ├── update-codegen.sh
    └── verify-codegen.sh
</code></pre></div><p>执行命令：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir hack
touch hack/boilerplate.go.txt
</code></pre></div><p>新建<code>hack/tools.go</code>文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// +build tools
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">tools</span>

<span style="color:#f92672">import</span> <span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;k8s.io/code-generator&#34;</span>
</code></pre></div><p>新建<code>hack/update-codegen.sh</code>，注意修改几个变量：</p>
<ul>
<li><code>MODULE</code>和<code>go.mod</code>保持一致</li>
<li><code>API_PKG=api</code>，和我们的目录保持一致</li>
<li><code>OUTPUT_PKG</code></li>
<li><code>GROUP_VERSION=foo.v1alpha1</code>而不是<code>foo.example.com:v1alpha1</code>，因为code generator会读取我们之前写的<code>api/&lt;group&gt;/&lt;version&gt;</code>下的代码，因此得要对应上这个路径：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/usr/bin/env bash
</span><span style="color:#75715e"></span>
set -o errexit
set -o nounset
set -o pipefail

<span style="color:#75715e"># corresponding to go mod init &lt;module&gt;</span>
MODULE<span style="color:#f92672">=</span>example.com/foo-controller
<span style="color:#75715e"># api package</span>
APIS_PKG<span style="color:#f92672">=</span>api
<span style="color:#75715e"># generated output package</span>
OUTPUT_PKG<span style="color:#f92672">=</span>generated
<span style="color:#75715e"># group-version such as foo:v1alpha1</span>
GROUP_VERSION<span style="color:#f92672">=</span>foo:v1alpha1

SCRIPT_ROOT<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>dirname <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BASH_SOURCE[0]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span>/..
CODEGEN_PKG<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CODEGEN_PKG<span style="color:#66d9ef">:-$(</span>cd <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SCRIPT_ROOT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>; ls -d -1 ./vendor/k8s.io/code-generator 2&gt;/dev/null <span style="color:#f92672">||</span> echo ../code-generator<span style="color:#66d9ef">)</span><span style="color:#e6db74">}</span>

<span style="color:#75715e"># generate the code with:</span>
<span style="color:#75715e"># --output-base    because this script should also be able to run inside the vendor dir of</span>
<span style="color:#75715e">#                  k8s.io/kubernetes. The output-base is needed for the generators to output into the vendor dir</span>
<span style="color:#75715e">#                  instead of the $GOPATH directly. For normal projects this can be dropped.</span>
bash <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>CODEGEN_PKG<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>/generate-groups.sh <span style="color:#e6db74">&#34;all&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">${</span>MODULE<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>OUTPUT_PKG<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>MODULE<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>APIS_PKG<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">${</span>GROUP_VERSION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --go-header-file <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SCRIPT_ROOT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>/hack/boilerplate.go.txt <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --output-base <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SCRIPT_ROOT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
<span style="color:#75715e">#  --output-base &#34;$(dirname &#34;${BASH_SOURCE[0]}&#34;)/../../..&#34; \</span>

<span style="color:#75715e"># To use your own boilerplate text append:</span>
<span style="color:#75715e">#   --go-header-file &#34;${SCRIPT_ROOT}&#34;/hack/custom-boilerplate.go.txt</span>
</code></pre></div><p>新建<code>hack/verify-codegen.sh</code>（文件内容请看github项目）。</p>
<h3 id="2下载code-generator">2）下载code-generator</h3>
<p>先把<a href="https://pkg.go.dev/mod/k8s.io/code-generator?tab=overview">code-generator</a>下载下来，注意这里的K8S版本号，得和前面是一致的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">K8S_VERSION<span style="color:#f92672">=</span>v0.18.5
go get k8s.io/code-generator@$K8S_VERSION
go mod vendor
</code></pre></div><p>然后给<code>generate-groups.sh</code>添加可执行权限：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chmod +x vendor/k8s.io/code-generator/generate-groups.sh
</code></pre></div><h3 id="3生成代码">3）生成代码</h3>
<p>执行<code>hack/update-codegen.sh</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./hack/update-codegen.sh
</code></pre></div><p>代码会生成在<code>example.com/foo-controller</code>目录下（回忆前面的<code>MODULE=example.com/foo-controller</code>和<code>OUTPUT_PKG=generated</code>参数）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">example.com
└── foo-controller
    ├── api
    │   └── foo
    │       └── v1alpha1
    │           └── zz_generated.deepcopy.go
    └── generated
        ├── clientset
        ├── informers
        └── listers
</code></pre></div><p>移动文件：</p>
<ul>
<li><code>zz_generated.deepcopy.go</code>移动到<code>api/&lt;group&gt;/&lt;version&gt;</code>下</li>
<li><code>example.com/foo-controller/generated</code>直接移出来，放到项目根下面<code>generated</code></li>
<li>如果后面你修改了<code>types.go</code>，重新执行<code>./hack/update-codegen.sh</code>就行了。</li>
</ul>
<p>对于生成代码的说明：</p>
<ul>
<li><code>clientset</code>：用于操作<code>foos.foo.example.com</code>CRD资源</li>
<li><code>informers</code>：Informer接收来自服务器的CRD的变更事件</li>
<li><code>listers</code>：Lister提供只读的cache layer for GET和LIST请求</li>
</ul>
<h2 id="关于controller">关于Controller</h2>
<p>controller代码可以看项目的<a href="https://github.com/chanjarster/k8s-code-gen-how-to/blob/master/main.go">main.go</a>。</p>
<p>本例子里controller读取环境变量<code>KUBECONFIG</code>来启动Clientset以及和K8S通信，这个也符合<a href="https://github.com/kubernetes/client-go/blob/master/examples/out-of-cluster-client-configuration">k8s.io/client-go out-of-cluster example</a>。在实际生产环境中，可以参考<a href="https://github.com/kubernetes/client-go/blob/master/examples/in-cluster-client-configuration">k8s.io/client-go in-cluster example</a>。</p>
<p>如果你想要更灵活的做法，比如当提供了<code>--kubeconfig</code>的时候采用out-of-cluster模式，否则则尝试in-cluster模式（看<code>/var/run/secrets/kubernetes.io/serviceaccount</code>），可以参考<a href="https://github.com/coreos/prometheus-operator/blob/v0.40.0/pkg/k8sutil/k8sutil.go#L61-L95">prometheus-operator k8sutil.go</a>的做法</p>
<h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="https://www.openshift.com/blog/kubernetes-deep-dive-code-generation-customresources">Kubernetes Deep Dive: Code Generation for CustomResources</a></li>
<li><a href="https://insujang.github.io/2020-02-13/programming-kubernetes-crd/">Programming Kubernetes CRDs</a></li>
<li><a href="https://github.com/kubernetes/sample-controller">Sample Controller</a></li>
<li><a href="https://github.com/kubernetes/code-generator">code-generator</a></li>
<li><a href="https://github.com/kubernetes/client-go">client-go</a></li>
<li><a href="https://github.com/kubernetes/code-generator/tree/master/cmd/client-gen">client-gen tag docs</a></li>
</ul>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/k8s">#k8s</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>