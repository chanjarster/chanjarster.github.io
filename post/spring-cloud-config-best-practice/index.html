<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">Spring Cloud Config配置文件最佳实践</h1>
    
    <time>September 10, 2018</time>
    
    <div>
        <p>
        <p>大多数Spring Cloud项目都会使用Spring Cloud Config来管理应用启动时的配置文件，同时开发人员面临着多样化的程序启动方式：操作系统进程启动、docker启动、k8s启动。那么如何规划这些配置文件以适应多种启动方式呢？本文尝试给出一些建议</p>
<h2 id="先讲几个规则">先讲几个规则</h2>
<ol>
<li>程序打包时，要将<code>bootstrap.properties</code>和<code>application.properties</code>（或者它们的yaml变种）打到包里。</li>
<li><code>bootstrap.properties</code>里，要针对可变配置项做环境变量化。</li>
<li><code>application.properties</code>里，要针对可变配置项做环境变量化。</li>
<li>Spring Cloud应用关于Config Server的配置要放在<code>bootstrap.properties</code>里，并且要做环境变量化。</li>
<li>Config Server所提供的<code>application-*.properties</code>里不得有环境变量。因为既然直接提供配置了，那么就不应该再使用环境变量。</li>
</ol>
<h3 id="要针对可变配置项做环境变量化">要针对可变配置项做环境变量化</h3>
<p>这句话对应<a href="https://12factor.net/config">The 12-factor App的Config章节</a>。具体做法是在配置文件里使用<a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-external-config-placeholders-in-properties">placeholder</a>。下面是两种方式：</p>
<pre><code>app.name=${APP_NAME}
app.description=${APP_DESC:Default description}
</code></pre><p>第一种方式Spring Boot/Cloud应用在启动时，会根据<a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-external-config">这个顺序</a>找<code>APP_NAME</code>的值，如果找不到程序启动会报错。</p>
<p>第二种方式和第一种方式的不同在于如果找不到，则使用<code>application.properties</code>里定义的默认值。</p>
<p>而程序在启动时应该通过环境变量的方式将这些值传递进去。</p>
<p>在真实应用中应该尽量多的使用第二种方式，只有少数的配置才是程序启动时必须提供的，一般来说都是一些数据库连接字符串、用户名密码等信息。</p>
<h3 id="spring-cloud应用关于config-server的配置要放在bootstrapproperties里并且要做环境变量化">Spring Cloud应用关于Config Server的配置要放在<code>bootstrap.properties</code>里，并且要做环境变量化</h3>
<p>比如这样：</p>
<pre><code>spring.cloud.config.enabled=${CONFIG_ENABLED:true}
spring.cloud.config.profile=${CONFIG_PROFILE:production}
spring.cloud.config.label=${CONFIG_LABEL:master}
spring.cloud.config.uri=${CONFIG_SERVER_URL:http://config-server:8080/}
</code></pre><p>上面这个配置可以控制是否连接config server，因为在开发环境下我们可能并不需要config server。也提供了可以config server启动程序的可能。
同时也控制了如果连接config server，应该使用哪个<code>application.properties</code>。</p>
<p>需要注意的是，如果我们选择程序启动的时候连接config server，那么在程序启动时提供的环境变量就只能是和config server相关的环境变量（在这个例子里就是上面的<code>CONFIG_*</code>），这些配置用来控制如何获得<code>application.properties</code>。</p>
<p>因为此时程序所使用的配置都来自于config server，如果config server提供一些，环境变量又提供一些则会造成运维上的混乱。</p>
<h2 id="各种启动方式">各种启动方式</h2>
<p>下面讲讲各种启动方式如何传递环境变量。</p>
<h3 id="以操作系统进程启动">以操作系统进程启动</h3>
<p>直接以操作系统进程启动的方法是类似于这样的：</p>
<pre><code>APP_NAME=my-app APP_DESC=&quot;My App Desc&quot; java -jar spring-cloud-app.jar
</code></pre><h3 id="用docker启动">用Docker启动</h3>
<p>用docker启动则是这样的，参见<a href="https://docs.docker.com/engine/reference/run/#env-environment-variables">Docker ENV (environment variables)</a>：</p>
<pre><code>docker run --name my-app -e APP_NAME=my-app -e APP_DESC=&quot;My App Desc&quot; spring-cloud-app:latest
</code></pre><h3 id="在k8s里启动">在K8S里启动</h3>
<p>定义ConfigMap或Secret（用在密码类配置上），然后在Deployment spec里使用<code>configMapRef</code>或者<code>secretRef</code>或者<code>configMapKeyRef </code>或者<code>secretKeyRef</code>，比如下面的例子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: apps/v1
<span style="color:#66d9ef">kind</span>: Deployment
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: my-app
  <span style="color:#66d9ef">namespace</span>: &lt;namespace&gt;
<span style="color:#66d9ef">spec</span>:
  ...
  <span style="color:#66d9ef">template</span>:
    ...
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">containers</span>:
      - <span style="color:#66d9ef">name</span>: my-app
        <span style="color:#66d9ef">image</span>: &lt;image repository<span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">        ...</span>
        <span style="color:#66d9ef">envFrom</span>:
        - <span style="color:#66d9ef">configMapRef</span>:
            <span style="color:#66d9ef">name</span>: my-app-config
        - <span style="color:#66d9ef">secretRef</span>:
            <span style="color:#66d9ef">name</span>: my-app-secret
        <span style="color:#66d9ef">env</span>:
        - <span style="color:#66d9ef">name</span>: APP_NAME
          <span style="color:#66d9ef">valueFrom</span>:
            <span style="color:#66d9ef">configMapKeyRef</span>:
              <span style="color:#66d9ef">name</span>: my-app-config
              <span style="color:#66d9ef">key</span>: APP_NAME
        - <span style="color:#66d9ef">name</span>: APP_DESC
          <span style="color:#66d9ef">valueFrom</span>:
            <span style="color:#66d9ef">secretKeyRef</span>:
              <span style="color:#66d9ef">name</span>: my-app-secret
              <span style="color:#66d9ef">key</span>: APP_DESC
</code></pre></div><p>详见<a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/">Configure a Pod to Use a ConfigMap</a>、<a href="https://kubernetes.io/docs/concepts/configuration/secret/#using-secrets-as-files-from-a-pod">Secrets</a>和<a href="https://dchua.com/2017/04/21/load-env-variables-from-configmaps-and-secrets-upon-pod-boot/">Load env variables from ConfigMaps and Secrets upon Pod boot</a>。</p>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1">#微服务</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/spring-cloud">#Spring Cloud</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/k8s">#k8s</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>