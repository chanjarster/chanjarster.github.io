<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheatsheet</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/troubleshooting/">排障实战记录</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">远程Debug Java进程的方法</h1>
    
    <time>October 9, 2018</time>
    
    <div>
        <p>
        <p>本文介绍了远程Debug Java进程的方法。</p>
<p>远程debug的意思是启动一个Java进程，启动一个debugger进程，将两者连接起来，利用debugger来debug Java进程。</p>
<p>事实上目前所有的IDE的debug功能都是通过远程debug方式来实现的，它们都利用了一个叫做JDPA（Java Platform Debugger Architecture）的技术。</p>
<p>利用JDPA我们除了能够在IDE开发的时候debug，也能够将IDE attach到一个生产环境上正在运行的Java进程做debug（事实上这两个场景在本质上是一样的）。</p>
<p>下面会用两个例子来说明如何使用Intellij IDEA来debug一个Java进程。</p>
<h2 id="debug一个简单的java应用">debug一个简单的Java应用</h2>
<p>我们做了一个很简单的Java应用，它启动后会每隔2秒打印出一个不断增长的数字。</p>
<p>源代码在<a href="https://github.com/chanjarster/java-remote-debug-and-monitor/tree/master/debug-simple-app">Github debug-simple-app</a>：</p>
<ol>
<li>执行<code>mvn clean package</code>打包</li>
<li>执行<code>java -jar target/debug-simple-app.jar</code>运行</li>
</ol>
<p>现在我们要用IDEA远程Debug它。我们先<code>ctrl+c</code>把进程停止掉。</p>
<p><strong>1）把项目导入到IDEA里，因为如果没有源码的话我们没有办法打断点</strong></p>
<p><strong>2）按照下面步骤新建一个Remote Run/Debug Configuration:</strong></p>
<ol>
<li>
<p><img src="debug-01.png" alt="step-1"></p>
</li>
<li>
<p>选择Remote   <br>
<img src="debug-02.png" alt="step-2"></p>
</li>
<li>
<p>除了改个名字，设定Use module classpath，其余的选项不需要修改，直接用默认的就行
<img src="debug-03.png" alt="step-3"></p>
<p>这里解释一下各种参数：</p>
<p>Debugger mode：debugger的模式，有两种：attach和listen。</p>
<ul>
<li>attach的意思是debugger连接到被debug的Java进程，是主动式的。</li>
<li>listen的意思是debugger监听由Java进程发送过来的通信，是被动式的。</li>
</ul>
<p>Host和Port的设定了被debug的Java进程的Host和Port，实际上这也告诉我们，远程Debug是通过网络进行的。</p>
<p>JDK选项可根据你的不同JDK版本来构造不同的Command line arguments for remote JVM。</p>
<p>Command line arguments for remote JVM这个文本框你是不能修改的，它告诉了你如果要这个Java进程能够被远程Debug，那么必须添加这些参数才可以。
所以你要把这里的参数复制出来，后面会用得着。</p>
<p>Use module classpath，该选项设定使用那个module的源代码来debug。</p>
</li>
</ol>
<p><strong>3）把刚才的Command line arguments for remote JVM添加到刚才的运行命令。</strong></p>
<p>像这样：<code>java -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005 -jar target/debug-simple-app.jar</code></p>
<p><strong>4）点击下图里的Debug按钮开始debug</strong></p>
<p><img src="debug-04.png" alt="step-4"></p>
<p>你会发现Console里出现这么一句话<code>Connected to the target VM, address: 'localhost:5005', transport: 'socket'</code>，
这说明debugger已经attach成功了。</p>
<p><strong>5）在debug-simple-app里的代码打个断点看看效果。</strong></p>
<h2 id="debug一个tomcat应用">debug一个tomcat应用</h2>
<p>实际上debug一个tomcat应用和前面的例子没有什么大的区别。</p>
<p>我们写了一个很简单的Servlet，它会返回<code>Hello World</code>以及被访问的次数。</p>
<p>源代码在<a href="https://github.com/chanjarster/java-remote-debug-and-monitor/tree/master/debug-tomcat-app">Github debug-tomcat-app</a>：</p>
<ol>
<li>执行<code>mvn clean package</code>打包</li>
<li>把<code>target/debug-tomcat-app.war</code>丢到tomcat</li>
<li>然后访问<a href="http://localhost:8080/debug-tomcat-app/hello">http://localhost:8080/debug-tomcat-app/hello</a>查看结果</li>
</ol>
<p>现在我们要用IDEA来debug，那么先把tomcat停掉。</p>
<p><strong>1）同样需要把项目导入到IDEA里</strong></p>
<p><strong>2）执行tomcat的<code>bin/catalina.sh jpda start</code>，让tomcat可以被debug</strong></p>
<p><strong>3）执行<code>jps -v | grep Bootstrap</code>找到Tomcat进程：</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">76905 Bootstrap -Djava.util.logging.config.file=... 
-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager 
-Djdk.tls.ephemeralDHKeySize=2048 
-Djava.protocol.handler.pkgs=org.apache.catalina.webresources 
-agentlib:jdwp=transport=dt_socket,address=localhost:8000,server=y,suspend=n 
-Dcatalina.base=... 
-Dcatalina.home=... 
-Djava.io.tmpdir=...
</code></pre></div><p>注意上面的<code>-agentlib...address=localhost:8000</code>参数，记住这个端口</p>
<p><strong>4）和前面的例子一样，新建一个Remote Run/Debug Configuration，把端口设定为8000，然后启动</strong></p>
<p><strong>5）然后打个断点试试</strong></p>
<p>如果你想改变Tomcat的端口怎么做？看看<code>bin/catalina.sh</code>你会发现这么一段注释</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">JPDA_TRANSPORT  (Optional) JPDA transport used when the &#34;jpda start&#34;
                command is executed. The default is &#34;dt_socket&#34;.

JPDA_ADDRESS    (Optional) Java runtime options used when the &#34;jpda start&#34;
                command is executed. The default is localhost:8000.

JPDA_SUSPEND    (Optional) Java runtime options used when the &#34;jpda start&#34;
                command is executed. Specifies whether JVM should suspend
                execution immediately after startup. Default is &#34;n&#34;.

JPDA_OPTS       (Optional) Java runtime options used when the &#34;jpda start&#34;
                command is executed. If used, JPDA_TRANSPORT, JPDA_ADDRESS,
                and JPDA_SUSPEND are ignored. Thus, all required jpda
                options MUST be specified. The default is:

                -agentlib:jdwp=transport=$JPDA_TRANSPORT,
                    address=$JPDA_ADDRESS,server=y,suspend=$JPDA_SUSPEND
</code></pre></div><p>所以你只需要提供<code>JPDA_ADDRESS</code>环境变量参数就行了。比如这样：<code>JPDA_ADDRESS=5005 bin/catalina.sh jpda start</code></p>
<h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="https://www.techrepublic.com/article/debug-your-java-code-with-ease-using-jpda/">Debug your Java code with ease using JPDA</a></li>
<li><a href="https://docs.oracle.com/apps/search/search.jsp?q=jpda%20connection&amp;category=java">JPDA Connection and Invocation</a></li>
<li><a href="https://docs.oracle.com/apps/search/search.jsp?q=agentlib:jdwp&amp;category=java">Oracle VM Invocation Options</a></li>
</ul>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/java">#java</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/debug">#debug</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/jdpa">#jdpa</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>