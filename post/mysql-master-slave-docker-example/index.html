<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheat sheet</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">MySQL Master Slave Docker部署例子</h1>
    
    <time>June 18, 2019</time>
    
    <div>
        <p>
        <p>本文对应代码：<a href="https://github.com/chanjarster/mysql-master-slave-docker-example">github</a></p>
<p>用Docker部署基于GTID的MySQL Master-Slave Replication例子。</p>
<h2 id="启动master">启动Master</h2>
<p>写一个文件<code>mysql-master.cnf</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">[mysqld]
server_id=1
binlog_format=ROW
gtid_mode=ON
enforce-gtid-consistency=true
</code></pre></div><p>这个配置文件把Master的<code>server_id</code>设置为1，要注意在同一个Master-Slave集群里，<code>server_id</code>不能重复。</p>
<p>启动Master：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -d --name mysql-master <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -e MYSQL_USER<span style="color:#f92672">=</span>my_user <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -e MYSQL_DATABASE<span style="color:#f92672">=</span>my_database <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -e MYSQL_PASSWORD<span style="color:#f92672">=</span>my_database_password <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -e MYSQL_ROOT_PASSWORD<span style="color:#f92672">=</span>my_root_password <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -p 3307:3306 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -v <span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span>/mysql-master.cnf:/etc/mysql/conf.d/mysql-master.cnf <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  mysql:8.0 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --log-bin<span style="color:#f92672">=</span>my
</code></pre></div><h2 id="启动slave">启动Slave</h2>
<p>写一个文件<code>mysql-slave-1.cnf</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">[mysqld]
server_id=2
binlog_format=ROW
gtid_mode=ON
enforce-gtid-consistency=true
read_only=ON
</code></pre></div><p>这个文件把Slave的<code>server_id</code>设置为2，如果你有多个Slave，那么得分别设置不同的<code>server_id</code>。此外，将Slave设置为<code>read_only</code>模式（这样就不能在slave上执行写操作了）。</p>
<p>启动Slave：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -d --name mysql-slave-1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -e MYSQL_ROOT_PASSWORD<span style="color:#f92672">=</span>my_root_password <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -p 3308:3306 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -v <span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span>/mysql-slave-1.cnf:/etc/mysql/conf.d/mysql-slave-1.cnf <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  mysql:8.0 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --skip-log-bin <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --skip-log-slave-updates <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --skip-slave-start
</code></pre></div><h2 id="创建replication用户">创建Replication用户</h2>
<p>到Master上创建Replication用户：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker exec -it mysql-master mysql -u root -p
Enter password: my_root_password

mysql&gt; CREATE USER <span style="color:#e6db74">&#39;repl&#39;</span>@<span style="color:#e6db74">&#39;%&#39;</span> IDENTIFIED BY <span style="color:#e6db74">&#39;password&#39;</span>;
mysql&gt; GRANT REPLICATION SLAVE ON *.* TO <span style="color:#e6db74">&#39;repl&#39;</span>@<span style="color:#e6db74">&#39;%&#39;</span>;
</code></pre></div><h2 id="将slave和master关联">将Slave和Master关联</h2>
<p>到Slave上把自己和Master关联起来：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker exec -it mysql-slave-1 mysql -u root -p
Enter password: my_root_password

mysql&gt; CHANGE MASTER TO 
  MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.101.21&#39;</span>,
  MASTER_PORT<span style="color:#f92672">=</span>3307,
  MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;repl&#39;</span>,
  MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;password&#39;</span>,
  GET_MASTER_PUBLIC_KEY<span style="color:#f92672">=</span>1,
  MASTER_AUTO_POSITION<span style="color:#f92672">=</span>1;
</code></pre></div><p>注意<code>MASTER_HOST</code>写的是Master所在的Host的IP，<code>MASTER_PORT</code>写的是Master暴露在Host上的端口，<code>MASTER_USER</code>和<code>MASTER_PASSWORD</code>则是Replication用户的信息。</p>
<p>最后正式启动Slave：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mysql&gt; START SLAVE;
</code></pre></div><h2 id="验证">验证</h2>
<p>到Slave上看看my_database是否存在：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker exec -it mysql-slave-1 mysql -u root -p
Enter password: my_root_password

mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| my_database        |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
<span style="color:#ae81ff">5</span> rows in set <span style="color:#f92672">(</span>0.01 sec<span style="color:#f92672">)</span>
</code></pre></div><p>如果有就说明my_database从Master复制到了Slave上。</p>
<h2 id="docker-compose版本">docker-compose版本</h2>
<p>在<a href="https://github.com/chanjarster/mysql-master-slave-docker-example">github</a>上也提供了docker-compose.yaml，操作过程和上述一致，只不过容器名字会有变化。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 拉起Master和Slave</span>
$ docker-compose -p mysql-repl up
<span style="color:#75715e"># 连接Master</span>
$ docker exec -it mysql-repl_mysql-master_1 mysql -u root -p
<span style="color:#75715e"># 连接Slave</span>
$ docker exec -it mysql-repl_mysql-slave_1 mysql -u root -p
</code></pre></div><p>并且<code>CHANGE MASTER TO</code>语句有所不同，使用的是Master的Service Name以及容器内端口<code>3306</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">CHANGE MASTER TO 
  MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mysql-master&#39;</span>,
  MASTER_PORT<span style="color:#f92672">=</span>3306,
  MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;repl&#39;</span>,
  MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;password&#39;</span>,
  GET_MASTER_PUBLIC_KEY<span style="color:#f92672">=</span>1,
  MASTER_AUTO_POSITION<span style="color:#f92672">=</span>1;
</code></pre></div><h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="docker-run版本在mac上无法工作">docker run版本在Mac上无法工作</h3>
<p>这个是因为Slave容器无法访问到Master的host。解决办法我也不知道。</p>
<h3 id="关于get_master_public_key">关于<code>GET_MASTER_PUBLIC_KEY</code></h3>
<p>在做本例子时出现过Slave无法连接到Master的情况：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">2019-06-19T01:34:24.361566Z 8 [System] [MY-010597] [Repl] &#39;CHANGE MASTER TO FOR CHANNEL &#39;&#39; executed&#39;. Previous state master_host=&#39;&#39;, master_port= 3306, master_log_file=&#39;&#39;, master_log_pos= 4, master_bind=&#39;&#39;. New state master_host=&#39;mysql-master&#39;, master_port= 3306, master_log_file=&#39;&#39;, master_log_pos= 4, master_bind=&#39;&#39;.
2019-06-19T01:34:28.274728Z 9 [Warning] [MY-010897] [Repl] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &#39;START SLAVE Syntax&#39; in the MySQL Manual for more information.
2019-06-19T01:34:28.330825Z 9 [ERROR] [MY-010584] [Repl] Slave I/O for channel &#39;&#39;: error connecting to master &#39;repl@mysql-master:3306&#39; - retry-time: 60  retries: 1, Error_code: MY-002061
2019-06-19T01:35:28.333735Z 9 [ERROR] [MY-010584] [Repl] Slave I/O for channel &#39;&#39;: error connecting to master &#39;repl@mysql-master:3306&#39; - retry-time: 60  retries: 2, Error_code: MY-002061
2019-06-19T01:36:28.335525Z 9 [ERROR] [MY-010584] [Repl] Slave I/O for channel &#39;&#39;: error connecting to master &#39;repl@mysql-master:3306&#39; - retry-time: 60  retries: 3, Error_code: MY-002061
...
</code></pre></div><p>详细细节可见这个<a href="https://github.com/docker-library/mysql/issues/572">issue</a>，这是因为MySQL 8默认启用了caching_sha2_password authentication plugin，issue中提到了一个办法：在启动Slave的时候添加<code>--default-auth=mysql_native_password</code>参数。不过我感觉这个不太好，查阅相关文档后发现可以在<code>CHANGE MASTER TO</code>添加<code>GET_MASTER_PUBLIC_KEY=1</code>参数来解决这个问题。</p>
<p>更多详情参考<a href="https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password-replication">caching_sha2_password and Replication</a>和<a href="https://dev.mysql.com/doc/refman/8.0/en/change-master-to.html">CHANGE MASTER TO Syntax</a>。</p>
<h2 id="参考资料">参考资料</h2>
<ul>
<li>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/replication-gtids-howto.html">Setting Up Replication Using GTIDs</a></p>
</li>
<li>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html">Binary Logging Options and Variables</a></p>
</li>
<li>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/replication-options-slave.html">Replication Slave Options and Variables</a></p>
</li>
<li>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/host-cache.html">DNS Lookup Optimization and the Host Cache</a></p>
</li>
<li>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/change-master-to.html">CHANGE MASTER TO Syntax</a></p>
</li>
<li>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password-replication">caching_sha2_password and Replication</a></p>
</li>
<li>
<p><a href="https://hub.docker.com/r/bitnami/mysql">Bitnami MySQL Docker</a>, Bitnami制作的MySQL镜像，支持通过环境变量来配置Master-Slave Replication，不过它不支持GTID，只支持基于Binary Log的Replication。</p>
</li>
</ul>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/docker">#docker</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/mysql">#mysql</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>