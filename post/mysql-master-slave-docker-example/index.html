<!DOCTYPE html>
<html lang="zh-cn">
<head>

  <meta charset="utf-8" />

  
  <title>MySQL Master Slave Docker部署例子</title>

  
  





  
  <meta name="author" content="颇忒脱" />
  <meta name="description" content="
" />

  
  
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@gohugoio" />
    <meta name="twitter:title" content="MySQL Master Slave Docker部署例子" />
    <meta name="twitter:description" content="
" />
    <meta name="twitter:image" content="https://chanjarster.github.io/img/avatar.jpg" />
  

  
  <meta property="og:type" content="article" />
  <meta property="og:title" content="MySQL Master Slave Docker部署例子" />
  <meta property="og:description" content="
" />
  <meta property="og:url" content="https://chanjarster.github.io/post/mysql-master-slave-docker-example/" />
  <meta property="og:image" content="https://chanjarster.github.io/img/avatar.jpg" />




<meta name="generator" content="Hugo 0.49.2" />


<link rel="canonical" href="https://chanjarster.github.io/post/mysql-master-slave-docker-example/" />

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="format-detection" content="telephone=no,email=no,adress=no" />
<meta http-equiv="Cache-Control" content="no-transform" />


<meta name="robots" content="index,follow" />
<meta name="referrer" content="origin-when-cross-origin" />







<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="颇忒脱的技术博客" />
<meta name="msapplication-tooltip" content="颇忒脱的技术博客" />
<meta name='msapplication-navbutton-color' content="#5fbf5e" />
<meta name="msapplication-TileColor" content="#5fbf5e" />
<meta name="msapplication-TileImage" content="/img/tile-image-windows.png" />
<link rel="icon" href="https://chanjarster.github.io/img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/img/favicon-32x32.png" />
<link rel="icon" sizes="192x192" href="https://chanjarster.github.io/img/touch-icon-android.png" />
<link rel="apple-touch-icon" href="https://chanjarster.github.io/img/touch-icon-apple.png" />
<link rel="mask-icon" href="https://chanjarster.github.io/img/safari-pinned-tab.svg" color="#5fbf5e" />



<link rel="stylesheet" href="//cdn.bootcss.com/video.js/6.2.8/alt/video-js-cdn.min.css" />

<link rel="stylesheet" href="https://chanjarster.github.io/css/bundle.8e3aef2bc5.css" />


  
  <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <script src="//cdn.bootcss.com/video.js/6.2.8/ie8/videojs-ie8.min.js"></script>
  <![endif]-->

<!--[if lte IE 11]>
    <script src="//cdn.bootcss.com/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->


<script src="//cdn.bootcss.com/object-fit-images/3.2.3/ofi.min.js"></script>


<script src="//cdn.bootcss.com/smooth-scroll/12.1.4/js/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
      
    </div>
    
    
  <header class="site-header">
  <img class="avatar" src="https://chanjarster.github.io/img/avatar2.jpg" alt="Avatar">
  
  <h2 class="title">颇忒脱的技术博客</h2>
  
  <p class="subtitle"></p>
  <button class="menu-toggle" type="button">
    <span class="icon icon-menu"></span>
  </button>
  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item
            
            
            
              is-active
            ">
            <a href="https://chanjarster.github.io/">Home</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="https://github.com/chanjarster">Works</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="https://chanjarster.github.io/tags/">Tags</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="https://chanjarster.github.io/links/">Links</a>
          </li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list">

      

      
      <li class="social-item">
        <a href="//github.com/chanjarster" title="GitHub"><span class="icon icon-github"></span></a>
      </li>

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <li class="social-item">
        <a rel="alternate" type="application/rss+xml" href="https://chanjarster.github.io/index.xml"><span class="icon icon-rss" title="RSS"></span></a>
      </li>

    </ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">MySQL Master Slave Docker部署例子</h1>
      <p class="post-meta">@颇忒脱 · Jun 18, 2019 · 2 min read</p>
    </header>
    <article class="post-content"><p></p>

<p>本文对应代码：<a href="https://github.com/chanjarster/mysql-master-slave-docker-example">github</a></p>

<p>用Docker部署基于GTID的MySQL Master-Slave Replication例子。</p>

<h2 id="启动master">启动Master</h2>

<p>写一个文件<code>mysql-master.cnf</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">[mysqld]
server_id=1
binlog_format=ROW
gtid_mode=ON
enforce-gtid-consistency=true</code></pre></div>
<p>这个配置文件把Master的<code>server_id</code>设置为1，要注意在同一个Master-Slave集群里，<code>server_id</code>不能重复。</p>

<p>启动Master：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -d --name mysql-master <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -e MYSQL_USER<span style="color:#f92672">=</span>my_user <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -e MYSQL_DATABASE<span style="color:#f92672">=</span>my_database <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -e MYSQL_PASSWORD<span style="color:#f92672">=</span>my_database_password <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -e MYSQL_ROOT_PASSWORD<span style="color:#f92672">=</span>my_root_password <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -p <span style="color:#ae81ff">3307</span>:3306 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -v <span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span>/mysql-master.cnf:/etc/mysql/conf.d/mysql-master.cnf <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  mysql:8.0 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --log-bin<span style="color:#f92672">=</span>my</code></pre></div>
<h2 id="启动slave">启动Slave</h2>

<p>写一个文件<code>mysql-slave-1.cnf</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">[mysqld]
server_id=2
binlog_format=ROW
gtid_mode=ON
enforce-gtid-consistency=true
read_only=ON</code></pre></div>
<p>这个文件把Slave的<code>server_id</code>设置为2，如果你有多个Slave，那么得分别设置不同的<code>server_id</code>。此外，将Slave设置为<code>read_only</code>模式（这样就不能在slave上执行写操作了）。</p>

<p>启动Slave：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -d --name mysql-slave-1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -e MYSQL_ROOT_PASSWORD<span style="color:#f92672">=</span>my_root_password <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -p <span style="color:#ae81ff">3308</span>:3306 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -v <span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span>/mysql-slave-1.cnf:/etc/mysql/conf.d/mysql-slave-1.cnf <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  mysql:8.0 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --skip-log-bin <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --skip-log-slave-updates <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --skip-slave-start</code></pre></div>
<h2 id="创建replication用户">创建Replication用户</h2>

<p>到Master上创建Replication用户：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker exec -it mysql-master mysql -u root -p
Enter password: my_root_password

mysql&gt; CREATE USER <span style="color:#e6db74">&#39;repl&#39;</span>@<span style="color:#e6db74">&#39;%&#39;</span> IDENTIFIED BY <span style="color:#e6db74">&#39;password&#39;</span>;
mysql&gt; GRANT REPLICATION SLAVE ON *.* TO <span style="color:#e6db74">&#39;repl&#39;</span>@<span style="color:#e6db74">&#39;%&#39;</span>;</code></pre></div>
<h2 id="将slave和master关联">将Slave和Master关联</h2>

<p>到Slave上把自己和Master关联起来：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker exec -it mysql-slave-1 mysql -u root -p
Enter password: my_root_password

mysql&gt; CHANGE MASTER TO 
  MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.101.21&#39;</span>,
  MASTER_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">3307</span>,
  MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;repl&#39;</span>,
  MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;password&#39;</span>,
  GET_MASTER_PUBLIC_KEY<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
  MASTER_AUTO_POSITION<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;</code></pre></div>
<p>注意<code>MASTER_HOST</code>写的是Master所在的Host的IP，<code>MASTER_PORT</code>写的是Master暴露在Host上的端口，<code>MASTER_USER</code>和<code>MASTER_PASSWORD</code>则是Replication用户的信息。</p>

<p>最后正式启动Slave：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mysql&gt; START SLAVE;</code></pre></div>
<h2 id="验证">验证</h2>

<p>到Slave上看看my_database是否存在：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker exec -it mysql-slave-1 mysql -u root -p
Enter password: my_root_password

mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| my_database        |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
<span style="color:#ae81ff">5</span> rows in set <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span>.01 sec<span style="color:#f92672">)</span></code></pre></div>
<p>如果有就说明my_database从Master复制到了Slave上。</p>

<h2 id="docker-compose版本">docker-compose版本</h2>

<p>在<a href="https://github.com/chanjarster/mysql-master-slave-docker-example">github</a>上也提供了docker-compose.yaml，操作过程和上述一致，只不过容器名字会有变化。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 拉起Master和Slave
</span><span style="color:#75715e"></span>$ docker-compose -p mysql-repl up
<span style="color:#75715e"># 连接Master
</span><span style="color:#75715e"></span>$ docker exec -it mysql-repl_mysql-master_1 mysql -u root -p
<span style="color:#75715e"># 连接Slave
</span><span style="color:#75715e"></span>$ docker exec -it mysql-repl_mysql-slave_1 mysql -u root -p</code></pre></div>
<p>并且<code>CHANGE MASTER TO</code>语句有所不同，使用的是Master的Service Name以及容器内端口<code>3306</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">CHANGE MASTER TO 
  MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mysql-master&#39;</span>,
  MASTER_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">3306</span>,
  MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;repl&#39;</span>,
  MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;password&#39;</span>,
  GET_MASTER_PUBLIC_KEY<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
  MASTER_AUTO_POSITION<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;</code></pre></div>
<h2 id="troubleshooting">Troubleshooting</h2>

<h3 id="docker-run版本在mac上无法工作">docker run版本在Mac上无法工作</h3>

<p>这个是因为Slave容器无法访问到Master的host。解决办法我也不知道。</p>

<h3 id="关于-get-master-public-key">关于<code>GET_MASTER_PUBLIC_KEY</code></h3>

<p>在做本例子时出现过Slave无法连接到Master的情况：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">2019-06-19T01:34:24.361566Z 8 [System] [MY-010597] [Repl] &#39;CHANGE MASTER TO FOR CHANNEL &#39;&#39; executed&#39;. Previous state master_host=&#39;&#39;, master_port= 3306, master_log_file=&#39;&#39;, master_log_pos= 4, master_bind=&#39;&#39;. New state master_host=&#39;mysql-master&#39;, master_port= 3306, master_log_file=&#39;&#39;, master_log_pos= 4, master_bind=&#39;&#39;.
2019-06-19T01:34:28.274728Z 9 [Warning] [MY-010897] [Repl] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &#39;START SLAVE Syntax&#39; in the MySQL Manual for more information.
2019-06-19T01:34:28.330825Z 9 [ERROR] [MY-010584] [Repl] Slave I/O for channel &#39;&#39;: error connecting to master &#39;repl@mysql-master:3306&#39; - retry-time: 60  retries: 1, Error_code: MY-002061
2019-06-19T01:35:28.333735Z 9 [ERROR] [MY-010584] [Repl] Slave I/O for channel &#39;&#39;: error connecting to master &#39;repl@mysql-master:3306&#39; - retry-time: 60  retries: 2, Error_code: MY-002061
2019-06-19T01:36:28.335525Z 9 [ERROR] [MY-010584] [Repl] Slave I/O for channel &#39;&#39;: error connecting to master &#39;repl@mysql-master:3306&#39; - retry-time: 60  retries: 3, Error_code: MY-002061
...</code></pre></div>
<p>详细细节可见这个<a href="https://github.com/docker-library/mysql/issues/572">issue</a>，这是因为MySQL 8默认启用了caching_sha2_password authentication plugin，issue中提到了一个办法：在启动Slave的时候添加<code>--default-auth=mysql_native_password</code>参数。不过我感觉这个不太好，查阅相关文档后发现可以在<code>CHANGE MASTER TO</code>添加<code>GET_MASTER_PUBLIC_KEY=1</code>参数来解决这个问题。</p>

<p>更多详情参考<a href="https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password-replication">caching_sha2_password and Replication</a>和<a href="https://dev.mysql.com/doc/refman/8.0/en/change-master-to.html">CHANGE MASTER TO Syntax</a>。</p>

<h2 id="参考资料">参考资料</h2>

<ul>
<li><p><a href="https://dev.mysql.com/doc/refman/8.0/en/replication-gtids-howto.html">Setting Up Replication Using GTIDs</a></p></li>

<li><p><a href="https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html">Binary Logging Options and Variables</a></p></li>

<li><p><a href="https://dev.mysql.com/doc/refman/8.0/en/replication-options-slave.html">Replication Slave Options and Variables</a></p></li>

<li><p><a href="https://dev.mysql.com/doc/refman/8.0/en/host-cache.html">DNS Lookup Optimization and the Host Cache</a></p></li>

<li><p><a href="https://dev.mysql.com/doc/refman/8.0/en/change-master-to.html">CHANGE MASTER TO Syntax</a></p></li>

<li><p><a href="https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password-replication">caching_sha2_password and Replication</a></p></li>

<li><p><a href="https://hub.docker.com/r/bitnami/mysql">Bitnami MySQL Docker</a>, Bitnami制作的MySQL镜像，支持通过环境变量来配置Master-Slave Replication，不过它不支持GTID，只支持基于Binary Log的Replication。</p></li>
</ul></article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="https://chanjarster.github.io/tags/docker"><span class="tag">Docker</span></a></li>
        
          <li><a href="https://chanjarster.github.io/tags/mysql"><span class="tag">Mysql</span></a></li>
        
      </ul>
      
      <p class="post-copyright">
        This post was published <strong>236</strong> days ago, content in the post may be inaccurate, even wrong now, please take risk yourself.
      </p>
    </footer>
    
      
    
  </section>
  <footer class="site-footer">
  <p>© 2017-2020 颇忒脱的技术博客</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank">Nuo</a>.</p>
  
</footer>



<script async src="//cdn.bootcss.com/video.js/6.2.8/alt/video.novtt.min.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>

<script src="https://chanjarster.github.io/js/bundle.273f9ac6f0.js"></script>




  </body>
</html>
