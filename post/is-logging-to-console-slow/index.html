<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheatsheet</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">为何把日志打印到控制台很慢？</h1>
    
    <time>February 22, 2019</time>
    
    <div>
        <p>
        <p>在<a href="../docker-console-logging-hangs">容器打印日志到控制台阻塞的排障</a>的时候看到一个观点：</p>
<blockquote>
<p>把日志打印到控制台要比打印到文件慢，而且是非常慢。</p>
</blockquote>
<p>log4j2和logback的两个issue官方也提到了这一点（见<a href="https://jira.apache.org/jira/browse/LOG4J2-2239">LOG4J2-2239</a>、<a href="https://jira.qos.ch/browse/LOGBACK-1422">LOGBACK-1422</a>）。</p>
<p>那么为何输出到控制台慢？有何办法加速呢？问题要从三个角度来分别回答：</p>
<ol>
<li>linux的<code>stdout</code>角度</li>
<li>Java程序角度</li>
<li>docker容器角度</li>
</ol>
<h2 id="stdout角度"><code>stdout</code>角度</h2>
<p>写到控制台其实就是写到<code>stdout</code>，更严格的说应该是<code>fd/1</code>。Linux操作系统将<code>fd/0</code>、<code>fd/1</code>和<code>fd/2</code>分别对应<code>stdin</code>、<code>stdout</code>和<code>stdout</code>。</p>
<p>那么问题就变成为何写到<code>stdout</code>慢，有何优化办法？</p>
<p>造成<code>stdout</code>慢的原因有两个：</p>
<ul>
<li>你使用的终端会拖累<code>stdout</code>的输出效率</li>
<li><code>stdout</code>的缓冲机制</li>
</ul>
<p>在SO的这个问题中：<a href="https://stackoverflow.com/questions/3857052/why-is-printing-to-stdout-so-slow-can-it-be-sped-up">Why is printing to stdout so slow? Can it be sped up?</a>，这回答提到<a href="https://stackoverflow.com/a/3860319/1287790">打印到stdout慢是因为终端的关系，换一个快速的终端就能提升</a>。这解释了第一个原因。</p>
<p><code>stdout</code>本身的缓冲机制是怎样的？<a href="https://eklitzke.org/stdout-buffering">Stdout Buffering</a>介绍了glibc对于stdout缓冲的做法：</p>
<ul>
<li>当<code>stdout</code>指向的是终端的时候，那么它的缓冲行为是<code>line-buffered</code>，意思是如果缓冲满了或者遇到了newline字符，那么就flush。</li>
<li>当<code>stdout</code>没有指向终端的时候，那么它的缓冲行为是<code>fully-buffered</code>，意思是只有当缓冲满了的时候，才会flush。</li>
</ul>
<p>其中缓冲区大小是4k。下面是一个总结的表格“
GNU libc (glibc) uses the following rules for buffering”:</p>
<table>
<thead>
<tr>
<th>Stream</th>
<th>Type</th>
<th>Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td>stdin</td>
<td>input</td>
<td>line-buffered</td>
</tr>
<tr>
<td>stdout (TTY)</td>
<td>output</td>
<td>line-buffered</td>
</tr>
<tr>
<td>stdout (not a TTY)</td>
<td>output</td>
<td>fully-buffered</td>
</tr>
<tr>
<td>stderr</td>
<td>output</td>
<td>unbuffered</td>
</tr>
</tbody>
</table>
<p>那也就是说当<code>stdout</code>指向一个终端的时候，它采用的是<code>line-buffered</code>策略，而终端的处理速度直接影响到了性能。</p>
<p>同时也给了我们另一个思路，不将<code>stdout</code>指向终端，那么就能够用到<code>fully-buffered</code>，比起<code>line-buffered</code>能够带来更大提速效果（想想极端情况下每行只有一个字符）。</p>
<p>我写了一段小代码来做测试（<a href="https://gist.github.com/chanjarster/4598cb15bac03662c1dd66c8097c8282">gist</a>）。先试一下<code>stdout</code>指向终端的情况：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ javac ConsolePrint.java
$ java ConsolePrint <span style="color:#ae81ff">100000</span>
...
lines: 100,000
System.out.println: 1,270 ms
file: <span style="color:#ae81ff">72</span> ms
/dev/stdout: 1,153 ms
</code></pre></div><p>代码测试了三种用法：</p>
<ul>
<li><code>System.out.println</code> 指的是使用<code>System.out.println</code>所花费的时间</li>
<li><code>file</code> 指的是用4k BufferedOutputStream 写到一个文件所花费的时间</li>
<li><code>/dev/stdout</code> 则是同样适用4k BufferedOutputStream 直接写到<code>/dev/stdout</code>所花费的时间</li>
</ul>
<p>发现写到文件花费速度最快，用<code>System.out.println</code>和写到<code>/dev/stdout</code>所花时间在一个数量级上。</p>
<p>如果我们将输出重定向到文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ java ConsolePrint <span style="color:#ae81ff">100000</span> &gt; a
$ tail -n <span style="color:#ae81ff">5</span> a
...
System.out.println: <span style="color:#ae81ff">920</span> ms
file: <span style="color:#ae81ff">76</span> ms
/dev/stdout: <span style="color:#ae81ff">31</span> ms
</code></pre></div><p>则会发现<code>/dev/stdout</code>速度提升到<code>file</code>一个档次，而<code>System.out.println</code>并没有提升多少。之前不是说<code>stdout</code>不指向终端能够带来性能提升吗，为何<code>System.out.println</code>没有变化呢？这就要Java对于<code>System.out</code>的实现说起了。</p>
<h2 id="java程序角度">Java程序角度</h2>
<p>下面是<code>System</code>的源码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">static</span> PrintStream out <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">...</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initializeSystemClass</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  FileOutputStream fdOut <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileOutputStream<span style="color:#f92672">(</span>FileDescriptor<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">);</span>
  setOut0<span style="color:#f92672">(</span>newPrintStream<span style="color:#f92672">(</span>fdOut<span style="color:#f92672">,</span> props<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;sun.stdout.encoding&#34;</span><span style="color:#f92672">)));</span>
<span style="color:#f92672">}</span>
<span style="color:#f92672">...</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">native</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setOut0</span><span style="color:#f92672">(</span>PrintStream out<span style="color:#f92672">);</span>
<span style="color:#f92672">...</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> PrintStream <span style="color:#a6e22e">newPrintStream</span><span style="color:#f92672">(</span>FileOutputStream fos<span style="color:#f92672">,</span> String enc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#f92672">...</span>
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> PrintStream<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> BufferedOutputStream<span style="color:#f92672">(</span>fos<span style="color:#f92672">,</span> 128<span style="color:#f92672">),</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看到<code>System.out</code>是<code>PrintStream</code>类型，下面是<code>PrintStream</code>的源码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>String s<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      ensureOpen<span style="color:#f92672">();</span>
      textOut<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>s<span style="color:#f92672">);</span>
      textOut<span style="color:#f92672">.</span><span style="color:#a6e22e">flushBuffer</span><span style="color:#f92672">();</span>
      charOut<span style="color:#f92672">.</span><span style="color:#a6e22e">flushBuffer</span><span style="color:#f92672">();</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>autoFlush <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>s<span style="color:#f92672">.</span><span style="color:#a6e22e">indexOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;\n&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">))</span>
        out<span style="color:#f92672">.</span><span style="color:#a6e22e">flush</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedIOException x<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">interrupt</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException x<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    trouble <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看到：</p>
<ol>
<li><code>System.out</code>使用的缓冲大小仅为128字节。大部分情况下够用。</li>
<li><code>System.out</code>开启了autoFlush，即每次write都会立即flush。这保证了输出的及时性。</li>
<li><code>PrintStream</code>的所有方法加了同步块。这避免了多线程打印内容重叠的问题。</li>
<li><code>PrintStream</code>如果遇到了newline符，也会立即flush（相当于<code>line-buffered</code>）。同样保证了输出的及时性。</li>
</ol>
<p>这解释了为何<code>System.out</code>慢的原因，同时也告诉了我们就算把<code>System.out</code>包到BufferedOutputStream里也不会有性能提升。</p>
<h2 id="docker容器角度">Docker容器角度</h2>
<p>那么把测试代码放到Docker容器内运行会怎样呢？把gist里的Dockerfile和ConsolePrint.java放到同一个目录里然后这样运行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker build -t console-print .
$ docker run -d --name console-print console-print <span style="color:#ae81ff">100000</span>
$ docker logs --tail <span style="color:#ae81ff">5</span> console-print
...
lines: 100,000
System.out.println: 2,563 ms
file: <span style="color:#ae81ff">27</span> ms
/dev/stdout: 2,685 ms
</code></pre></div><p>可以发现<code>System.out.println</code>和<code>/dev/stdout</code>的速度又变回一样慢了。因此可以怀疑<code>stdout</code>使用的是<code>line-buffered</code>模式。</p>
<p>为何容器内的<code>stdout</code>不使用<code>fully-buffered</code>模式呢？下面是我的两个猜测:</p>
<ul>
<li>不论你是<code>docker run -t</code>分配<code>tty</code>启动，还是<code>docker run -d</code>不非配tty启动，docker都会给容器内的<code>stdout</code>分配一个<code>tty</code>。</li>
<li>因为docker的logging driver都是以“行”为单位收集日志的，那么这个<code>tty</code>必须是<code>line-buffered</code>。</li>
</ul>
<p>虽然<code>System.out.println</code>很慢，但是其吞吐量也能够达到~40,000 lines/sec，对于大多数程序来说这不会造成瓶颈。</p>
<h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Standard_streams#Standard_output_(stdout)">Standard output (stdout)</a></li>
<li><a href="https://eklitzke.org/stdout-buffering">Stdout Buffering</a></li>
</ul>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/arts">#ARTS</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/arts-t">#ARTS-T</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/linux">#linux</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/java">#java</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/%E6%97%A5%E5%BF%97">#日志</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/docker">#docker</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>