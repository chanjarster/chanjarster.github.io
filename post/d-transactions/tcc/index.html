<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">事务 - TCC</h1>
    
    <time>March 20, 2018</time>
    
    <div>
        <p>
        <p><a href="https://github.com/chanjarster/transactions">github</a></p>
<p>在前一篇文章中讲到了<a href="https://segmentfault.com/a/1190000013775137">BASE模式</a>，这种模式可以应用在单库or跨库事务的场景下。事实上BASE模式不仅仅局限于数据库层面，还可以应用于分布式系统，这类分布式系统最典型的例子就是电商平台，它们有以下几个特征：</p>
<ol>
<li>SOA化/微服务化：单体应用拆分成多个服务。</li>
<li>数据库的各种拆分技术的运用：分表、分库、分区。</li>
<li>大量NoSQL数据库的兴起。</li>
<li>应用之间的通信手段并非直接读数据库：RESTful、RPC、消息中间件等。</li>
<li>大量跨应用事务的出现。</li>
</ol>
<p>在这种场景下，<a href="https://segmentfault.com/a/1190000013772027">2PC</a>（及XA）已经无法满足需求，因为它：</p>
<ol>
<li>性能低下，2PC协议是阻塞式的。当协调的数据库越来越多时，性能无法接受。</li>
<li>无法水平扩展以提升性能，只能靠垂直扩展（提升硬件）——更快的CPU、更快更大的硬盘、更大更快的内存——但是这样很贵，并且很容易遇到极限。</li>
<li>染指其他数据库。</li>
<li>依赖于数据库是否支持2PC（XA）。</li>
</ol>
<p>而BASE只解决最后提交的问题，不能解决诸如在<a href="https://segmentfault.com/a/1190000013775137">上一篇文章</a>中最后提到的如何保证刷卡消费不透支的问题.于是就有人提出了<a href="https://www.infoq.com/presentations/Transactions-HTTP-REST">TCC模式</a>（Try、Confirm、Cancel），这一模式在国内因阿里巴巴的推广而广为人知。</p>
<h2 id="协议介绍">协议介绍</h2>
<p>在TCC协议里，参与的主体分为两种：</p>
<ul>
<li>发起方：发起事务的应用。</li>
<li>参与方：执行事务请求，手上握有资源的服务。</li>
</ul>
<p>并且有三种动作：Try、Confirm、Cancel。</p>
<p>TCC是Try、Confirm、Cancel的简称，它们分别的职责是：</p>
<ul>
<li>Try：负责预留资源（比如新建一条状态=PENDING的订单），同时也做业务检查（比如看看余额是否足够），简单来说就是不能预留已经被占用的资源。</li>
<li>Confirm：负责落地所预留的资源（比如扣费、把订单状态变成COMPLETED）</li>
<li>Cancel：负责撤销所预留的资源（比如把订单状态变成CANCELED）</li>
</ul>
<p>关于预留资源要多说两句，资源都是有限的，因此预留资源都是有时效的，如果当预留资源迟迟得不到Confirm——我们将这种情况称为timeout——参与方会自行将其Cancel（这里有坑，下面会讲）。也就是说参与方对于资源具有自我管理能力，这样可以避免因发起方的问题导致资源被长期占用。</p>
<p>TCC于BASE相比，增加了业务检查和撤销事务的功能。</p>
<p>同时，TCC将2PC数据库层面的动作提升到了服务层面，不同的是TCC的所有动作都是一个本地事务，每个本地事务都在动作完成后commit到数据库：</p>
<ul>
<li>Try相当于2PC的Commit request phase，外加了业务检查逻辑</li>
<li>Confirm相当于2PC的Commit phase的commit动作</li>
<li>Cancel相当于2PC的Commit phase的rollback动作</li>
</ul>
<h2 id="流程">流程</h2>
<p>以下是TCC的状态图：</p>
<p><img src="https://chanjarster.github.io/img/bV564S" alt="TCC的状态"></p>
<p>下面是流程步骤（你会发现和2PC很像）：</p>
<ol>
<li>【发起方】发送Try到所有参与方</li>
<li>每个【参与方】执行Try，预留资源</li>
<li>【发起方】收到所有【参与方】的Try结果</li>
<li>【发起方】发送Confirm/Cancel到所有参与房</li>
<li>每个【参与方】执行Confirm/Cancel</li>
<li>【发起方】收到所有【参与方】的Confirm/Cancel结果</li>
</ol>
<h2 id="异常处理">异常处理</h2>
<p>从【发起方】的角度来看出现异常要怎么处理：</p>
<ol>
<li>step 1发生异常，【发起方】可以什么都不做等待【参与方】自行Cancel，也可以直接发起Cancel请求</li>
<li>step 2、3发生异常，意味着【发起方】没有收到【参与方】的响应，这个时候因认定为失败，执行Cancel</li>
<li>step 4发生异常，【发起方】重试Confirm/Cancel</li>
<li>step 5、6发生异常，意味着【发起方】没有收到【参与方】的响应，这个时候因认定为失败，重试Confirm/Cancel</li>
</ol>
<p>从【参与方】角度来看看看出现异常怎么处理：</p>
<ol>
<li>step 1，意味着【参与方】没有收到请求，什么都不需要做</li>
<li>step 2，意味着【参与方】没有执行成功，什么都不需要做</li>
<li>step 3，意味着【发起方】没有收到结果，什么都不需要做，等待【发起方】重试即可。【参与方】要保证prepare是幂等的。</li>
<li>step 4，等待【发起方】重试，或者等待timeout后自行Cancel。</li>
<li>step 5，等待【发起方】重试即可</li>
<li>step 6，意味着【发起方】没有收到结果，什么都不需要做，等待【发起方】重试即可，【参与方】要保证Confirm/Cancel是幂等的。</li>
</ol>
<p>观察一下你就会发现TCC和2PC存在一样的问题：</p>
<ol>
<li>若【发起方】/【参与方】因崩溃遗失了信息，则会造成有的【参与方】已Confirm，有的【参与方】则被Cancel了，甚至于依然保持在预留状态。</li>
<li>若【发起方】在step 4发送Confirm，而【参与方】在Cancel（因timeout导致）。</li>
</ol>
<p>不过TCC在处理这种情况相比2PC具有一些优势，因为TCC是在服务层面的，当出现这种问题的时候可以很容易通过日志、业务数据排查出来，然后人工介入，而2PC完全是数据库底层的。</p>
<h2 id="对于acid的保证">对于ACID的保证</h2>
<p>TCC对于ACID的保证：</p>
<ul>
<li>A，正常情况下保证</li>
<li>C，在某个时间点，会出现A库和B库的数据违反一致性要求的情况，但是最终是一致的</li>
<li>I，在某个时间点，A事务能够读到B事务部分提交的结果</li>
<li>D，和本地事务一样，只要commit则数据被持久</li>
</ul>
<h2 id="实现tcc时的注意事项">实现TCC时的注意事项</h2>
<p>实现TCC需要关注以下几个方面：</p>
<ul>
<li>TCC模式在于服务层面而非数据库层面</li>
<li>TCC模式依赖于各服务正确实现Try、Confirm、Cancel和timeout处理机制</li>
<li>TCC模式最少通信次数为2n（n=服务数量）</li>
<li>不是所有业务模型都适合使用TCC，比如发邮件业务根本就不需要预留资源</li>
<li>需要良好地设计服务的日志、人工处理流程/机制，便于异常情况的处理</li>
</ul>
<h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="http://design.inf.usi.ch/sites/default/files/biblio/rest-tcc.pdf">Paper - Rest TCC</a></li>
<li><a href="https://www.infoq.com/presentations/Transactions-HTTP-REST">Presentation - Transactions for the REST of Us</a></li>
<li><a href="https://dzone.com/articles/transactions-for-the-rest-of-us">Article - Transactions for the REST of Us</a></li>
<li><a href="http://www.pautasso.info/biblio-pdf/tcc-wsrest2014.pdf">Article - Atomic Distributed Transactions: a RESTful Design</a></li>
<li><a href="https://wenku.baidu.com/view/be946bec0975f46527d3e104.html">大规模SOA系统中的分布事务处事_程立</a></li>
<li><a href="https://www.jianshu.com/p/f04cc1a696b4">深入解读微服务架构下分布式事务解决方案</a></li>
<li><a href="https://www.toutiao.com/a6340518979443032322/">分布式事务之说说TCC事务</a></li>
<li><a href="http://www.infoq.com/cn/interviews/soa-chengli">程立谈大规模SOA系统</a></li>
</ul>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1">#分布式事务</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>