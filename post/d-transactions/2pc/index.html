<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>事务 - 2PC | 颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.fb0741ac272e7c9bef84b235a2f86925ce49db17e728cfc0e73fa00ec39c73ee.css"/>

    
    
    

    
    
 
    </head>

    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>

  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheatsheet</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/troubleshooting/">排障实战记录</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

    

    

    

</div>




    <p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
    <p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>

</nav>

        <div id="content" class="content-container">
        

<h1 class="post-title">事务 - 2PC</h1>
    
    <time>March 18, 2019</time>
    
    <div>
        <p>
        <p><a href="https://github.com/chanjarster/transactions">github</a></p>
<p>在<a href="https://segmentfault.com/a/1190000013771861">上一篇文章</a>中我们介绍了本地事务，随着软件复杂度的上升，我们会需要一种可以在多个数据库之间完成事务（<a href="https://en.wikipedia.org/wiki/Distributed_transaction">分布式事务</a>）的方法，而这个方法也必须能够保证ACID。于是就出现了<a href="https://en.wikipedia.org/wiki/Two-phase_commit_protocol">2PC - Two phase commit protocol</a>。事实上2PC不仅仅适用于多数据库事务场景下使用，也适用于所有支持2PC的参与方（Participants)。</p>
<h2 id="算法介绍">算法介绍</h2>
<p>2PC的参与方有：</p>
<ol>
<li>一个作为Coordinator的节点</li>
<li>多个作为Cohort的网络节点</li>
</ol>
<p>2PC假设：</p>
<ol>
<li>所有节点都有一个稳定存储用以保存WAL（<a href="https://en.wikipedia.org/wiki/Write_ahead_logging">write-ahead log</a>）</li>
<li>没有一个节点会永远崩溃（即会最终恢复）</li>
<li>write-ahead log中存储的数据永远不会丢失，不会因崩溃而损坏</li>
<li>任意两个节点都能够互相通信</li>
</ol>
<p>第四个假设太过严格，实际上有不是所有的2PC实现都满足。第一、二个假设则大多数2PC实现都能满足。</p>
<p>PS. 如果某个节点完全损坏（比如服务器物理损毁），那么数据就直接丢失了。</p>
<p>2PC的执行步骤：</p>
<ol>
<li>Commit request phase /Voting phase。这个阶段做：</li>
<li>Coordinator发送一个查询是否同意commit的请求到所有Cohort，并且等待所有Cohort给出应答。</li>
<li>Cohort收到请求，开始执行事务，执行到就差commit为止（不commit）。</li>
<li>每个Cohort根据操作结果返回Yes或No</li>
<li>Commit phase / Completion phase。这个阶段分两种情况：</li>
<li>成功。所有Cohort应答Yes
1. Coordinator发送commit指令到所有Cohort
2. 每个Cohort执行commit，并发送ack到Coordinator
3. 当Coordinator收到每个Cohort的ack之后则事务完成</li>
<li>失败。任意Cohort应答No，或者在commit request阶段超时
1. Coordinator发送rollback指令到所有Cohort
2. 每个Cohort执行rollback，并发送ack到Coordinator
3. 当Coordinator收到每个Cohort的ack之后则事务撤销</li>
</ol>
<p>消息流（摘自wiki）：</p>
<pre><code>Coordinator                                         Cohort
                              QUERY TO COMMIT
                --------------------------------&gt;
                              VOTE YES/NO           prepare*/abort*
                &lt;-------------------------------
commit*/abort*                COMMIT/ROLLBACK
                --------------------------------&gt;
                              ACKNOWLEDGMENT        commit*/abort*
                &lt;--------------------------------  
end
</code></pre><p>2PC的通信次数是：</p>
<ol>
<li>如果实现没有要求任意两个Cohort可以通信，那么是2n（n=Cohort数量）</li>
<li>如果实现要求任意两个Cohort可以通信，那么是n^2</li>
</ol>
<h2 id="异常处理">异常处理</h2>
<p>我们把上面的流程简化以便说明异常处理：</p>
<ol>
<li>Coordinator发送query to commit</li>
<li>Cohort执行prepare</li>
<li>Cohort返回ack</li>
<li>Coordinator发送commit/rollback</li>
<li>Cohort执行commit/rollback</li>
<li>Cohort返回ack</li>
</ol>
<p>从Coordinate角度来看出现异常要怎么处理：</p>
<ol>
<li>step 1发生异常，Coordinator需要执行rollback</li>
<li>step 2、3发生异常，意味着Coordinator没有收到Cohort的响应，这个时候因认定为失败，执行rollback</li>
<li>step 4发生异常，Coordinator重试commit/rollback</li>
<li>step 5、6发生异常，意味着Coordinator没有收到Cohort的响应，这个时候因认定为失败，重试commit/rollback</li>
</ol>
<p>从Cohort角度来看看看出现异常怎么处理：</p>
<ol>
<li>step 1，意味着Cohort没有收到请求，什么都不需要做</li>
<li>step 2，意味着Cohort没有执行成功，什么都不需要做</li>
<li>step 3，意味着Coordinator没有收到结果，什么都不需要做，等待Coordinator重试即可。Cohort要保证prepare是幂等的。</li>
<li>step 4，等待Coordinator重试即可，这里有点tricky，如果Coordinator迟迟不retry，那么Cohort要自行rollback，否则就会造成资源死锁。</li>
<li>step 5，等待Coordinator重试即可</li>
<li>step 6，意味着Coordinator没有收到结果，什么都不需要做，等待Coordinator重试即可，Cohort要保证commit/rollback是幂等的。</li>
</ol>
<p>观察一下你就会发现依然存在漏洞——会出现违反一致性的情况：</p>
<ol>
<li>若Coordinator/Cohort因崩溃遗失了信息，有的Cohort已commit，有的Cohort则恢复到commit之前的状态。</li>
<li>若Coordinator在step 4发送commit，而Cohort在rollback（因timeout导致的rollback）。</li>
</ol>
<p>出现上面的情况就需要人工介入了。</p>
<p>更多2PC的异常处理推理详见这篇<a href="http://www.inf.fu-berlin.de/lehre/SS10/DBS-TA/folien/07-10-TA-2PC-2-1.pdf">slides</a>。</p>
<h2 id="缺点">缺点</h2>
<p>根据上面的算法介绍可以看出2PC是一个阻塞协议：</p>
<ul>
<li>如果两个事务针对同一个数据，那么后面的要等待前面完成，这是由于Cohort采用的是本地事务所决定的</li>
<li>Cohort在commit request phase之后会阻塞，直到进入Coordinator告之Cohort进入commit phase</li>
</ul>
<h2 id="对于acid的保证">对于ACID的保证</h2>
<p>2PC所保证的ACID和本地事务所提到的ACID不太一样——事实上对于所有分布式事务来说都不太一样：</p>
<ul>
<li>A，正常情况下保证</li>
<li>C，在某个时间点，会出现A库和B库的数据违反一致性要求的情况</li>
<li>I，在某个时间点，A事务能够读到B事务部分提交的结果</li>
<li>D，和本地事务一样，只要commit则数据被持久</li>
</ul>
<h2 id="xa">XA</h2>
<p><a href="https://en.wikipedia.org/wiki/X/Open_XA">XA</a>是一个针对<a href="https://en.wikipedia.org/wiki/Distributed_transaction">分布式事务</a>的spec，它实现了2PC协议。在XA中定义了两种参与方：Transaction Manager（TM）和Resource Manager（RM），其中TM=2PC中的Coordinator，RM=2PC中的Cohort。</p>
<p>Java规范中的JTA（Java Transaction API）定义了XA的Java接口，JTA的实现有Bitronix、Atomikos等等。</p>
<h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Two-phase_commit_protocol">wiki - 2PC</a></li>
<li><a href="https://en.wikipedia.org/wiki/X/Open_XA">wiki - XA</a></li>
<li><a href="https://en.wikipedia.org/wiki/Distributed_transaction">wiki - Distributed Transaction</a></li>
<li><a href="https://en.wikipedia.org/wiki/Write_ahead_logging">wiki - Write-ahead log</a></li>
<li><a href="https://www.quora.com/For-2-phase-commit-why-is-the-worst-case-communication-complexity-of-a-failed-transaction-O-n-2">For 2 phase commit, why is the worst-case communication complexity of a failed transaction O(n^2)?</a></li>
<li><a href="http://www.inf.fu-berlin.de/lehre/SS10/DBS-TA/folien/07-10-TA-2PC-2-1.pdf">slides - Distributed Commit Protocols</a></li>
</ul>
        </p>
    </div>
    

    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1">#分布式事务</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

    

    

    

</div>




	<div class="footer-mobile-links">
        <p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
        <p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>

    </body>
</html>