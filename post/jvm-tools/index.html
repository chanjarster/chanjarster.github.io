<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>jps jstat jstack...的工作原理 | 颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.fb0741ac272e7c9bef84b235a2f86925ce49db17e728cfc0e73fa00ec39c73ee.css"/>

    
    
    

    
    
 
    </head>

    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>

  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheatsheet</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/troubleshooting/">排障实战记录</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

    

    

    

</div>




    <p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
    <p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>

</nav>

        <div id="content" class="content-container">
        

<h1 class="post-title">jps jstat jstack...的工作原理</h1>
    
    <time>December 7, 2021</time>
    
    <div>
        <p>
        <p>本文介绍JDK 8的jps、jstat、jstack &hellip; 的工作原理。</p>
<h2 id="jvmstat-performance-counters">Jvmstat Performance Counters</h2>
<p>jps和jstat命令使用的是<a href="http://openjdk.java.net/groups/serviceability/svcjdk.html#bjvmstat">Jvmstat Performance Counters</a>。</p>
<h3 id="jps">jps</h3>
<p>先说结论：</p>
<ul>
<li>jps命令扫描的是 <code>$TMPDIR/hsperfdata_$usr</code> 下的PID文件。比如在 Linux 系统下，<code>/tmp/hsperfdata_foo/2121</code>，这体现两个信息，JVM进程的PID是2121，启动这个进程的是<code>foo</code>用户。</li>
</ul>
<p>源码脉络：</p>
<ul>
<li><a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/tools/jps/Jps.java#L58">Jps.java</a></li>
<li><a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/jvmstat/monitor/MonitoredHost.java">MonitoredHost</a> (<a href="http://openjdk.java.net/groups/serviceability/jvmstat/sun/jvmstat/monitor/MonitoredHost.html">javadoc</a>) 有三子类。</li>
<li>看local实现：<a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/jvmstat/perfdata/monitor/protocol/local/MonitoredHostProvider.java#L47">MonitoredHostProvider.java</a></li>
<li><a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/jvmstat/perfdata/monitor/protocol/local/LocalVmManager.java#L81">LocalVmManager.java</a></li>
<li><a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/jvmstat/perfdata/monitor/protocol/local/PerfDataFile.java#L57-L79">PerfDataFile.java</a> 规定了PID文件的匹配模式，<a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/jvmstat/perfdata/monitor/protocol/local/PerfDataFile.java#L294-L305">tmpDirName</a> 属性是平台相关的</li>
<li><a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/native/sun/misc/VMSupport.c#L59">VMSupport.c</a> -&gt; <a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/javavm/export/jvm.h#L1359">jvm.h</a> -&gt; <a href="https://github.com/openjdk/jdk8u-dev/blob/master/hotspot/src/share/vm/prims/jvm.cpp#L424">jvm.cpp</a> 规定了 <code>JVM_GetTemporaryDirectory</code>的返回值</li>
</ul>
<p>所以说，如果你把别的机器的<code>/tmp/hsperfdata_&lt;usr&gt;/&lt;pid&gt;</code> 复制到你本地，jps也是能够返回结果的。</p>
<p><strong>但是</strong>，前提是PID得在你的机器上存在，比如别的机器上PID是2121，那么你的机器上也必须有PID=2121的进程，无论这个进程是什么。否则jps会返回<code> -- process information unavailable</code> 这样的信息。</p>
<p>如果你这样执行jps（其实所有命令都可以这样执行），可以看到异常：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">java -cp $JAVA_HOME/lib/tools.jar -Djps.debug<span style="color:#f92672">=</span>true -Djps.printStackTrace<span style="color:#f92672">=</span>true sun.tools.jps.Jps

sun.jvmstat.monitor.MonitorException: <span style="color:#ae81ff">2121</span> not found
        at sun.jvmstat.perfdata.monitor.protocol.local.PerfDataBuffer.&lt;init&gt;<span style="color:#f92672">(</span>PerfDataBuffer.java:84<span style="color:#f92672">)</span>
        at sun.jvmstat.perfdata.monitor.protocol.local.LocalMonitoredVm.&lt;init&gt;<span style="color:#f92672">(</span>LocalMonitoredVm.java:68<span style="color:#f92672">)</span>
        at sun.jvmstat.perfdata.monitor.protocol.local.MonitoredHostProvider.getMonitoredVm<span style="color:#f92672">(</span>MonitoredHostProvider.java:77<span style="color:#f92672">)</span>
        at sun.tools.jps.Jps.main<span style="color:#f92672">(</span>Jps.java:92<span style="color:#f92672">)</span>
Caused by: java.lang.IllegalArgumentException: Process not found
        at sun.misc.Perf.attach<span style="color:#f92672">(</span>Native Method<span style="color:#f92672">)</span>
        at sun.misc.Perf.attachImpl<span style="color:#f92672">(</span>Perf.java:270<span style="color:#f92672">)</span>
        at sun.misc.Perf.attach<span style="color:#f92672">(</span>Perf.java:200<span style="color:#f92672">)</span>
        at sun.jvmstat.perfdata.monitor.protocol.local.PerfDataBuffer.&lt;init&gt;<span style="color:#f92672">(</span>PerfDataBuffer.java:64<span style="color:#f92672">)</span>
        ... <span style="color:#ae81ff">3</span> more
</code></pre></div><p>顺着这个错误分析<a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/jvmstat/perfdata/monitor/protocol/local/PerfDataBuffer.java">PerfDataBuffer.java</a>，可以发现解决的办法就是创建一个<code>/tmp/hsperfdata_&lt;pid&gt;</code>的文件。</p>
<h2 id="jstat">jstat</h2>
<p>先说结论：</p>
<ul>
<li>jstat和jps一样，读取的是 <code>$TMPDIR/hsperfdata_$usr</code> 下的PID文件，这个文件准确来说应该是 perfdata。这里面有 jstat 所想要的一切。</li>
<li>JVM在运行过程中会更新 perfdata，perfdata 采用的是mmap机制（内存映射文件），详见<a href="https://zhuanlan.zhihu.com/p/113673963">JVM源码分析之jstat工具原理完全解读</a></li>
<li>顺带一提，mmap文件内容的修改是无法通过 <a href="https://man7.org/linux/man-pages/man7/inotify.7.html">inotify(7)</a> 探测到的（见Limitations and caveats）。</li>
</ul>
<p>源码脉络：</p>
<ul>
<li><a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/tools/jstat/Jstat.java#L70">Jstat.java</a>，你可以看到两个隐藏参数<code>-list</code>和<code>-snap</code>，这不是我们的主题，关键看<a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/tools/jstat/Jstat.java#L114">logSamples()</a>方法</li>
<li>可以看到同样依赖于 <a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/jvmstat/monitor/MonitoredHost.java">MonitoredHost</a> (<a href="http://openjdk.java.net/groups/serviceability/jvmstat/sun/jvmstat/monitor/MonitoredHost.html">javadoc</a>)</li>
<li>然后得到 <a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/jvmstat/monitor/MonitoredVm.java">MonitoredVm</a>，类层级结构是 <a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/jvmstat/monitor/remote/BufferedMonitoredVm.java">BufferedMonitoredVm</a> -&gt; <a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/jvmstat/perfdata/monitor/AbstractMonitoredVm.java">AbstractMonitoredVm</a> -&gt; <a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/jvmstat/perfdata/monitor/protocol/local/LocalMonitoredVm.java">LocalMonitoredVm</a></li>
<li><a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/jvmstat/perfdata/monitor/protocol/local/LocalMonitoredVm.java#L68">LocalMonitoredVm</a> 用到了 <a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/jvmstat/perfdata/monitor/protocol/local/PerfDataBuffer.java#L61">PerfDataBuffer</a></li>
</ul>
<h2 id="dynamic-attach-mechanism">Dynamic Attach Mechanism</h2>
<p>jstack和jmap命令使用的是<a href="http://openjdk.java.net/groups/serviceability/svcjdk.html#battach">Dynamic Attach Mechanism</a>。</p>
<h3 id="jstack">jstack</h3>
<p>先说结论：</p>
<ul>
<li>和socket文件 <code>/tmp/.java_pid$pid</code> 通信</li>
<li>如果这个文件不存在，则 <code>touch /proc/$pid/cwd/.attach_pid$pid</code>文件</li>
<li>然后 <code>kill -3 $pid</code>，JVM就会创建socket文件</li>
<li>然后把<code>attach_pid$pid</code>文件可以删掉</li>
</ul>
<p>源码脉络：</p>
<ul>
<li><a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/tools/jstack/JStack.java#L160">Jstack.java</a> 使用 <a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/com/sun/tools/attach/VirtualMachine.java#L195">VirtualMachine.attach()</a></li>
<li><a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/com/sun/tools/attach/VirtualMachine.java">VirtualMachine</a>，有一个子类<a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/tools/attach/HotSpotVirtualMachine.java">HotSpotVirtualMachine</a></li>
<li><a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/com/sun/tools/attach/VirtualMachine.java#L195">VirtualMachine.attach()</a> 依赖 <a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/com/sun/tools/attach/spi/AttachProvider.java">AttachProvider</a> <a href="https://docs.oracle.com/javase/8/docs/jdk/api/attach/spec/com/sun/tools/attach/spi/AttachProvider.html">javadoc</a></li>
<li><a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/com/sun/tools/attach/spi/AttachProvider.java">AttachProvider</a>  子类 <a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/share/classes/sun/tools/attach/HotSpotAttachProvider.java">HotSpotAttachProvider</a> 子类 <a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/solaris/classes/sun/tools/attach/LinuxAttachProvider.java">LinuxAttachProvider</a></li>
<li>然后用到了 <a href="https://github.com/openjdk/jdk8u-dev/blob/master/jdk/src/solaris/classes/sun/tools/attach/LinuxVirtualMachine.java">LinuxVirtualMachine</a>，这里描述了上述逻辑。</li>
</ul>
<h3 id="jmap">jmap</h3>
<p>jmap的机制和jstack一摸一样，不做赘述。</p>
<h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="http://openjdk.java.net/groups/serviceability/svcjdk.html">Serviceability in the J2SE Repository</a></li>
</ul>
        </p>
    </div>
    

    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/jvm">#jvm</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

    

    

    

</div>




	<div class="footer-mobile-links">
        <p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
        <p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>

    </body>
</html>