<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">Netflix Hystrix笔记</h1>
    
    <time>December 3, 2019</time>
    
    <div>
        <p>
        <h2 id="语境">语境</h2>
<ul>
<li>微服务架构下，各服务之间的依赖层级关系复杂，甚至成网状</li>
<li>依赖：A调用B，称为A依赖B，也可称A有一个对B对依赖</li>
<li>Client：依赖的形式基本上是A使用B提供的client来调用B，也可以是A使用HttpClient这样的通用client来调用B</li>
</ul>
<h2 id="能做什么">能做什么？</h2>
<ul>
<li>避免因一个节点的超时，导致下游节点级联式的请求堆积，崩溃整个系统</li>
<li>避免对一个故障节点发出请求，节省网络资源</li>
<li>快速失败</li>
<li>相对快速的恢复：侦测节点，恢复通信</li>
<li>熔断时的降级</li>
<li>一些报警，监控，运行时控制的功能</li>
<li>hystrix不仅仅局限于网络通信，用在其他地方也是可以的</li>
</ul>
<h2 id="设计原则">设计原则</h2>
<ul>
<li>防止单个依赖用尽容器（如Tomcat）的所有线程</li>
<li>使用减载和快速失败，而不是排队</li>
<li>提供fallback</li>
<li>使用隔离技术（隔离舱，泳道，熔断器模式）限制单个依赖所能产生的影响</li>
<li>防止整个客户端的执行失败，而不只是网络流量</li>
<li>支持运行时修改配置</li>
</ul>
<h2 id="架构">架构</h2>
<ul>
<li>对外部系统调用的包装：HystrixCommand、HystrixObservableCommand</li>
<li>超时阈值：建议稍微低于99.5%线</li>
<li>每个依赖有一个小线程池或者信号量：线程池满了的话则直接拒绝</li>
<li>指标：成功数、失败数（客户端异常数）、超时数、线程拒绝数</li>
<li>熔断：错误数超过比例自动熔断，也可手动熔断</li>
<li>fallback（降级）：请求失败时、超时时、拒绝时、熔断时</li>
<li>近实时修改：监控指标和配置变更</li>
</ul>
<h3 id="断路器">断路器</h3>
<p>三个状态：OPEN、CLOSED、HALF-OPEN</p>
<h4 id="open">OPEN</h4>
<p>意思：断开，请求被直接短路
触发条件：</p>
<ol>
<li>当断路器流量达到基础值</li>
<li>failure比例到达设定阈值</li>
</ol>
<p>维持时间：通过参数控制，比如1秒</p>
<h4 id="closed">CLOSED</h4>
<p>意思：闭合，请求可以通过</p>
<h4 id="half-open">HALF-OPEN</h4>
<p>意思：半开，如果下一个请求成功则闭合，否则断开
触发条件：在OPEN之后过了一段时间变成半开状态，时间可设置
状态迁移：</p>
<ul>
<li>在HALF-OPEN之后第一个请求成功 -&gt; CLOSED</li>
<li>失败 -&gt; OPEN</li>
</ul>
<h3 id="隔离机制">隔离机制</h3>
<h4 id="线程池">线程池</h4>
<ul>
<li>为单个Client提供一个线程池（5-20个线程）</li>
<li>将Caller线程（如Tomcat线程）和实际工作线程解耦</li>
<li>不会阻塞Caller线程</li>
<li>开销：任务排队、调度、上下文切换</li>
</ul>
<h4 id="信号量">信号量</h4>
<ul>
<li>为单个Client提供一个Semaphore</li>
<li>caller线程和实际工作线程同一个</li>
<li>会阻塞Caller线程</li>
<li>开销：比线程池模式小多了</li>
</ul>
<h3 id="请求折叠">请求折叠</h3>
<ul>
<li>在一段时间里对同一个依赖的请求折叠起来，变成一个请求，降低对依赖的实际并发数，比如把get 100个id的动作合并成一个</li>
<li>怎么折叠要用户自己实现</li>
<li>代价：会增加一定的延迟，因为要等待一批请求折叠起来</li>
</ul>
<h3 id="请求缓存">请求缓存</h3>
<ul>
<li>把在同一请求上下文内的重复请求去重，比如在同一请求内，调用了两次getById(1)</li>
<li>在代码复杂的时候，你很难避免重复调用的代码路径存在</li>
</ul>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1">#微服务</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84">#分布式架构</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/hystrix">#hystrix</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>