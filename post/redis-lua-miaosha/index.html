<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheatsheet</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">Redis解决超卖问题的方案汇总</h1>
    
    <time>December 3, 2019</time>
    
    <div>
        <p>
        <h2 id="乐观锁">乐观锁</h2>
<p>伪代码如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#66d9ef">do</span> <span style="color:#f92672">{</span>
  oldCount <span style="color:#f92672">=</span> getCount<span style="color:#f92672">(</span>itemid<span style="color:#f92672">)</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>oldCount &lt;<span style="color:#f92672">=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> false
  <span style="color:#f92672">}</span>
  newCount <span style="color:#f92672">=</span> oldCount - 1;
<span style="color:#f92672">}</span> <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>!compareAndSwap<span style="color:#f92672">(</span>itemid, newCount, oldCount<span style="color:#f92672">))</span>
<span style="color:#66d9ef">return</span> true
</code></pre></div><p>主要是解决check-then-act的问题，因此真正更新Redis的时候要检查oldCount是否有变化。</p>
<p>很遗憾，你无法使用Redis的<a href="https://redis.io/topics/transactions#optimistic-locking-using-check-and-set">Optimistic locking using check-and-set</a>来实现<code>compareAndSet</code>，需要使用LUA脚本来：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#75715e">-- Usage: EVAL &#34;&lt;this script&gt;&#34; 1 &lt;key&gt; &lt;new-value&gt; &lt;old-value&gt;</span>
<span style="color:#66d9ef">local</span> key <span style="color:#f92672">=</span> KEYS[<span style="color:#ae81ff">1</span>]
<span style="color:#66d9ef">local</span> newValue <span style="color:#f92672">=</span> ARGV[<span style="color:#ae81ff">1</span>]
<span style="color:#66d9ef">local</span> expectedOldValue <span style="color:#f92672">=</span> ARGV[<span style="color:#ae81ff">2</span>]

<span style="color:#66d9ef">local</span> oldValue <span style="color:#f92672">=</span> redis.call(<span style="color:#e6db74">&#39;GET&#39;</span>, key)

<span style="color:#66d9ef">if</span> oldValue <span style="color:#f92672">==</span> expectedOldValue <span style="color:#66d9ef">then</span>
  redis.call(<span style="color:#e6db74">&#39;SET&#39;</span>, key, newValue)
  <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;OK&#34;</span>
<span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</code></pre></div><p>乐观锁的实现比较复杂，每次更新时都得判断数据是否发生变化，且多了几次查询动作，增加了网络开销。</p>
<h2 id="利用list">利用List</h2>
<p>有一个讨巧的思路是构建一个Redis List，一个商品有100个，那么List中就有100个元素，增加元素时<code>RPUSH</code>，删除元素时<code>LPOP</code>。当<code>LPOP</code>失败的时候，说明List空了，说明商品卖光了。</p>
<p>这个方法的优点在于只需要一次LPOP的动作，伪代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nil !<span style="color:#f92672">=</span> redis.lpop<span style="color:#f92672">(</span>itemid<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">return</span> true
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">return</span> false
</code></pre></div><p>这个方法的缺陷在于浪费了Redis的空间，事先维护List也是一项工作。</p>
<h2 id="lua脚本">LUA脚本</h2>
<p>还可以更激进一点，把整个秒杀逻辑放在LUA脚本里。因为Redis是单线程的，执行命令是串行的，在Redis里执行LUA脚本能够避免并发环境下的check-then-act错误。下面一个LUA脚本（<a href="https://blog.csdn.net/weixin_39660145/article/details/85334457#redis_lua_36">原始链接</a>）的例子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#75715e">-- Usage: EVAL &#34;&lt;this script&gt;&#34; 1 &lt;good-id&gt; &lt;activity-id&gt; &lt;user-id&gt;</span>
<span style="color:#75715e">-- KEYS [good-id]</span>
<span style="color:#75715e">-- ARGV [activity-id,user-id]</span>
<span style="color:#75715e">-- return -1:库存不足 0:重复购买 1:成功</span>

<span style="color:#66d9ef">local</span> good <span style="color:#f92672">=</span> KEYS[<span style="color:#ae81ff">1</span>]
<span style="color:#66d9ef">local</span> activity <span style="color:#f92672">=</span> ARGV[<span style="color:#ae81ff">1</span>]
<span style="color:#66d9ef">local</span> uid <span style="color:#f92672">=</span> ARGV[<span style="color:#ae81ff">2</span>]
<span style="color:#66d9ef">local</span> gooduids <span style="color:#f92672">=</span> good <span style="color:#f92672">..</span> <span style="color:#e6db74">&#39;:&#39;</span> <span style="color:#f92672">..</span> activity <span style="color:#f92672">..</span> <span style="color:#e6db74">&#39;:uids&#39;</span>

<span style="color:#66d9ef">local</span> isin <span style="color:#f92672">=</span> redis.call(<span style="color:#e6db74">&#39;SISMEMBER&#39;</span>, gooduids, uid)

<span style="color:#66d9ef">if</span> isin <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">then</span>
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">local</span> goodstock <span style="color:#f92672">=</span> good <span style="color:#f92672">..</span> <span style="color:#e6db74">&#39;:&#39;</span> <span style="color:#f92672">..</span> activity <span style="color:#f92672">..</span> <span style="color:#e6db74">&#39;:stock&#39;</span>
<span style="color:#66d9ef">local</span> stock <span style="color:#f92672">=</span> redis.call(<span style="color:#e6db74">&#39;GET&#39;</span>, goodstock)

<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> stock <span style="color:#f92672">or</span> tonumber(stock) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">then</span>
  <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">end</span>

redis.call(<span style="color:#e6db74">&#39;DECR&#39;</span>, goodstock)
redis.call(<span style="color:#e6db74">&#39;SADD&#39;</span>, gooduids, uid)
<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
<span style="color:#75715e">-- ————————————————</span>
<span style="color:#75715e">-- 版权声明：本文为CSDN博主「姚仔」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。</span>
</code></pre></div><p>LUA脚本来实现业务和用数据库存储过程来实现业务一样，具有灵活性不够、难以维护的问题。如果秒杀业务再复制一点，相信LUA脚本就会变得难以维护。如果秒杀业务需要外部系统的信息，则LUA脚本就不能胜任了。</p>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/redis">#redis</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/%E9%AB%98%E5%B9%B6%E5%8F%91">#高并发</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1">#微服务</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>