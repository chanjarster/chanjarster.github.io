<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">Java程序制作Docker Image推荐方案</h1>
    
    <time>September 20, 2018</time>
    
    <div>
        <p>
        <p>本文推荐了一种Java程序制作Docker Image的方案。</p>
<p>本文源代码是一个spring-boot应用（在 <a href="https://github.com/chanjarster/dockerfile-examples">https://github.com/chanjarster/dockerfile-examples</a> ），不过本例子适用于所有Java应用。</p>
<h2 id="要求">要求</h2>
<p>这里先给出一些Docker Image制作的要求，之后我们再看怎么做。</p>
<ol>
<li>制作过程要融合在项目构建过程中</li>
<li>使用官方Image作为基础Image</li>
<li>设定正确的时区</li>
<li>Container内的程序以非root用户启动</li>
<li>指定Web程序的端口</li>
<li>能够传递JVM参数、Java System Properties、程序自定义的参数</li>
</ol>
<p>下面具体讲一下具体怎么做到以上几点：</p>
<h3 id="制作过程要融合在项目构建过程中">制作过程要融合在项目构建过程中</h3>
<p>这里推荐使用Spotify的<a href="https://github.com/spotify/dockerfile-maven">dockerfile-maven-plugin</a>，理由是这个plugin用起来最简单且容易掌握。</p>
<p>该plugin的本质上是你写一个Dockerfile（关于Dockerfile的具体写法请参照<a href="https://docs.docker.com/engine/reference/builder/">官方文档</a>），这个plugin把一些参数传递进去来帮助你构建Docker Image。</p>
<p>因此只要你会写Dockerfile，就会使用这个plugin，它没有加入任何额外的概念。</p>
<h3 id="使用官方image作为基础image">使用官方Image作为基础Image</h3>
<p>Java的基础镜像应该在<a href="https://hub.docker.com/_/openjdk/">openjdk repository</a>里寻找，而不是在已经过时的<a href="https://hub.docker.com/_/java/">java repository</a>里找。</p>
<p>openjdk repository提供了各种各样的image tags看起来眼花缭乱，但是本质上来说就这么几个：</p>
<ul>
<li>openjdk:&lt;version&gt;</li>
<li>openjdk:&lt;version&gt;-slim</li>
<li>openjdk:&lt;version&gt;-alpine</li>
</ul>
<p>关于<code>&lt;version&gt;</code>一般来说指定大版本号就行了，比如你可以在Dockerfile这样写：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">FROM openjdk:8-alpine
</code></pre></div><p>从尺寸上来讲，alpine最小、slim稍大、默认的最大。所以应该尽可能的使用alpine版本的，如果发现程序的运行环境缺少某些东西，那么尝试用slim版本或者默认版本。就目前的经验来讲：</p>
<ul>
<li>如果需要操作系统字体库，那么就得使用slim版本或者默认版本。需要操作系统字体库的程序例如：图片验证码、PDF导出。</li>
<li>如果需要某些Linux标准的动态/静态连接库，那么在alpine版本不行的情况下，尝试slim版本或默认版本。因为alpine版本是一个及其精简的Linux，它删除了很多东西。</li>
</ul>
<h3 id="设定正确的时区">设定正确的时区</h3>
<p>几乎所有的Docker Image的时区都是UTC，我们需要给我们自己制作的Docker Image设定时区：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ENV TZ<span style="color:#f92672">=</span>Asia/Shanghai
RUN set -eux; <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime; <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    echo $TZ &gt; /etc/timezone
</code></pre></div><p>如果是alpine系列的则要安装tzdata：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ENV TZ<span style="color:#f92672">=</span>Asia/Shanghai
RUN set -eux; <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    apk add --no-cache --update tzdata; <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime; <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    echo $TZ &gt; /etc/timezone
</code></pre></div><p>关于数据库时区的相关内容可以见：</p>
<ul>
<li><a href="https://segmentfault.com/a/1190000016426048">数据库时区那些事儿 - MySQL的时区处理</a></li>
<li><a href="https://segmentfault.com/a/1190000016436947">数据库时区那些事儿 - Oracle的时区处理</a></li>
</ul>
<h3 id="container内的程序以非root用户启动">Container内的程序以非root用户启动</h3>
<p>在Docker Image内部，我们应该使用非root用户启动程序，这需要新建用户。</p>
<p>如果你用的是<code>openjdk:&lt;version&gt;-alpine</code>新建用户命令是这样的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">RUN set -eux; \
    addgroup --gid 1000 java-app; \
    adduser -S -u 1000 -g java-app -h /home/java-app/ -s /bin/sh -D java-app;
</code></pre></div><p>如果你用的是<code>openjdk:&lt;version&gt;-slim</code>或者<code>openjdk:&lt;version&gt;</code>新建用户命令是这样的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">RUN set -eux; \
    addgroup --gid 1000 java-app; \
    adduser --system --uid 1000 --gid 1000 --home=/home/java-app/ --shell=/bin/sh --disabled-password java-app;
</code></pre></div><p>然后使用<a href="https://docs.docker.com/engine/reference/builder/#use">Dockerfile USER指令</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">USER java-app

# 后面的指令就都是以java-app用户身份执行了
</code></pre></div><h3 id="指定web程序的接口">指定Web程序的接口</h3>
<p>对于联网应用而言，必须在Dockerfile中指定暴露的端口，否则该端口无法映射。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">EXPOSE 8080
</code></pre></div><h3 id="能够传递jvm参数java-system-properties程序自定义的参数">能够传递JVM参数、Java System Properties、程序自定义的参数</h3>
<p>我们需要能够在启动Docker Image的时候将一些参数传递进去：</p>
<ul>
<li>JVM参数</li>
<li>Java System Properties</li>
<li>程序启动参数</li>
</ul>
<p>这里就需要参考<a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">Dockerfile best practice</a>和<a href="https://docs.docker.com/engine/reference/builder/#entrypoint">Docker ENTRYPOINT</a>了。</p>
<h2 id="样例项目拆解">样例项目拆解</h2>
<h3 id="目录结构">目录结构</h3>
<p>所有与程序相关的东西都存放在<code>/home/java-app/</code>下：</p>
<pre><code>/home/java-app
   ├── docker-entrypoint.sh
   ├── lib
   │   └── java-app.jar
   ├── etc
   ├── logs
   └── tmp
</code></pre><ul>
<li><code>docker-entrypoint.sh</code>，启动脚本</li>
<li><code>lib</code>，存放JAR包</li>
<li><code>lib/java-app.jar</code>，程序JAR包</li>
<li><code>etc</code>，存放配置文件</li>
<li><code>logs</code>，存放日志文件</li>
<li><code>tmp</code>，存放临时文件</li>
</ul>
<h3 id="构建image的方法">构建Image的方法</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mvn clean package dockerfile:build
</code></pre></div><h3 id="运行">运行</h3>
<p>普通启动，然后访问<code>http://localhost:8080</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -p 8080:8080 chanjarster/dockerfile-java-examples-1:1.0-SNAPSHOT
</code></pre></div><p>设定JVM参数/System Properties，使用<code>JAVA_OPTS</code>环境变量：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -p 8080:8080 -e JAVA_OPTS<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;-Xmx128M -Xms128M -Dabc=xyz -Ddef=uvw&#39;</span> chanjarster/dockerfile-java-examples-1:1.0-SNAPSHOT
</code></pre></div><p>提供程序运行参数，在后面直接添加即可：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -p 8080:8080 chanjarster/dockerfile-java-examples-1:1.0-SNAPSHOT --debug
</code></pre></div><h2 id="2018-12-27更新">2018-12-27更新</h2>
<p>在<code>docker-entrypoint.sh</code>里启动Java进程时，使用<code>exec /usr/bin/java ...</code>这种形式，保证进程PID=1，这样在进程能够在<code>docker stop</code>时收到<code>SIGTERM</code>。
详见：<a href="https://docs.docker.com/engine/reference/commandline/stop/">docker stop</a></p>
<h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">Dockerfile best practice</a></li>
<li><a href="https://docs.docker.com/engine/reference/builder/#entrypoint">Docker ENTRYPOINT</a></li>
<li><a href="https://github.com/docker-library/postgres/tree/3f585c58df93e93b730c09a13e8904b96fa20c58/11">Postgres Dockerfile &amp; script</a></li>
<li><a href="https://github.com/docker-library/mysql/tree/b39f1e5e4ec82dc8039cecc91dbf34f6c9ae5fb0/8.0">MySQL Dockerfile &amp; script</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2017/11/bash-set.html">Bash set命令教程</a></li>
</ul>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/docker">#docker</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/java">#java</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>