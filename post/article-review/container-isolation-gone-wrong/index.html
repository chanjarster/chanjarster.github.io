<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">Container Isolation Gone Wrong</h1>
    
    <time>February 23, 2019</time>
    
    <div>
        <p>
        <p>原文：<a href="https://sysdig.com/blog/container-isolation-gone-wrong/">Container isolation gone wrong</a>。</p>
<p>这篇文章讲了如何分析定位容器运行性能问题的案例。</p>
<p>现象很简单：有两个容器worker和trasher，当worker独自运行的时候一切OK，当worker和trasher在同一个host上运行的时候，worker性能衰减的很厉害。</p>
<p>了解这两个容器干什么的：</p>
<ol>
<li>worker定期扫描某个目录下文件是否有变化</li>
<li>trasher则是异步处理文件</li>
</ol>
<p>重现问题：</p>
<ol>
<li>在host上只启动worker，cgroup设定为10% CPU/512M 内存，通过StatsD指标发现任务延迟耗时稳定在~250ms</li>
<li>启动trasher之后，cgroup设定为10% CPU/512M 内存，观察一个小时内的变化，延迟逐步攀升到~550ms</li>
<li>把trasher关掉之后，worker立即回到~250ms</li>
</ol>
<p>先期排查：</p>
<ol>
<li>怀疑容器的内存/cpu cgroups没有设置正确，结果发现设置正确</li>
<li>怀疑容器的内存/cpu cgroups没有生效，发现的确生效了。且两个容器的CPU/内存使用都远远没有达到cgroup设置的上限。</li>
</ol>
<p>继续观察：发现host的内存使用量在持续上升，高达~25G，如果trasher关掉，则内存使用量立马下降到正常值，数百M。<strong>这提供了一个重要信息，就是内存是被内核所使用的</strong> 。</p>
<p>尝试从系统调用（system call）来观察两个容器干了什么，用<code>sudo sysdig container.name=&lt;container-name&gt;</code>观察两个容器的系统调用：</p>
<ol>
<li>worker递归扫描某个目录下的文件</li>
<li>trasher尝试打开大量/tmp/UUID（比如，/tmp/356eb968-88e8-43bf-ba29-d4523577d48e）文件，而这些文件并不存在。</li>
</ol>
<p>看不出什么，然后找到那个系统调用导致了任务延迟从~250ms到500-600ms</p>
<ol>
<li>用<code>sysdig -r worker1.scap -r worker2.scap -c topscalls_time</code>分别查看单启worker和同时启worker和trasher的时候，worker的系统调用的累积时间。发现<code>lstat</code>的调用增长符合观察到的预期。</li>
<li>用<code>sysdig -r worker1.scap -c spectrogram evt.type=lstat</code>和<code>sysdig -r worker2.scap -c spectrogram evt.type=lstat</code>做的频谱图证实，大部分的<code>lstat</code>的调用从1.x us增长到10.x us</li>
</ol>
<p>用<code>perf</code>工具进一步观察：</p>
<ol>
<li><code>sudo perf top -p &lt;worker-pid&gt; -d 60 --stdio</code>，观察到<code>__d_lookup</code>的调用占了50%以上的时间。<code>__d_lookup</code>是内核函数，也就意味着大部分时间被内核占用了。</li>
<li><code>__d_lookup</code>是一个从缓存中查找文件metadata的函数。linux内核会将之前查找过的文件的metadata（dentry）存到一个缓存中，这个缓存就是一个hash table，这样可以加快执行速度。这个hash table是一个固定长度的数组，数组元素是链表。当hash冲突时将同hash值元素追加到链表里。</li>
</ol>
<p>观察<code>dentry cache</code>：</p>
<ol>
<li><code>$ dmesg | grep Dentry</code>，可以观察到系统启动时这个数组的大小以及尺寸：<code>Dentry cache hash table entries: 4194304 (order: 13, 33554432 bytes)</code></li>
<li>于是怀疑是否这个cache在trasher运行期间增长过大，导致内核内存使用飙升呢？<code>sudo slabtop -o</code>观察到果然占用了~26G内存，存了5百万个dentry。</li>
<li>但是host上根本没有那么多文件，是怎么产生5百万个dentry呢？</li>
</ol>
<p>了解<code>dentry</code>的创建机制：不论你查找的目录是否存在，linux内核都会为查询文件创建一个dentry。而trasher则会大量的查询不存在的文件，导致dentry数量持续上升。这解释了为何trasher启动期间内存使用率持续攀升。</p>
<blockquote>
<p>linux内核的这个机制和互联网架构中的缓存穿透一模一样，所谓缓存穿透就是查询数据库中不存在的key，导致每次查询都hit到数据库，避免方式就是对每次查询的key的结果都做缓存。看来很多事情老前辈们早就解决了。</p>
</blockquote>
<p>那么如何解释<code>__d_lookup</code>慢呢？这是因为大量的dentry产生了大量的hash冲突，导致单个hash槽里的链表变长，增加了查询时间。文章里用了一堆神奇的方法观察到了这一点：</p>
<p>观察 <code>__d_lookup</code> 函数：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo perf probe -L __d_lookup
      <span style="color:#ae81ff">0</span>  struct dentry * __d_lookup<span style="color:#f92672">(</span>struct dentry * parent, struct qstr * name<span style="color:#f92672">)</span>
      <span style="color:#ae81ff">1</span>  <span style="color:#f92672">{</span>
      <span style="color:#ae81ff">2</span>         unsigned int len <span style="color:#f92672">=</span> name-&gt;len;
      <span style="color:#ae81ff">3</span>         unsigned int hash <span style="color:#f92672">=</span> name-&gt;hash;
      <span style="color:#ae81ff">4</span>         const unsigned char *str <span style="color:#f92672">=</span> name-&gt;name;
      <span style="color:#ae81ff">5</span>         struct hlist_head *head <span style="color:#f92672">=</span> d_hash<span style="color:#f92672">(</span>parent,hash<span style="color:#f92672">)</span>;
                struct dentry *found <span style="color:#f92672">=</span> NULL;
                struct hlist_node *node;
                struct dentry *dentry;

                rcu_read_lock<span style="color:#f92672">()</span>;

     <span style="color:#ae81ff">12</span>         hlist_for_each_entry_rcu<span style="color:#f92672">(</span>dentry, node, head, d_hash<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        struct qstr *qstr;

     <span style="color:#ae81ff">15</span>                 <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dentry-&gt;d_name.hash !<span style="color:#f92672">=</span> hash<span style="color:#f92672">)</span>
                                <span style="color:#66d9ef">continue</span>;
     <span style="color:#ae81ff">17</span>                 <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dentry-&gt;d_parent !<span style="color:#f92672">=</span> parent<span style="color:#f92672">)</span>
                                Continue;
...
</code></pre></div><p>分别在函数调用处和函数第15行打入probe：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo perf probe --add __d_lookup
Added new event:
  probe:__d_lookup     <span style="color:#f92672">(</span>on __d_lookup<span style="color:#f92672">)</span>

$ sudo perf probe --add __d_lookup_loop<span style="color:#f92672">=</span>__d_lookup:15
Added new events:
  probe:__d_lookup_loop <span style="color:#f92672">(</span>on __d_lookup:15<span style="color:#f92672">)</span>
</code></pre></div><p>分别观察trasher启动时和trasher没有启动时调用次数：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo perf stat -p <span style="color:#ae81ff">18189</span> -e <span style="color:#e6db74">&#34;probe:__d_lookup&#34;</span> -e <span style="color:#e6db74">&#34;probe:__d_lookup_loop&#34;</span> -- sleep <span style="color:#ae81ff">60</span>
 Performance counter stats <span style="color:#66d9ef">for</span> process id <span style="color:#e6db74">&#39;18189&#39;</span>:

         2,763,816      probe:__d_lookup
        75,503,432      probe:__d_lookup_loop

      60.001285559 seconds time elapsed

$ sudo perf stat -p <span style="color:#ae81ff">18189</span> -e <span style="color:#e6db74">&#34;probe:__d_lookup&#34;</span> -e <span style="color:#e6db74">&#34;probe:__d_lookup_loop&#34;</span> -- sleep <span style="color:#ae81ff">60</span>
 Performance counter stats <span style="color:#66d9ef">for</span> process id <span style="color:#e6db74">&#39;18189&#39;</span>:

         3,800,247      probe:__d_lookup
         3,811,830      probe:__d_lookup_loop

      60.002976808 seconds time elapsed
</code></pre></div><p>发现trasher启动时第二个probe有~30倍于第一个probe的调用次数。</p>
<h2 id="总结">总结</h2>
<ul>
<li>kill trasher container会释放dentry，在trasher container内部kill 进程则不会。</li>
<li>看似不相关的两个容器会在内核层面产生相互影响。</li>
<li>一切以观测结果为依据，而不是胡乱猜测。</li>
<li>对container的关键指标做好测算打好baseline，在线上观测到结果于预期不符的时候就可以报警，提前知道问题。</li>
</ul>
<p>PS. linux新内核将kernel object pools和cgroup内存限制绑定在一起了，所以到时候trasher会被内核干掉。</p>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/arts">#ARTS</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/arts-r">#ARTS-R</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/linux">#linux</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/docker">#docker</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/troubleshooting">#troubleshooting</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>