<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">理解Spring Cloud Gateway Filters的执行顺序</h1>
    
    <time>April 22, 2019</time>
    
    <div>
        <p>
        <p>本文基于Spring Cloud Gateway 2.1.1.RELEASE。</p>
<p>在讲SCG的Filter的排序问题之前得先比较一下Spring Cloud Gateway在对待Filter的方面与Zuul2有着哪些不同。</p>
<h2 id="filter的scope">Filter的Scope</h2>
<ul>
<li>SCG采用的是Global Filter和Route Filter相结合的方式</li>
<li>Zuul2则都是Global Filter</li>
</ul>
<p>SCG所谓Route Filter就是像下面这样的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">spring</span>:
  <span style="color:#66d9ef">cloud</span>:
    <span style="color:#66d9ef">gateway</span>:
      <span style="color:#66d9ef">routes</span>:
        - <span style="color:#66d9ef">id</span>: tomcat_route
          <span style="color:#66d9ef">uri</span>: http://tomcat:<span style="color:#ae81ff">8080</span>
          <span style="color:#66d9ef">predicates</span>:
            - Path=/tomcat/docs
          <span style="color:#66d9ef">filters</span>:
            - StripPrefix=<span style="color:#ae81ff">1</span>
            - RemoveRequestHeader=X-Request-Foo
</code></pre></div><p>上面的<code>StripPrefix</code>和<code>RemoveRequestHeader</code>就是Route Filter，而SCG的Global Filter则是隐式的，无需显式配置，它们会在请求过来的时候被SCG调用。</p>
<p>也就是说你可以配置不同的Route，然后为每个Route配置不同的Route Filter，这一切都是在配置阶段就决定下来的。</p>
<p>而Zuul2则都是Global Filter，因此你得运行时在每个Filter内部自己决定是否要干活，除此之外，发送到Origin（被代理的服务）的url也得你自己设置，下面是一个例子（来自<a href="https://github.com/Netflix/zuul/tree/2.1/zuul-sample">Zuul2 Sample</a>）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Routes</span> <span style="color:#66d9ef">extends</span> HttpInboundSyncFilter <span style="color:#f92672">{</span>
  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">shouldFilter</span><span style="color:#f92672">(</span>HttpRequestMessage httpRequestMessage<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> HttpRequestMessage <span style="color:#a6e22e">apply</span><span style="color:#f92672">(</span>HttpRequestMessage request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Route healthchecks to the healthcheck endpoint.;
</span><span style="color:#75715e"></span>    context<span style="color:#f92672">.</span><span style="color:#a6e22e">setEndpoint</span><span style="color:#f92672">(</span>ZuulEndPointRunner<span style="color:#f92672">.</span><span style="color:#a6e22e">PROXY_ENDPOINT_FILTER_NAME</span><span style="color:#f92672">);</span>
    context<span style="color:#f92672">.</span><span style="color:#a6e22e">setRouteVIP</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;tomcat&#34;</span><span style="color:#f92672">);</span>

    <span style="color:#66d9ef">return</span> request<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="filter的角色">Filter的角色</h2>
<ul>
<li>在SCG概念中只有一种Filter（撇开Global和Route的区别），它用代码来区分Pre Filter、Post Filter。在文档中还提到了Routing Filter，其实也是Pre Filter。</li>
<li>Zuul2在代码中显示得提供了InboundFilter（负责进来的请求）、OutboundFilter（负责出去的响应）、ProxyEndpoint（负责请求到Origin，串起Inbound和Outbound）。</li>
</ul>
<p>下面是SCG的Pre Filter（裁剪自官方例子<a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.1.1.RELEASE/single/spring-cloud-gateway.html#_writing_custom_gatewayfilter_factories">12.2 Writing Custom GatewayFilter Factories</a>）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PreGatewayFilterFactory</span> <span style="color:#66d9ef">extends</span> AbstractGatewayFilterFactory <span style="color:#f92672">{</span>
	<span style="color:#a6e22e">@Override</span>
	<span style="color:#66d9ef">public</span> GatewayFilter <span style="color:#a6e22e">apply</span><span style="color:#f92672">(</span>Config config<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>exchange<span style="color:#f92672">,</span> chain<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// business logic
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> chain<span style="color:#f92672">.</span><span style="color:#a6e22e">filter</span><span style="color:#f92672">();</span>
		<span style="color:#f92672">};</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Post Filter的例子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PostGatewayFilterFactory</span> <span style="color:#66d9ef">extends</span> AbstractGatewayFilterFactory <span style="color:#f92672">{</span>
	<span style="color:#a6e22e">@Override</span>
	<span style="color:#66d9ef">public</span> GatewayFilter <span style="color:#a6e22e">apply</span><span style="color:#f92672">(</span>Config config<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>exchange<span style="color:#f92672">,</span> chain<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
			<span style="color:#66d9ef">return</span> chain<span style="color:#f92672">.</span><span style="color:#a6e22e">filter</span><span style="color:#f92672">(</span>exchange<span style="color:#f92672">).</span><span style="color:#a6e22e">then</span><span style="color:#f92672">(</span><span style="color:#75715e">/* business logic */</span><span style="color:#f92672">);</span>
		<span style="color:#f92672">};</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>在Zuul2里，你则得分别实现<code>HttpInboundSyncFilter</code>和<code>HttpOutboundSyncFilter</code>，<code>ProxyEndpoint</code>不需要你自己实现。</p>
<h2 id="scg-filter的问题">SCG Filter的问题</h2>
<p>SCG的优点很明显，它做了Zuul2不做的事情：</p>
<ol>
<li>替你决定进来的请求转发到哪个Origin。在Zuul2里这个交给你自己来实现。</li>
<li>在配置上就决定了这个Route会应用哪些Filter。在Zuul2里这个交给你自己来判断。</li>
</ol>
<p>但是随着对SCG的深入了解，发现了关于Filter的执行顺序存在一些坑，如果不了解清楚会容易出错。</p>
<h3 id="filter的排序">Filter的排序</h3>
<p>前面讲了，SCG在执行过程中Global Filter和Route Filter是一起执行的，那么它们的order是怎样的？</p>
<p>先来看看Global Filter，你可以访问<code>/actuator/gateway/globalfilters</code>（见<a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.1.1.RELEASE/single/spring-cloud-gateway.html#_global_filters_2">文档</a>）得到Global Filter的排序：</p>
<p><img src="filters-order.png" alt=""></p>
<p>那么如果你写了一个自定义 Global Filter，那么它的order是什么呢？这个要看情况：</p>
<ul>
<li>如果你的自定义Global Filter实现了<code>Ordered</code>接口或者写了<code>@Order</code>注解，那么它的order就是它自己设定的值</li>
<li>否则，它就没有order</li>
</ul>
<p>关于这点可以看<a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/v2.1.1.RELEASE/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/handler/FilteringWebHandler.java#L58-L67">FilteringWebHandler.java的源代码</a>。</p>
<p>再来看看Route Filter，这也分两种情况：</p>
<ul>
<li>如果RouteFilter实现了<code>Ordered</code>接口或者写了<code>@Order</code>注解，那么它的order就是它自己设定的值。</li>
<li>否则，它的order则是从1开始，按照Route中定义的顺序依次排序。</li>
</ul>
<p>关于这点可以看<a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/v2.1.1.RELEASE/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/route/RouteDefinitionRouteLocator.java#L183-L192">RouteDefinitionRouteLocator.java的源代码</a>。</p>
<p>最后SCG把它们两个结合起来，做一个排序，对于没有order的Filter，它的order则默认为<code>Ordered.LOWEST_PRECEDENCE</code>。关于这点可以看<a href="https://github.com/spring-cloud/spring-cloud-gateway/blob/v2.1.1.RELEASE/spring-cloud-gateway-core/src/main/java/org/springframework/cloud/gateway/handler/FilteringWebHandler.java#L75-L82">FilteringWebHandler.java的源代码</a>。</p>
<p>用一张图做总结：</p>
<p><img src="filters-order-2.png" alt=""></p>
<h3 id="filter的执行顺序">Filter的执行顺序</h3>
<p>先看SCG文档<a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.1.1.RELEASE/single/spring-cloud-gateway.html#gateway-how-it-works">3. How It Works</a>中的这张图：</p>
<p><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-gateway/master/docs/src/main/asciidoc/images/spring_cloud_gateway_diagram.png" alt=""></p>
<p>这张图大概告诉你了SCG的调用过程，可以看到经过了一堆Filters，但是并没有告诉你Filter的执行顺序。然后在SCG的<a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.1.1.RELEASE/single/spring-cloud-gateway.html#_combined_global_filter_and_gatewayfilter_ordering">6.1 Combined Global Filter and GatewayFilter Ordering</a>提到了：</p>
<blockquote>
<p>As Spring Cloud Gateway distinguishes between &ldquo;pre&rdquo; and &ldquo;post&rdquo; phases for filter logic execution (see: How It Works), the filter with the highest precedence will be the first in the &ldquo;pre&rdquo;-phase and the last in the &ldquo;post&rdquo;-phase.</p>
</blockquote>
<p>也就是说意思如果这个Filter是Pre Filter，那么执行顺序和排序顺序相同，如果这个Filter是Post Filter则执行顺序和排序顺序相反。我整理了一下SCG自带GlobalFilter的执行顺序：</p>
<p><img src="filters-execution-order.png" alt=""></p>
<p>可以看到GatewayMetricsFilter既是Pre Filter也是Post Filter。</p>
<h2 id="总结">总结</h2>
<ul>
<li>执行某个Route的时候，SCG会将Global Filter和Route Filter结合起来并排序：
<ul>
<li>没有给order的Global Filter则保持order为null去排序</li>
<li>没有给order的Route Filter的order则从1开始，根据Route中定义的顺序给值</li>
<li>排序逻辑见<a href="https://docs.spring.io/spring/docs/5.1.6.RELEASE/javadoc-api/org/springframework/core/annotation/AnnotationAwareOrderComparator.html">AnnotationAwareOrderComparator</a></li>
</ul>
</li>
<li>对于Pre Filter，执行顺序同排序顺序</li>
<li>对于Post Filter，执行顺序与排序顺序相反</li>
<li>如果你要自定义Global Filter，那么一般来说：
<ul>
<li>自定义的Global Pre Filter要在Routing Filter之前执行</li>
<li>自定义的Global Post Filter要在Routing Filter之后执行或者NettyWriteResponseFilter之后执行</li>
</ul>
</li>
<li>如果你要自定义Route Filter，那么一般来说：
<ul>
<li>自定义Route Pre Filter要在<code>ForwardPathFilter</code>和<code>RouteToRequestUrlFilter</code>之间，而且不需要实现<code>Ordered</code>接口或添加<code>@Order</code>注解</li>
<li>自定义的Route Post Filter比较少见，放在Routing Filter或者NettyWriteResponseFilter之后执行</li>
</ul>
</li>
</ul>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1">#微服务</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/java">#java</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>