<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheat sheet</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">搭建Jenkins集群流水账</h1>
    
    <time>November 23, 2018</time>
    
    <div>
        <p>
        <p>搭建Jenkins集群的流水账。</p>
<h2 id="硬件要求">硬件要求</h2>
<p>不论是master还是slave，都要安装：</p>
<ul>
<li>操作系统：Ubuntu 16.04 Server LTS</li>
<li>Docker-CE</li>
</ul>
<p>Docker安装方法：</p>
<ul>
<li>根据文档：https://yq.aliyun.com/articles/110806  安装docker-ce</li>
<li><code>curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</code></li>
<li><code>sudo usermod -aG docker $USER</code></li>
</ul>
<p>我在安装的时候碰到Jenkins无法从Update center下载metadata的问题，经发现是docker的mtu比服务器网卡mtu大的问题，解决办法如下：</p>
<ul>
<li>新建或者修改文件：<code>/etc/docker/daemon.json</code>，添加mtu的设置比如：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;mtu&#34;</span>: <span style="color:#960050;background-color:#1e0010">&lt;服务器网卡的mtu&gt;</span>,
  <span style="color:#960050;background-color:#1e0010">...</span>
}
</code></pre></div><ul>
<li>你可以配置docker registry mirror，同样修改<code>/etc/docker/daemon.json</code>：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;registry-mirrors&#34;</span>: [<span style="color:#e6db74">&#34;...&#34;</span>],
  <span style="color:#960050;background-color:#1e0010">...</span>
}
</code></pre></div><p>然后重启docker：<code>sudo systemctl restart docker</code></p>
<h2 id="部署master">部署master</h2>
<p>创建目录：<code>mkdir $HOME/jenkins-home</code></p>
<p>启动Jenkins：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo docker run <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -u root <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -d <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -p 8080:8080 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -p 50000:50000 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -v $HOME/jenkins-home:/var/jenkins_home <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -v /var/run/docker.sock:/var/run/docker.sock <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --name jenkins <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  jenkinsci/blueocean
</code></pre></div><p>创建ssh密钥对：<code>ssh-keygen</code></p>
<h2 id="初始配置jenkins">初始配置Jenkins</h2>
<ul>
<li>浏览器访问Jenkins：<code>http://&lt;jenkins-master-ip&gt;:8080/</code></li>
<li>选择安装社区推荐插件</li>
<li>设置管理员用户</li>
</ul>
<h2 id="安全配置">安全配置</h2>
<h3 id="配置ldap">配置LDAP</h3>
<p>如果要配置LDAP，那么一定要记住，配置完之后不要注销。</p>
<p>系统管理 -&gt; 全局安全设置，访问控制，选择LDAP，然后根据情况配置即可。</p>
<p>注意配置完之后一定要Test。</p>
<h3 id="配置授权策略">配置授权策略</h3>
<p>系统管理 -&gt; 全局安全设置，授权策略，项目矩阵授权策略。</p>
<p>打开浏览器隐私窗口，用一个账号登录，这个账号将替代当前使用的管理员账号。</p>
<p>下面为了方便理解，下面吧当前浏览器称为A窗口，隐私窗口浏览器称为B窗口。</p>
<p>回到A窗口，添加刚才登录的用户，如果正常添加，用户名上不会有删除线。然后在全部这一栏勾选Administer，点击应用。</p>
<p>此时A窗口的管理员账号应该就不能做任何操作了，而且再也不能登录了。</p>
<p>到B窗口，刷新一下，继续后面的管理员动作。</p>
<p>下图是推荐的配置方法：</p>
<p><img src="global-security-settings.png" alt="global-security-settings"></p>
<h2 id="添加slave节点">添加Slave节点</h2>
<p>前期准备</p>
<ul>
<li>准备Slave的机器</li>
<li>安装Docker-CE</li>
<li>安装openjdk：<code>sudo apt install -y openjdk-8-jdk</code></li>
<li>新建工作目录：<code>mkdir $HOME/jenkins-workdir</code></li>
<li>把master的pub key添加到slave上：把master的<code>$HOME/.ssh/id_rsa.pub</code>内容添加到slave的<code>$HOME/.ssh/authorized_keys</code>里。</li>
</ul>
<p>到 系统管理 &gt; 节点管理，新建节点</p>
<ul>
<li>名字：slave-1</li>
<li>并发构建数：2（cpu核数）</li>
<li>远程工作目录：<code>&lt;jenkins-workdir的绝对路径&gt;</code></li>
<li>用法：尽可能的使用这个节点</li>
<li>启动方式：Launch agent agents via SSH</li>
<li>Host：<code>&lt;slave的ip&gt;</code></li>
<li>Credentials：这个时候要创建一个平局，方法如下：
<ul>
<li>Domain，全局凭据</li>
<li>类型：SSH username with private key</li>
<li>username: <code>&lt;slave的操作系统用户名&gt;</code></li>
<li>private key: 把master <code>$HOME/.ssh/id_rsa</code> 的内容贴上去</li>
<li>Passphrase: <code>&lt;blank&gt;</code></li>
<li>ID: <code>&lt;blank&gt;</code></li>
<li>描述：For slave connection</li>
</ul>
</li>
<li>Host Key Verification Strategy：Non verifying Verification Strategy</li>
<li>保存</li>
<li>修改master节点，执行者数量设置为0，这样就能避免Job分配到master上。</li>
</ul>
<h2 id="安装其他插件">安装其他插件</h2>
<p>系统管理 -&gt; 插件管理，安装下列插件：</p>
<ul>
<li>Config File Provider</li>
<li>Pipeline Maven</li>
<li>Coding Plugin</li>
<li>Rancher Plugin</li>
<li>TestNG Results</li>
<li>SonarQube Scanner</li>
</ul>
<h2 id="配置工具">配置工具</h2>
<p>系统管理 -&gt; 全局工具配置，都选择自动安装，下面列出的是工具的名字</p>
<ul>
<li>JDK：JDK6、JDK7、JDK8，要输入oracle网站账号密码</li>
<li>Maven：Maven3</li>
<li>Docker：Docker</li>
</ul>
<h2 id="配置时区">配置时区</h2>
<p>用Docker启动Jenkins时区是GMT+0</p>
<p>见wiki：https://wiki.jenkins.io/display/JENKINS/Change+time+zone</p>
<p>系统管理 -&gt; 脚本命令行</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">System<span style="color:#f92672">.</span><span style="color:#a6e22e">setProperty</span><span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">&#39;</span>org<span style="color:#f92672">.</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">commons</span><span style="color:#f92672">.</span><span style="color:#a6e22e">jelly</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tags</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fmt</span><span style="color:#f92672">.</span><span style="color:#a6e22e">timeZone</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">,</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>Asia<span style="color:#f92672">/</span>Shanghai<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">)</span>
</code></pre></div><h2 id="清理重装方法">清理重装方法</h2>
<p>如果你配置错误搞砸了，想从头开始，那么这么做，只需要这么几步：</p>
<ul>
<li>ssh到master上：</li>
<li><code>sudo docker stop jenkins</code></li>
<li><code>sudo rm -rf $HOME/jenkins-home/*</code></li>
</ul>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/ci_cd">#CI_CD</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/jenkins">#Jenkins</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>