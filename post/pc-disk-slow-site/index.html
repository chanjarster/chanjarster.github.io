<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheatsheet</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/troubleshooting/">排障实战记录</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">PC磁盘性能地下导致访问网站很慢问题排查记录</h1>
    
    <time>July 13, 2021</time>
    
    <div>
        <p>
        <h2 id="现象">现象</h2>
<p>在清空浏览器缓存的情况下，访问 某网站 网页加载很慢，长达20～30秒。</p>
<p>下图只显示了10秒左右，但这个只是个别情况，大多数情况在20～30秒左右：</p>
<p><img src="net-normal.jpg" style="zoom:50%" /></p>
<p>据开发人员称，之前做了一些优化：</p>
<ul>
<li>调整了Tomcat的连接池和一些timeout</li>
<li>调整了Nginx的work数量和CPU affinity（这个其实多余的）</li>
</ul>
<h2 id="排查jvm">排查JVM</h2>
<p>在访问门户网站的时候，用jstack导出线程堆栈，传到 fasttread.io 上看，发现1000个tomcat http线程都闲着，并没有在工作。</p>
<p>用<code>jstat -gcutil</code>查看JVM的垃圾收集情况，访问期间并发生FCG。</p>
<p>小节：JVM工作正常。</p>
<h2 id="排查cpu">排查CPU</h2>
<p>查看Nginx服务器和Tomcat服务器的CPU，CPU利用率都很低。</p>
<p>小节：没有异常。</p>
<h2 id="用ab压测">用ab压测</h2>
<p>找了一个静态资源，用ab做压力测试（5线程，时间10秒，<code>-c 5 -t 10</code>），10秒内完成了2483个请求，最大响应时间213ms：</p>
<p><img src="ab.png" alt=""></p>
<h2 id="陷入僵局">陷入僵局</h2>
<p>总结一下目前的情况：</p>
<ul>
<li>Nginx服务器CPU没问题</li>
<li>Tomcat服务器CPU没问题</li>
<li>JVM没问题</li>
<li>用ab做压测，结果非常好，比浏览器访问快多了</li>
</ul>
<h2 id="排查网络请求">排查网络请求</h2>
<p>打开Chrome的开发者模式采集网络请求，看到整个网站的请求数量多达200+个，且大多数请求都是下载小尺寸资源。</p>
<p>和开发人员沟通后表示，同版本网站在另一个客户打开时间只需要2-3秒，且同样是在内网环境。</p>
<p>仔细查看每个请求的Timing，发现Stalled的时间非常长，有的光Stalled就有 &gt; 2秒。</p>
<p><img src="net-normal-timing.jpg" style="zoom: 50%" /></p>
<p>根据Chrome对于<strong>Stalled</strong>的<a href="https://www.chromium.org/developers/design-documents/network-stack/disk-cache#TOC-Implementation-Notes">解释</a>，有三个原因：</p>
<ul>
<li>There are higher priority requests.</li>
<li>There are already six TCP connections open for this origin, which is the limit. Applies to HTTP/1.0 and HTTP/1.1 only.</li>
<li>The browser is briefly allocating space in the disk cache</li>
</ul>
<p>分析一下这三个原因：</p>
<ul>
<li>第一个原因不成立，因为并不存在更高优先级的请求</li>
<li>第二个原因不成立，因为ab用的是5线程，chrome用6线程，ab结果比chrome好太多，应该不是这个原因</li>
<li>第三个原因牵涉到浏览器缓存落磁盘，这个应该不是瓶颈。</li>
</ul>
<p>小节：再次陷入僵局。</p>
<h2 id="奇怪的无痕模式">奇怪的无痕模式</h2>
<p>在无意中发现，Chrome无痕模式下访问速度很快，可以在2-3秒内完成。</p>
<p><img src="net-incognito.jpg" style="zoom: 50%" /></p>
<h3 id="对比stalled">对比Stalled</h3>
<p>发现下载相同的资源无痕模式下Stalled只有~100ms，比正常模式的~2s快好多，这个结果也接近ab测试的结果：</p>
<p><img src="net-incognito-timing.jpg" style="zoom: 50%" /></p>
<h3 id="对比请求">对比请求</h3>
<p>难道是无痕模式和正常模式的请求不一样，导致nginx/tomcat/程序走了不一样的逻辑？</p>
<p>对比发现，请求头一模一样。</p>
<p>同时查看nginx配置文件也没发现特别之处。</p>
<p>同时也可以排除防火墙的原因，因为请求都一模一样，防火墙不可能做出不一样的策略的。</p>
<h3 id="对比tcpdump">对比tcpdump</h3>
<p>在Nginx对做tcpdump，看看无痕模式的抓包和正常模式的抓包有何区别。</p>
<p>结果是没有发现特别之处。</p>
<h3 id="chromenet-export">chrome://net-export</h3>
<p>Chrome打开chrome://net-export ，正常模式下访问门户时抓网络事件。</p>
<p>然后使用 <a href="https://netlog-viewer.appspot.com/#import">https://netlog-viewer.appspot.com/#import</a> 打开。</p>
<p>没有发现特别的地方。</p>
<h2 id="pc的磁盘">PC的磁盘</h2>
<p>回顾根据Chrome关于<strong>Stalled</strong>的<a href="https://www.chromium.org/developers/design-documents/network-stack/disk-cache#TOC-Implementation-Notes">解释</a>，有三个原因：</p>
<ul>
<li>There are higher priority requests.</li>
<li>There are already six TCP connections open for this origin, which is the limit. Applies to HTTP/1.0 and HTTP/1.1 only.</li>
<li>The browser is briefly allocating space in the disk cache</li>
</ul>
<p>前两个原因已经排除，默非真的是因为PC的磁盘不给力？</p>
<p>在google搜索<code>The browser is briefly allocating space in the disk cache incognito</code>在Chromium的<a href="https://www.chromium.org/developers/design-documents/network-stack/disk-cache#TOC-Implementation-Notes">wiki</a>中发现无痕模式的Cache采用的是内存实现，普通模式采用的是磁盘实现：</p>
<blockquote>
<p>Chromium has two different implementations of the cache interfaces: while the main one is used to store info on a given disk, there is also a very simple implementation that doesn’t use a hard drive at all, and stores everything in memory. The in-memory implementation is used for the <em>Incognito</em> mode &hellip;</p>
</blockquote>
<h3 id="再次查看网络事件">再次查看网络事件</h3>
<p>再次查看 chrome://net-export 导出的网络事件，发现正常模式下的Disk Cache还真的是很慢，比如下面这个图片，写Disk缓存的用了3686ms：</p>
<p><img src="net-event-normal.jpg" style="zoom:50%" /></p>
<h3 id="再次用ab来测试">再次用ab来测试</h3>
<p>之前的ab之所以快怀疑是因为ab也把下载的文件写到内存而不是磁盘，但是查看ab的文档后，并不存在可以把下载结果写到磁盘的参数。</p>
<h3 id="抓无痕模式下的网络事件">抓无痕模式下的网络事件</h3>
<p>再次用 chrome://net-export 抓无痕模式下的网络事件。</p>
<p><img src="net-event-incognito.jpg" style="zoom:50%" /></p>
<h2 id="总结">总结</h2>
<p>在排除一切可能性之后，目前最大的可能是PC的磁盘不给力，导致了这个现象。</p>
<p>后续工作：找一台配置更好的PC来访问网站看看，验证一下这个结果。</p>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/troubleshooting">#troubleshooting</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>