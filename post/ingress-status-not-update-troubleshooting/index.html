<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>排查Ingress对象status字段不更新的问题 | 颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.fb0741ac272e7c9bef84b235a2f86925ce49db17e728cfc0e73fa00ec39c73ee.css"/>

    
    
    

    
    
 
    </head>

    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>

  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheatsheet</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/troubleshooting/">排障实战记录</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

    

    

    

</div>




    <p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
    <p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>

</nav>

        <div id="content" class="content-container">
        

<h1 class="post-title">排查Ingress对象status字段不更新的问题</h1>
    
    <time>May 14, 2021</time>
    
    <div>
        <p>
        <h2 id="现象">现象</h2>
<p>在rancher中发现所有的Ingress都是黄色的Initializing状态，但是访问应用没有问题。</p>
<p><img src="1.png" alt=""></p>
<h2 id="检查ingress对象">检查ingress对象</h2>
<p>查看ingress的status，会看到status.loadBalancer 字段是空的：</p>
<p><img src="2.png" alt=""></p>
<p>对比一个正常：</p>
<p><img src="3.png" alt=""></p>
<h2 id="查看nginx-ingress的日志">查看Nginx ingress的日志</h2>
<p>在三个Pod（共10个）上看到了以下日志：</p>
<p><img src="4.png" alt=""></p>
<p>怀疑受到攻击，导致nginx-ingress-controller异常。</p>
<h2 id="尝试重启ingress-controller">尝试重启Ingress controller</h2>
<p>删掉这三个Pod重启，没用。</p>
<p>重启所有ingress-controller，也没用。</p>
<h2 id="观察master服务器上etcd的日志">观察master服务器上etcd的日志</h2>
<p>在master-1上看到如下内容：</p>
<p><img src="5.png" alt=""></p>
<p>在master-2上看到如下内容：</p>
<p><img src="6.png" alt=""></p>
<p>master-3上没有这些warning。</p>
<p>因为K8S对象都保存在etcd中的，怀疑如果etcd出了问题，那么对象的状态是过时的，也会造成无法更新的问题。</p>
<p>校准服务器时间，问题依旧。</p>
<h2 id="检查ingress-controller和kube-apiserver的通信">检查Ingress Controller和kube apiserver的通信</h2>
<p>K8S的Controller模型告诉我们，都必须和Apiserver通信，那么是不是Ingress Controller和Apiserver的通信出了问题呢？</p>
<p>进入某个ingress controller容器，执行下列命令：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>cat /var/run/secrets/kubernetes.io/serviceaccount/token<span style="color:#e6db74">`</span>
curl -k https://10.43.0.1:443/api --header <span style="color:#e6db74">&#34;Authorization: Bearer </span>$TOKEN<span style="color:#e6db74">&#34;</span>
</code></pre></div><p>发现和API Server的通信是OK的。</p>
<h2 id="检查ingress-controller的service-account的权限是否足够">检查Ingress Controller的Service Account的权限是否足够</h2>
<p>因为调用Kube ApiServer需要权限，检查一下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; kubectl -n ingress-nginx get sa
NAME                           SECRETS   AGE
default                        <span style="color:#ae81ff">1</span>         440d
nginx-ingress-serviceaccount   <span style="color:#ae81ff">1</span>         440d

&gt; kubectl -n ingress-nginx get rolebinding
NAME                              AGE
clusterrolebinding-2ltlc          440d
clusterrolebinding-6sk8h          440d
clusterrolebinding-964mz          440d
clusterrolebinding-znvvl          440d
nginx-ingress-role-nisa-binding   440d

&gt; kubectl -n ingress-nginx get rolebinding nginx-ingress-role-nisa-binding
…
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: nginx-ingress-role
subjects:
- kind: ServiceAccount
  name: nginx-ingress-serviceaccount
  namespace: ingress-nginx

&gt; kubectl -n ingress-nginx get role nginx-ingress-role -o yaml
…
rules:
- apiGroups:
  - <span style="color:#e6db74">&#34;&#34;</span>
  resources:
  - configmaps
  - pods
  - secrets
  - namespaces
  verbs:
  - get
- apiGroups:
  - <span style="color:#e6db74">&#34;&#34;</span>
  resourceNames:
  - ingress-controller-leader-nginx
  resources:
  - configmaps
  verbs:
  - get
  - update
- apiGroups:
  - <span style="color:#e6db74">&#34;&#34;</span>
  resources:
  - configmaps
  verbs:
  - create
- apiGroups:
  - <span style="color:#e6db74">&#34;&#34;</span>
  resources:
  - endpoints
  verbs:
  - get
</code></pre></div><p>发现权限是足够的，而且和一个正常的集群对比，结果也是一样的。</p>
<h2 id="再次观察ingress-controller的日志">再次观察ingress controller的日志</h2>
<p>调整ingress controller的参数，<a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#disable-access-log">把access log关掉</a>，能够更清楚的看到controller的日志。</p>
<p>发现这么一条：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">I0512 03:52:31.256060 <span style="color:#ae81ff">6</span> status.go:86<span style="color:#f92672">]</span> new  leader elected: nginx-ingress-controller-qxlt8  
</code></pre></div><p>所有ingress-controller推举leader为 nginx-ingress-controller-qxlt8。</p>
<p>但是在K8S里根本就不存在名字是这个的Pod。</p>
<p>阅读<a href="https://github.com/kubernetes/ingress-nginx/blob/nginx-0.25.1/internal/ingress/controller/nginx.go#L290">源码</a>得知，只有leader才会负责更新Ingress对象的status字段。</p>
<h2 id="查找-nginx-ingress-controller-qxlt8">查找 nginx-ingress-controller-qxlt8</h2>
<p>怀疑是不是etcd里有，但是这个没有K8S查不到，于是到etcd上查询。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; docker exec -it etcd etcdctl get / --prefix --keys-only | grep ingress-controller

/registry/configmaps/ingress-nginx/ingress-controller-leader-nginx
/registry/configmaps/kube-system/rke-ingress-controller
/registry/controllerrevisions/ingress-nginx/nginx-ingress-controller-544c7854f8
/registry/controllerrevisions/ingress-nginx/nginx-ingress-controller-668ccb87b6
/registry/controllerrevisions/ingress-nginx/nginx-ingress-controller-678b59dd78
/registry/controllerrevisions/ingress-nginx/nginx-ingress-controller-6c4d466577
/registry/controllerrevisions/ingress-nginx/nginx-ingress-controller-7577d75bc9
/registry/controllerrevisions/ingress-nginx/nginx-ingress-controller-767b694845
/registry/controllerrevisions/ingress-nginx/nginx-ingress-controller-779b9c5dc8
/registry/controllerrevisions/ingress-nginx/nginx-ingress-controller-7854ff6b8d
/registry/controllerrevisions/ingress-nginx/nginx-ingress-controller-7f8fdf4c75
/registry/controllerrevisions/ingress-nginx/nginx-ingress-controller-8446bfc58
/registry/controllerrevisions/ingress-nginx/nginx-ingress-controller-9cc858b66
/registry/daemonsets/ingress-nginx/nginx-ingress-controller
/registry/jobs/kube-system/rke-ingress-controller-deploy-job
/registry/pods/ingress-nginx/nginx-ingress-controller-2f6nf
/registry/pods/ingress-nginx/nginx-ingress-controller-2zk9s
/registry/pods/ingress-nginx/nginx-ingress-controller-6lzr4
/registry/pods/ingress-nginx/nginx-ingress-controller-c9gxl
/registry/pods/ingress-nginx/nginx-ingress-controller-fj94z
/registry/pods/ingress-nginx/nginx-ingress-controller-gstz8
/registry/pods/ingress-nginx/nginx-ingress-controller-kks2w
/registry/pods/ingress-nginx/nginx-ingress-controller-ntmqm
/registry/pods/ingress-nginx/nginx-ingress-controller-qjwkw
/registry/pods/ingress-nginx/nginx-ingress-controller-rfbls
/registry/pods/ingress-nginx/nginx-ingress-controller-rt5bp
/registry/pods/ingress-nginx/nginx-ingress-controller-xjcgl
/registry/pods/kube-system/rke-ingress-controller-deploy-job-2vmwq
</code></pre></div><p>没有 nginx-ingress-controller-qxlt8 这个Pod。</p>
<p>但是注意到 configmap ingress-controller-leader-nginx。</p>
<p>打开之后看到：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">control-plane.alpha.kubernetes.io/leader</span>: <span style="color:#e6db74">&#39;{&#34;holderIdentity&#34;:&#34;nginx-ingress-controller-qxlt8&#34;,&#34;leaseDurationSeconds&#34;:30,&#34;acquireTime&#34;:&#34;2021-05-10T13:38:53Z&#34;,&#34;renewTime&#34;:&#34;2021-05-12T06:28:50Z&#34;,&#34;leaderTransitions&#34;:11}&#39;</span>
  <span style="color:#f92672">creationTimestamp</span>: <span style="color:#e6db74">&#34;2020-02-26T10:37:12Z&#34;</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-controller-leader-nginx</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
  <span style="color:#f92672">resourceVersion</span>: <span style="color:#e6db74">&#34;230445553&#34;</span>
  <span style="color:#f92672">selfLink</span>: <span style="color:#ae81ff">/api/v1/namespaces/ingress-nginx/configmaps/ingress-controller-leader-nginx</span>
  <span style="color:#f92672">uid</span>: <span style="color:#ae81ff">14a0deec-eab4-44d1-aff1-36979b52a1e1</span>
</code></pre></div><p>这个configmap是ingress-controller维护的，目前的值显然是错了。</p>
<h2 id="再次研究ingress-controller的leader推举机制">再次研究ingress-controller的leader推举机制</h2>
<p>查了代码之后发现，ingress-controller其实并不是想象中的分布式共识协议推举leader，而是最简单的抢座位的方式来定leader。</p>
<p>只要有一个controller在其他controller之前占有锁（就是前面提到的configmap），并且在lease之前（30秒）刷新这个锁，那它就是leader。</p>
<p>而且只有leader才会负责更新Ingress对象的status字段。</p>
<h2 id="手动修改configmap">手动修改configmap</h2>
<p>手动修改configmap，把leader指向一个存在的Pod。</p>
<p>所有Ingress上的status字段状态都更新了。</p>
<h2 id="排查游离在k8s集群之外的节点">排查游离在K8S集群之外的节点</h2>
<p>现在可以推断存在游离在K8S集群之外，但是可以和K8S通信的服务器，后来果然在一台不在集群范围内的机器上找到了：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker ps -a|grep ingress
...
f4c861555842        a80ffa0b898e                         <span style="color:#e6db74">&#34;/usr/bin/dumb-init â€¦&#34;</span>   <span style="color:#ae81ff">5</span> months ago        Up <span style="color:#ae81ff">5</span> months                                     k8s_nginx-ingress-controller_nginx-ingress-controller-qxlt8_ingress-nginx_40487677-32c0-4936-bd1a-3e3cb99fbfa1_0
...
</code></pre></div><p>印证了之前的推断。</p>
<p>把这台服务器上的kubelet、kube-proxy和ingress-controller容器停掉。</p>
<h2 id="总结">总结</h2>
<p>本次排查发现三个问题：</p>
<ol>
<li>
<p>Ingress对象的status字段不更新的问题。</p>
</li>
<li>
<p>问题1产生的原因可能是，存在游离在K8S集群之外，但是可以和K8S通信的服务器。</p>
</li>
<li>
<p>集群的nginx接入点疑似收到攻击。</p>
</li>
</ol>
        </p>
    </div>
    

    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/k8s">#k8s</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/ingress">#ingress</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/troubleshooting">#troubleshooting</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

    

    

    

</div>




	<div class="footer-mobile-links">
        <p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
        <p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>

    </body>
</html>