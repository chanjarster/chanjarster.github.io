<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheat sheet</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">JVM执行方法调用（一）- 重载与重写</h1>
    
    <time>February 8, 2019</time>
    
    <div>
        <p>
        <p>回顾Java语言中的重载与重写，并且看看JVM是怎么处理它们的。</p>
<h2 id="重载overload">重载Overload</h2>
<p>定义：</p>
<ul>
<li>在同一个类中有多个方法，它们的名字相同，但是参数类型不同。</li>
<li>或者，父子类中，子类有一个方法与父类非私有方法名字相同，但是参数类型不同。那么子类的这个方法对父类方法构成重载。</li>
</ul>
<p>JVM是怎么处理重载的？其实是编译阶段编译器就已经决定好调用哪一个重载方法。看下面代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Overload</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>Object obj<span style="color:#f92672">,</span> Object<span style="color:#f92672">...</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#f92672">}</span>
  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>String s<span style="color:#f92672">,</span> Object obj<span style="color:#f92672">,</span> Object<span style="color:#f92672">...</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">test1</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 调用第二个 invoke 方法
</span><span style="color:#75715e"></span>    invoke<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> 1<span style="color:#f92672">);</span>    
  <span style="color:#f92672">}</span>
  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">test2</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 调用第二个 invoke 方法
</span><span style="color:#75715e"></span>    invoke<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> 1<span style="color:#f92672">,</span> 2<span style="color:#f92672">);</span> 
  <span style="color:#f92672">}</span>
  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">test3</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 只有手动绕开可变长参数的语法糖，才能调用第一个invoke方法
</span><span style="color:#75715e"></span>    invoke<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]{</span>1<span style="color:#f92672">});</span> 
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>上面的注释告诉了我们结果，那么怎么才能证明上面的注释呢？我们利用<code>javap</code>观察字节码可以知道。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ javac Overload.java
$ javap -c Overload.java

Compiled from <span style="color:#e6db74">&#34;Overload.java&#34;</span>
class Overload <span style="color:#f92672">{</span>
  ...
  void invoke<span style="color:#f92672">(</span>java.lang.Object, java.lang.Object...<span style="color:#f92672">)</span>;
    Code:
       0: <span style="color:#66d9ef">return</span>
  void invoke<span style="color:#f92672">(</span>java.lang.String, java.lang.Object, java.lang.Object...<span style="color:#f92672">)</span>;
    Code:
       0: <span style="color:#66d9ef">return</span>
  void test1<span style="color:#f92672">()</span>;
    Code:
      ...
      10: invokevirtual <span style="color:#75715e">#4  // Method invoke:(Ljava/lang/String;Ljava/lang/Object;[Ljava/lang/Object;)V</span>
      13: <span style="color:#66d9ef">return</span>
  void test2<span style="color:#f92672">()</span>;
    Code:
      ...
      17: invokevirtual <span style="color:#75715e">#4  // Method invoke:(Ljava/lang/String;Ljava/lang/Object;[Ljava/lang/Object;)V</span>
      20: <span style="color:#66d9ef">return</span>
  void test3<span style="color:#f92672">()</span>;
    Code:
      ...
      13: invokevirtual <span style="color:#75715e">#5  // Method invoke:(Ljava/lang/Object;[Ljava/lang/Object;)V</span>
      16: <span style="color:#66d9ef">return</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>这里面有很多JVM指令，你暂且不用关心，我们看<code>test1</code>、<code>test2</code>、<code>test3</code>方法调用的是哪个方法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">  void test1();
    Code:
      ...
      10: invokevirtual #4  // Method invoke:(Ljava/lang/String;Ljava/lang/Object;[Ljava/lang/Object;)V
      13: return
</code></pre></div><p><code>invoke</code>是方法名，<code>(Ljava/lang/String;Ljava/lang/Object;[Ljava/lang/Object;)V</code>则是方法描述符。这里翻译过来就是<code>void invoke(String, Object, Object[])</code>，Java的可变长参数实际上就是数组，所以等同于<code>void invoke(String, Object, Object...)</code>。同理，<code>test2</code>调用的是<code>void invoke(String, Object, Object...)</code>，<code>test3</code>调用的是<code>void invoke(Object, Object...)</code>。关于方法描述符的详参<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.3.2">JVM Spec - 4.3.2. Field Descriptors</a>和<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.3.3">JVM Spec - 4.3.3. Method Descriptors</a>。</p>
<p>所以重载方法的选择是在编译过程中就已经决定的，下面是编译器的匹配步骤：</p>
<ol>
<li>不允许自动拆装箱，不允许可变长参数，尝试匹配</li>
<li>如果没有匹配到，则允许自动拆装箱，不允许可变长参数，尝试匹配</li>
<li>如果没有匹配到，则允许自动拆装箱，允许可变长参数，尝试匹配</li>
</ol>
<p><strong>注意：编译器是根据实参类型来匹配，实参类型和实际类型不是一个概念</strong></p>
<p>如果在一个步骤里匹配到了多个方法，则根据形参类型来找最贴切的。在上面的例子中第一个<code>invoke</code>的参数是<code>Object, Object...</code>，第二个<code>invoke</code>的参数是<code>String, Object, Object...</code>，两个方法的第一个参数<code>String</code>是<code>Object</code>的子类，因此更为贴切，所以<code>invoke(null, 1, 2)</code>会匹配到第二个<code>invoke</code>方法上。</p>
<h2 id="重写override">重写Override</h2>
<p>Java语言中的定义：</p>
<ul>
<li>子类方法有一个方法与父类方法的名字相同且参数类型相同。</li>
<li>父类方法的返回值可以替换掉子类方法的返回值。也就是说父类方法的返回值类型：
<ul>
<li>要么和子类方法返回值类型一样。</li>
<li>要么是子类方法返回值类型的父类。</li>
</ul>
</li>
<li>两者都是非私有、非静态方法。</li>
</ul>
<p>（更多详细信息可参考<a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-8.html#jls-8.4.8">Java Language Spec - 8.4.8. Inheritance, Overriding, and Hiding</a>，这里除了有更精确详细的重写的定义，同时包含了范型方法的重写定义。）</p>
<p>但是JVM中对于重写的定义则有点不同：</p>
<ul>
<li>子类方法的名字与<strong>方法描述符</strong>与父类方法相同。</li>
<li>两者都是非私有、非静态方法。</li>
</ul>
<p>（更多详细信息可参考<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-5.html#jvms-5.4.5">JVM Spec - 5.4.5. Overriding</a>）</p>
<p>注意上面提到的方法描述符，前面讲过方法描述符包含了参数类型及返回值，JVM要求这两个必须完全相同才可以，但是Java语言说的是参数类型相同但是返回值类型可以不同。Java编译器通过创建Bridge Method来解决这个问题，看下面代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">A</span> <span style="color:#f92672">{</span>
  Object <span style="color:#a6e22e">f</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">C</span> <span style="color:#66d9ef">extends</span> A <span style="color:#f92672">{</span>
  Integer <span style="color:#a6e22e">f</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>然后用<code>javap</code>查看编译结果：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ javac Override.java
$ javap -v C.class
class C extends A
...
<span style="color:#f92672">{</span>
  java.lang.Integer f<span style="color:#f92672">()</span>;
    descriptor: <span style="color:#f92672">()</span>Ljava/lang/Integer;
    flags:
    Code:
      stack<span style="color:#f92672">=</span>1, locals<span style="color:#f92672">=</span>1, args_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
         0: aconst_null
         1: areturn
  ...
  java.lang.Object f<span style="color:#f92672">()</span>;
    descriptor: <span style="color:#f92672">()</span>Ljava/lang/Object;
    flags: ACC_BRIDGE, ACC_SYNTHETIC
    Code:
      stack<span style="color:#f92672">=</span>1, locals<span style="color:#f92672">=</span>1, args_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
         0: aload_0
         1: invokevirtual <span style="color:#75715e">#2                  // Method f:()Ljava/lang/Integer;</span>
         4: areturn
      LineNumberTable:
        line 7: <span style="color:#ae81ff">0</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以看到编译器替我们创建了一个<code>Object f()</code>的Bridge Method，它调用的是<code>Integer f()</code>，这样就构成了JVM所定义的重写。</p>
<h2 id="思维导图">思维导图</h2>
<p><img src="../overload-override.png" alt=""></p>
<h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="https://time.geekbang.org/column/article/11539">极客时间 - 深入拆解 Java 虚拟机 - 04 | JVM是如何执行方法调用的？（上）</a></li>
<li><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.3.2">JVM Spec - 4.3.2. Field Descriptors</a></li>
<li><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.3.3">JVM Spec - 4.3.3. Method Descriptors</a></li>
<li><a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-8.html#jls-8.4.8">Java Language Spec - 8.4.8. Inheritance, Overriding, and Hiding</a></li>
<li><a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-8.html#jls-8.4.9">Java Language Spec - 8.4.9. Overloading</a></li>
<li><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-5.html#jvms-5.4.5">JVM Spec - 5.4.5. Overriding</a></li>
<li><a href="https://docs.oracle.com/javase/tutorial/java/generics/bridgeMethods.html">Effects of Type Erasure and Bridge Methods</a></li>
</ul>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/jvm">#JVM</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/arts">#ARTS</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/arts-t">#ARTS-T</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>