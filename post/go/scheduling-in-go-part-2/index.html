<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">Scheduling In Go : Part II - Go Scheduler 阅读笔记</h1>
    
    <time>March 30, 2020</time>
    
    <div>
        <p>
        <p>原文：<a href="https://www.ardanlabs.com/blog/2018/08/scheduling-in-go-part2.html">Scheduling In Go : Part II - Go Scheduler</a></p>
<h2 id="几个数字">几个数字</h2>
<table>
<thead>
<tr>
<th>operation</th>
<th>cost</th>
</tr>
</thead>
<tbody>
<tr>
<td>1纳秒</td>
<td>可以执行12条指令</td>
</tr>
<tr>
<td>OS上下文切换</td>
<td>~1000到~1500 nanosecond，相当于~12k到~18k条指令。</td>
</tr>
<tr>
<td>Go程上下文切换</td>
<td>~200 nanoseconds，相当于~2.4k instructions条指令。</td>
</tr>
<tr>
<td>访问主内存</td>
<td>~100到~300 clock cycles</td>
</tr>
<tr>
<td>访问CPU cache</td>
<td>~3到~40 clock cycles（根据不同的cache类型）</td>
</tr>
</tbody>
</table>
<h2 id="逻辑组件">逻辑组件</h2>
<ul>
<li>
<p>P：Logical Processor，你有多少个虚拟core就有多少个P。之所以说虚拟core是因为如果处理器支持支持一个core有多个硬件线程（Hyper-Threading，超线程），那么每个硬件线程就算作一个虚拟core。<code>runtime.NumCPU()</code>能够得到虚拟core的数量。</p>
</li>
<li>
<p>M：操作系统线程。这个线程依然由操作系统调度。每个P被分配一个M。</p>
</li>
<li>
<p>G：Go程。Go程实际上是协程（<a href="https://en.wikipedia.org/wiki/Coroutine">Coroutine</a>）。和操作系统线程有点像，只是操作系统线程上下文切换在core上，而Go程上下文切换在M上。Go程的上下文切换发生在用户空间，开销更低。</p>
</li>
<li>
<p>运行队列（队列中的G都是runnable的）：</p>
<ul>
<li>LRQ（Local Run Queue）。每个P会给一个LRQ，P负责把LRQ中的G上下文切换到M上。</li>
<li>GRQ（Global Run Queue），GRQ放还未分配到P的G。</li>
</ul>
</li>
</ul>
<p>这是一张全景图：</p>
<figure>
    <img src="94_figure2.png" width="100%"/> 
</figure>

<h2 id="协作式调度器">协作式调度器</h2>
<p>和操作系统的抢占式调度器不同，Go采用的是协作式调度器。Go调度器是Go运行时的一部分，而Go运行时在内置在你的程序里。所以Go调度器运行在用户空间。</p>
<p>Go调度器运行在用户空间，那么就需要定义明确的发生在safepoint的用户空间事件来做调度决策。不过程序员不需要太多关心这个，同时也无法控制调度行为，所以Go调度器虽然是协作式的但看起来像是抢占式的。</p>
<h2 id="go程状态">Go程状态</h2>
<ul>
<li>Waiting：Go程停止了，且在等待什么事情发生。比如等待操作系统（syscall）、同步调用（atomic和mutex操作）</li>
<li>Runnable：Go程想要M的时间来执行指令。越多的Go程想要时间，就以为着等待越长的时间，每个Go程能分到的时间就越少。</li>
<li>Executing：Go程正在M上执行指令。</li>
</ul>
<h2 id="上下文切换">上下文切换</h2>
<p>Go调度程序需要定义明确的用户空间事件，这些事件发生在代码中的安全点，以便进行上下文切换。安全点体现在函数调用中。所以函数调用很重要。在Go 1.11之前，如果程序在跑一个很长的循环且循环里没有函数调用，那么就会导致调度器和GC被推迟。</p>
<p>4类事件允许调度器做调度决策，注意调度不一定会发生，而是给了调度器一个机会而已：</p>
<ul>
<li>使用<code>go</code></li>
<li>垃圾收集</li>
<li>系统调用</li>
<li>同步和编排（Synchronization and Orchestration）</li>
</ul>
<p><strong>使用<code>go</code></strong></p>
<p><code>go</code>创建了一个新的Go程，自然调度器有机会做一个调度决策。</p>
<p><strong>垃圾收集</strong></p>
<p>垃圾收集跑在自己的Go程里，需要征用M来运行，因此调度器也需要做决策</p>
<p><strong>系统调用</strong></p>
<p>系统调用会导致Go程阻塞M。调度器有些时候会把这个G从M换下（上下文切换），然后把新的G换上M。也有可能创建一个新的M，用来执行P的LRQ中的G。</p>
<p><strong>同步和编排</strong></p>
<p>如果atomic、mutex、channel操作阻塞了一个G，调度器会把一个新的G去运行，等到它又能运行了（从阻塞中解除），那么再把它放到队列中，然后最终跑在到M上。</p>
<h2 id="异步系统调用">异步系统调用</h2>
<p>比如MacOS中的kqueue、Linux中的epoll、Windows的iocp都是异步网络库。G做这些异步系统调用并不会阻塞M，那么就意味着M可以用来执行LRQ中的其他M。下面是图解：</p>
<p>G1准备做网络调用：</p>
<figure>
    <img src="94_figure3.png" width="100%"/> 
</figure>

<p>G1移到了Net Poller，然后M可以跑G2</p>
<figure>
    <img src="94_figure4.png" width="100%"/> 
</figure>

<p>G1就绪了，就回到LRQ中，等待被调度，整个过程不需要新的M：</p>
<figure>
    <img src="94_figure5.png" width="100%"/> 
</figure>

<h2 id="同步系统调用">同步系统调用</h2>
<p>文件IO不是异步的，所以G会把M给阻塞，那么Go调度器会这么做：</p>
<p>G1调用了阻塞系统调用：</p>
<figure>
    <img src="94_figure6.png" width="100%"/> 
</figure>

<p>M1连带G1从P脱离（此时M1因为阻塞被操作系统上下文切换下去了），创建新的M2给P，把G2调度到M2上：</p>
<figure>
    <img src="94_figure7.png" width="100%"/> 
</figure>

<p>而后G1从阻塞中恢复，追加到LRQ中等待下次调度，M1则保留下来等待以后使用：</p>
<figure>
    <img src="94_figure8.png" width="100%"/> 
</figure>

<h2 id="work-stealing">Work Stealing</h2>
<p>虽然名字叫做工作偷窃，但实际上是好事。简单来说就是当P1没有G时，把P2的LRQ中的G“偷”过来执行，借此来提高M的利用率。</p>
<p>看下图中P1和P2都有3个G等待调度，GRQ中有一个G</p>
<figure>
    <img src="94_figure9.png" width="100%"/> 
</figure>

<p>这个时候P1先把自己的G都处理完了：</p>
<figure>
    <img src="94_figure10.png" width="100%"/> 
</figure>

<p>P1会“偷”P2 LRQ中一半的G，偷窃算法如下，简单来说就是先偷P2的G，如果没有再从GRQ中取：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">schedule</span>() {
    <span style="color:#75715e">// only 1/61 of the time, check the global runnable queue for a G.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// if not found, check the local queue.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// if not found,
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//     try to steal from other Ps.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//     if not, check the global runnable queue.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//     if not found, poll network.
</span><span style="color:#75715e"></span>}
</code></pre></div><figure>
    <img src="94_figure11.png" width="100%"/> 
</figure>

<p>当P2把G都做完了，然后P1没有G在LRQ中时：</p>
<figure>
    <img src="94_figure12.png" width="100%"/> 
</figure>

<p>根据前面讲的算法，P2会拿GRQ中的G来运行：</p>
<figure>
    <img src="94_figure13.png" width="100%"/> 
</figure>

<h2 id="实际的例子">实际的例子</h2>
<p>下面拿一个实际的例子来告诉你Go调度器是如何比你直接用OS线程做更多工作的。</p>
<h3 id="协作式os线程程序">协作式OS线程程序</h3>
<p>有两个OS线程，T1和T2，它们之间的交互式这样的：</p>
<ul>
<li>T2等待消息，T1发送消息，T1等待消息</li>
<li>T2接收消息，T2发送消息，T2等待消息</li>
<li>T1接收消息。。。</li>
<li>。。。</li>
</ul>
<p>T1一开始在C1上，T2处于等待状态：</p>
<figure>
    <img src="94_figure14.png" width="100%"/> 
</figure>

<p>T1发送消息给T2，进入等待，从C1脱离；T2收到消息后调度到C2上：</p>
<figure>
    <img src="94_figure15.png" width="100%"/> 
</figure>

<p>T2发送消息给T1，进入等待，从C2脱离；T1收到消息后调度到C3上：</p>
<figure>
    <img src="94_figure16.png" width="100%"/> 
</figure>

<p>所以你可以看到T1和T2频繁发生OS上下文切换，而这个代价是很高的（见文头表格）。同时每次切换到不同core上，导致cache miss，所以还存在访问主内存的开销。</p>
<h3 id="协作式go程程序">协作式Go程程序</h3>
<p>下面来看看Go调度器怎么做的：</p>
<p>G1一开始在M1上，而M1和C1绑定，G2处于等待状态：</p>
<figure>
    <img src="94_figure17.png" width="100%"/> 
</figure>

<p>G1发消息给G2，进入等待，从M1脱离；G2收到消息被调度到M1：</p>
<figure>
    <img src="94_figure18.png" width="100%"/> 
</figure>

<p>G2发消息给G1，进入等待，从M1脱离；G1收到消息被调度到M1：</p>
<figure>
    <img src="94_figure19.png" width="100%"/> 
</figure>

<p>所以Go程调度的优势：</p>
<ul>
<li>OS线程始终保持运行，没有进入waiting</li>
<li>Go程上下文切换不是发生在OS层面，代价相对低， ~200 nanoseconds 或 ~2.4k instructions。</li>
<li>始终都是在同一个core上，优化了cache miss的问题，这个对于<a href="http://frankdenneman.nl/2016/07/07/numa-deep-dive-part-1-uma-numa">NUMA架构</a>特别友好。</li>
</ul>
        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/go">#go</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/kernel">#kernel</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/thread">#thread</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/scheduling">#scheduling</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/arts">#arts</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/arts-r">#arts-r</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>