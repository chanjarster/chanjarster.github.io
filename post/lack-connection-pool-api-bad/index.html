<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>缺少数据库连接池导致的API调用失败排查 | 颇忒脱的技术博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="https://chanjarster.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://chanjarster.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://chanjarster.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://chanjarster.github.io/manifest.json">
    <link rel="mask-icon" href="https://chanjarster.github.io/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://chanjarster.github.io/css/main.min.fb0741ac272e7c9bef84b235a2f86925ce49db17e728cfc0e73fa00ec39c73ee.css"/>

    
    
    

    
    
 
    </head>

    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="https://chanjarster.github.io/">颇忒脱的技术博客</a>
    </div>  
</header>

  <div class="nav-menu">
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/">Home</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/%E6%94%B6%E8%97%8F%E5%A4%B9/">Bookmarks</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/jvm/index-page">JVM</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/concurrent-programming/index-page">并发编程</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/post/mysql/index-page">MySQL</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/go/">Go</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/gc/">GC</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/kernel/">Kernel</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/cheatsheet/">Cheatsheet</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/troubleshooting/">排障实战记录</a>
  
    <a class="color-link nav-link" href="https://github.com/chanjarster">Works</a>
  
    <a class="color-link nav-link" href="https://chanjarster.github.io/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://chanjarster.github.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

    

    

    

</div>




    <p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
    <p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>

</nav>

        <div id="content" class="content-container">
        

<h1 class="post-title">缺少数据库连接池导致的API调用失败排查</h1>
    
    <time>May 14, 2021</time>
    
    <div>
        <p>
        <h2 id="现象">现象</h2>
<p>在公司自己研发的网关上观察到在每天的某段时间内API调用失败量剧增，之后又缓慢恢复的情况。</p>
<p><img src="1.png" alt=""></p>
<h2 id="观察网关日志">观察网关日志</h2>
<p>查阅日志发现，在同一时间段内，得到503 service unavailable的错误：</p>
<p><img src="2.png" alt=""></p>
<p>注意到在大量503出现之前，有少量502：</p>
<p><img src="3.png" alt=""></p>
<p>收集到的对应API调用则是：</p>
<p><img src="4.png" alt=""></p>
<p>而网关的逻辑是如果对API提供方（本例中是用户API）连续调用失败超过一定次数（目前设置是50次），那么就会对API进行熔断，直接返回503。</p>
<p>可以推断出在这段时间里，用户API处于不可用状态。</p>
<h2 id="观察poa-控制台日志">观察POA 控制台日志</h2>
<p>的确能够看到和用户服务的通信错误：</p>
<p><img src="5.png" alt=""></p>
<p>且这种错误出现了600多次，集中在00:02 前后：</p>
<p><img src="6.png" alt=""></p>
<p>印证了上面的推断。</p>
<h2 id="观察用户api的日志">观察用户API的日志</h2>
<p>出现大量从数据库连接池获取连接超时的异常：</p>
<p><img src="7.png" alt=""></p>
<p>总共1293多次，时间在00:01:20 ～ 00:02:30</p>
<p><img src="8.png" alt=""></p>
<p>可以看到用户API的数据库连接池配置的小了，从日志可以看到只配置了50，可以适当加大。</p>
<p><strong>但是</strong>，用户API数据库连接获取不到的异常只会让请求响应500一类的错误，并不会造成 <code>dialing to the given TCP address timed out</code> 或者 <code>connect: no route to host</code> 的问题。需要进一步排查。</p>
<h2 id="排查-connect-no-route-to-host-的问题">排查 connect: no route to host 的问题</h2>
<p>如果你熟悉K8S，就会知道产生这个问题的可能性有两个：</p>
<ol>
<li>Pod重启了</li>
<li>ReadinessProbe探测失败，K8S断掉通网Pod的流量</li>
</ol>
<h3 id="观察用户api是否重启过">观察用户API是否重启过</h3>
<p>查看日志，并没有重启过。</p>
<h3 id="排查readinessprobe探测失败的原因">排查readinessProbe探测失败的原因</h3>
<p>目前的readinessProbe的配置如下：</p>
<p><img src="9.png" alt=""></p>
<p>一个很典型的spring boot应用的配置。</p>
<p>但是很诡异的是，在K8S中，没有记录下Pod的readinessProbe探测失败的事件。</p>
<p>于是直接到Pod所在服务器上查看kubelet的日志：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker logs --since <span style="color:#e6db74">&#39;2021-04-21T23:55:00&#39;</span> --until <span style="color:#e6db74">&#39;2021-04-22T00:20:00&#39;</span> kubelet 2&gt;&amp;<span style="color:#ae81ff">1</span> | grep user-data-service
</code></pre></div><p>得到了相应的日志：</p>
<p><img src="10.png" alt=""></p>
<p>接下来找为何会探测失败，猜测两个原因：</p>
<ol>
<li>Tomcat的Http连接用满，新连接排队等待造成。</li>
<li>Tomcat处于Full GC，整个JVM停顿导致超时</li>
</ol>
<h3 id="排查tomcat的http连接池">排查tomcat的http连接池</h3>
<p>配置的线程数是800，在最高峰链接倏才只有&lt;300，因此这个可能性排除。</p>
<p><img src="11.png" alt=""></p>
<h3 id="排查tomcat的gc情况">排查tomcat的gc情况</h3>
<p>发现内存使用情况正常，也没有触发过FullGC</p>
<p><img src="12.png" alt=""></p>
<h3 id="思考一下">思考一下</h3>
<p>tomcat的http连接池够用，内存也够用，那么为何会产生readinessProbe探测失败呢？从下面起走了弯路。</p>
<h4 id="观察内核日志">观察内核日志</h4>
<p>那么问题是否会出在内核上，跑到Pod所在服务器上查询：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">journalctl --since<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2021-04-21 23:55:00&#39;</span> --until<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2021-04-22 00:20:00&#39;</span>
</code></pre></div><p>服务器1上没有问题，服务器2（因为总共有2个Pod，分别在不同服务器上）上有些貌似可疑的日志：</p>
<p><img src="13.png" alt=""></p>
<p>关键内容是：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">slab_out_of_memory: 4225 callbacks suppressed

SLUB: Unable to allocate memory on node -1 (gfp=0x2088020)

cache: kmalloc-64(1701:d3f8dc94598f0a15cfbb6417c5117690af06c0554667b9334bfc20381e280c62), object size: 64, buffer size: 64, default order: 0, min order: 0

node 0: slabs: 399, objs: 25536, free: 0
</code></pre></div><p>这个错误的意思是内核内存不足，不足的原因可能是存在内存泄漏的情况。</p>
<p>但是服务器2有这个异常，服务器1上没有，因此大概率和readinessProbe探测失败不存在因果关系，因为只有两个Pod都探测失败的时候，才会导致本文一开始提到的问题。</p>
<h4 id="回到-actuatorhealth">回到 /actuator/health</h4>
<p>到这里走到思路，那么看看spring boot actuator的源码，这里面的逻辑到底怎样的。</p>
<p>查看<code>/actuator/health</code>的源码，发现它是Spring Boot Actuator的<code>HealthEndpoint</code>，内部使用的是 <code>CompositeHealthIndicator</code>，它是一个Health聚合器，其中包含了<code>DataSourceHealthIndicator</code>、<code>RedisHealthIndicator </code>等等。</p>
<p>它的运行逻辑是它会挨个去询问这些<code>HealthIndicator</code>，如果大家都OK，那么状态就是健康，如果有一个不OK，那么状态就不健康。</p>
<p>那么为何ReadinessProbe会timeout呢？问题就出在<code>DataSourceHealthIndicator</code>，结合前面的日志用户API存在从<strong>数据库连接池获取连接超时</strong>的异常，在系统繁忙的时候，连接池会不够用。且连接池这个超时时间为30秒，ReadinessProbe的超时时间为5秒，所以会得到timeout的结果，然后会被判定为探测失败。</p>
<h2 id="结果">结果</h2>
<p>用户API的数据库连接数太小了，导致 ReadinessProbe 探测 <code>/actuator/health</code> 时失败，使得K8S把Pod和Service脱钩，导致网关无法与用户API的建立连接。后来把连接池调整到150之后，问题解除。</p>
        </p>
    </div>
    

    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="https://chanjarster.github.io/tags/k8s">#k8s</a>
        
            <a class="tag" href="https://chanjarster.github.io/tags/troubleshooting">#troubleshooting</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="chanjarster" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

    

    

    

</div>




	<div class="footer-mobile-links">
        <p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
        <p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://chanjarster.github.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>

    </body>
</html>